!function(w){function computeStyle(element,image,selection){var scale,selector='.image[data-image-id="'+image.id+'"]>div',elementWidth=$(selector).width(),elementHeight=image.height/image.width*elementWidth,s_width=selection.x1-selection.x0,s_height=selection.y1-selection.y0,tmp_selection=selection;s_width&&s_height||(s_width=elementWidth,s_height=elementHeight,tmp_selection={x0:0,y0:0,x1:s_width,y1:s_height});var imageUrl=w.BC_ADMIN_URL+"/"+image.id+"/original/1200.jpg";scale=elementWidth/s_width;var rules={"background-image":"url("+imageUrl+")","background-size":scaleNumber(image.width,scale)+"px","background-position":"-"+scaleNumber(tmp_selection.x0,scale)+"px -"+scaleNumber(tmp_selection.y0,scale)+"px","background-repeat":"no-repeat"};createStyle(selector,rules,"image-css-"+image.id)}function createStyle(selector,rules,classname){var styleNode=document.createElement("style");styleNode.type="text/css",styleNode.className=classname;var css="",temp=""+selector+"{";for(var rule in rules)temp+=rule+":"+rules[rule]+";";temp+="}",css+=temp,styleNode.styleSheet?styleNode.styleSheet.cssText=css:styleNode.appendChild(document.createTextNode(css)),$(document).find("head").append(styleNode)}function scaleNumber(num,by_scale){return Math.floor(num*by_scale)}function computeAspectRatio(_w,_h){if(0!==_w&&0!==_h){var aspectRatio=Math.ceil(_w/_h*10);switch(aspectRatio){case 30:case 31:crop="3x1";break;case 20:crop="2x1";break;case 14:crop="4x3";break;case 18:crop="16x9";break;case 8:crop="3x4";break;case 10:crop="1x1";break;default:crop="original"}return crop}return"16x9"}w.picturefill=function(element){var ps;element&&"image"===element.getAttribute("data-type")?ps=[element]:("undefined"==typeof element&&(element=w.document),ps=element.getElementsByTagName("div"));for(var i=0,il=ps.length;il>i;i++){var el=ps[i];if("image"===el.getAttribute("data-type")){var div=el.getElementsByTagName("div")[0];if(null!==el.getAttribute("data-image-id")){var id=el.getAttribute("data-image-id"),crop=el.getAttribute("data-crop"),_w=div.offsetWidth,_h=div.offsetHeight;crop&&""!==crop&&"auto"!==crop||(crop=computeAspectRatio(_w,_h)),el.getAttribute("data-format")?format=el.getAttribute("data-format"):format="jpg";var element=div;id&&($(".image-css-"+id).remove(),$.ajax({url:w.BC_ADMIN_URL+"/api/"+id,headers:{"X-Betty-Api-Key":w.BC_API_KEY,"Content-Type":void 0},success:$.proxy(function(res){var imageData=res;if("original"===this.crop){createStyle('.image[data-image-id="'+this.id+'"]>div',{"padding-bottom":res.height/res.width*100+"%"},"image-css-"+this.id);var cropDetails={x0:0,x1:res.width,y0:0,y1:res.height}}else var cropDetails=imageData.selections[this.crop];computeStyle(this.element,imageData,cropDetails)},{element:element,id:id,crop:crop}),error:$.proxy(function(){"original"===this.crop&&createStyle('.image[data-image-id="'+this.id+'"]>div',{"padding-bottom":"56.25%","background-color":"rgba(200, 0,0, .5)"},"image-css-"+this.id)},{id:id,crop:crop})}))}}}}}(this),angular.module("lodash",[]).constant("_",window._),angular.module("URLify",[]).constant("URLify",window.URLify),angular.module("jquery",[]).constant("$",window.$),angular.module("moment",[]).constant("moment",window.moment),angular.module("PNotify",[]).constant("PNotify",window.PNotify),angular.module("keypress",[]).constant("keypress",window.keypress),angular.module("Raven",[]).constant("Raven",window.Raven),angular.module("OnionEditor",[]).constant("OnionEditor",window.OnionEditor),angular.module("bulbsCmsApp",["bulbs.cms.site.config","bulbs.cms.superFeatures","bulbs.cms.currentUser","bulbs.cms.dateTimeModal","bulbs.cms.dateTimeFilter","bulbs.cms.editor","bulbs.cms.imageCropModal","bulbs.cms.liveBlog","bulbs.cms.sendToEditorModal","bulbs.cms.staticImage","ngCookies","ngResource","ngRoute","ui.bootstrap","ui.bootstrap.datetimepicker","restangular","BettyCropper","jquery","lodash","URLify","moment","PNotify","keypress","Raven","firebase","ipCookie","bulbs.api","contentServices","cms.tunic","bettyEditable","bugReporter","campaigns","evergreenField","hideFromRssField","filterWidget","filterListWidget","notifications","polls","promotedContent","statusFilter","templateTypeField","specialCoverage","sections","reports"]).config(function($locationProvider,$routeProvider,$sceProvider){$locationProvider.html5Mode(!0),$routeProvider.when("/cms/app/list/",{templateUrl:"/views/contentlist.html",controller:"ContentlistCtrl",reloadOnSearch:!1}).when("/cms/app/edit/:id/contributions/",{templateUrl:"/views/contributions.html",controller:"ContributionsCtrl"}).when("/cms/app/edit/:id/:contentType?",{templateUrl:"/views/contentedit.html",controller:"ContenteditCtrl",reloadOnSearch:!1}).when("/cms/app/targeting/",{templateUrl:"/views/targeting-editor.html",controller:"TargetingCtrl"}).when("/cms/app/cms-notifications/",{templateUrl:"/views/cms-notifications.html",controller:"CmsNotificationsCtrl"}).when("/cms/app/reporting/",{templateUrl:"/views/reporting.html",controller:"ReportingCtrl"}).when("/cms/app/pzones/",{templateUrl:"/views/pzones.html",controller:"PzoneCtrl"}).otherwise({redirectTo:"/cms/app/list/"}),$sceProvider.enabled(!1)}).config(function($provide,$httpProvider){$provide.decorator("$exceptionHandler",function($delegate){return function(exception,cause){$delegate(exception,cause),window.Raven.captureException(exception)}}),$httpProvider.interceptors.push("BugReportInterceptor"),$httpProvider.interceptors.push("PermissionsInterceptor"),$httpProvider.interceptors.push("BadRequestInterceptor"),$httpProvider.interceptors.push("TunicInterceptor")}).run(function($rootScope,$http,$cookies){$http.defaults.headers.common["X-CSRFToken"]=$cookies.csrftoken;var deleteHeaders=$http.defaults.headers["delete"]||{};deleteHeaders["X-CSRFToken"]=$cookies.csrftoken,$http.defaults.headers["delete"]=deleteHeaders}),angular.module("bulbs.api",["restangular","moment"]),angular.module("bulbs.api").factory("AuthorService",function(Restangular){return Restangular.setBaseUrl("/cms/api/v1/"),Restangular.setRequestSuffix("/"),Restangular.extendModel("author",function(obj){return angular.extend(obj,{getFullName:function(){return obj.first_name+" "+obj.last_name}})}),Restangular.all("author")}),angular.module("bulbs.api").factory("ContentService",function(Restangular){return Restangular.setBaseUrl("/cms/api/v1/"),Restangular.setRequestSuffix("/"),Restangular.extendModel("content",function(obj){var extendAuthor=function(author){return angular.extend(author,{getFullName:function(){return obj.contributor.first_name+" "+obj.contributor.last_name}})};for(var i in obj.authors)obj.authors[i]=extendAuthor(obj.authors[i]);return obj}),Restangular.extendModel("contributions",function(obj){return obj&&obj.contributor&&(obj.contributor=angular.extend(obj.contributor,{getFullName:function(){return obj.contributor.first_name+" "+obj.contributor.last_name}})),obj}),Restangular.extendCollection("contributions",function(collection){return collection.save=function(data){return collection.post(data).then(function(contributions){return Restangular.restangularizeCollection("contributions",contributions)})},collection}),Restangular.service("content")}),angular.module("bulbs.api").factory("ContributionRoleService",function(Restangular){return Restangular.withConfig(function(RestangularConfigurer){RestangularConfigurer.setBaseUrl("/cms/api/v1/contributions/"),RestangularConfigurer.setRequestSuffix("/")}).service("role")}).factory("ContentReportingService",function(Restangular){return Restangular.withConfig(function(RestangularConfigurer){RestangularConfigurer.setBaseUrl("/cms/api/v1/contributions/"),RestangularConfigurer.setRequestSuffix("/")}).service("contentreporting")}).factory("FreelancePayReportingService",function(Restangular,moment){return Restangular.withConfig(function(RestangularConfigurer){RestangularConfigurer.setBaseUrl("/cms/api/v1/contributions/"),RestangularConfigurer.setRequestSuffix("/")}).service("freelancereporting")}).factory("ContributionReportingService",function(Restangular,moment){return Restangular.extendModel("reporting",function(obj){return obj.user=angular.extend(obj.user,{toString:function(){return obj.user.full_name||obj.user.username}}),obj.content=angular.extend(obj.content,{toString:function(){return obj.content.title+" ("+moment(obj.content.published).format("MM/DD/YYYY h:mm a")+")"}}),obj}),Restangular.withConfig(function(RestangularConfigurer){RestangularConfigurer.setBaseUrl("/cms/api/v1/contributions/"),RestangularConfigurer.setRequestSuffix("/")}).service("reporting")}),function(){function BettyCropperService($http,$interpolate,$q,CmsConfig,BettyImage,$){function upload(){var uploadImageDeferred=$q.defer();angular.element(fileInputId).remove();var fileInput=angular.element(inputTemplate);return angular.element("body").append(fileInput),fileInput.click(),fileInput.unbind("change"),fileInput.bind("change",function(e){1!==e.target.files.length&&uploadImageDeferred.reject("We need exactly one image!");var file=e.target.files[0];0!==file.type.indexOf("image/")&&uploadImageDeferred.reject("Not an image!"),file.size>10485760&&uploadImageDeferred.reject("The file is too large!");var imageData=new FormData;imageData.append("image",file),$http({method:"POST",url:CmsConfig.buildImageApiUrl("api/new"),headers:{"X-Betty-Api-Key":CmsConfig.getImageApiKey(),"Content-Type":void 0,"X-CSRFToken":void 0},data:imageData,transformRequest:angular.identity,transformResponse:function(data,headersGetter){"string"==typeof data&&(data=$.parseJSON(data));var image=new BettyImage(data);return image}}).success(function(success){uploadImageDeferred.resolve(success)}).error(function(error){uploadImageDeferred.reject(error)})}),uploadImageDeferred.promise}function get(id){return $http({method:"GET",url:CmsConfig.buildImageApiUrl("api/"+id),headers:{"X-Betty-Api-Key":CmsConfig.getImageApiKey(),"Content-Type":void 0,"X-CSRFToken":void 0},transformRequest:angular.identity,transformResponse:function(data,headersGetter){return"string"==typeof data&&(data=$.parseJSON(data)),new BettyImage(data)}})}function detailPatch(id,name,credit,selections){return $http({method:"PATCH",url:CmsConfig.buildImageApiUrl("api/"+id),headers:{"X-Betty-Api-Key":CmsConfig.getImageApiKey(),"Content-Type":void 0,"X-CSRFToken":void 0},data:{name:name,credit:credit,selections:selections},transformRequest:angular.identity,transformResponse:function(data,headersGetter){return"string"==typeof data&&(data=$.parseJSON(data)),new BettyImage(data)}})}function updateSelection(id,ratio,selections){return $http({method:"POST",url:CmsConfig.buildImageApiUrl("api/"+id+"/"+ratio),headers:{"X-Betty-Api-Key":CmsConfig.getImageApiKey(),"Content-Type":void 0,"X-CSRFToken":void 0},data:selections})}var fileInputId="#bulbs-cms-hidden-image-file-input",inputTemplate='<input id="bulbs-cms-hidden-image-file-input" type="file" accept="image/*" style="position: absolute; left:-99999px;" name="image" />';this.upload=upload,this.get=get,this.detail=get,this.detailPatch=detailPatch,this.updateSelection=updateSelection}function BettyImageFactory($interpolate,$http,CmsConfig,Selection,$){function BettyImage(data){this.id=data.id,this.name=data.name,this.width=data.width,this.height=data.height,this.selections={};for(var ratio in data.selections)this.selections[ratio]=new Selection(data.selections[ratio])}return BettyImage.prototype.scaleToFit=function(width,height){var scale;if(width&&height){var fitRatio=width/height,thisRatio=this.width/this.height;scale=fitRatio>thisRatio?height/this.height:width/this.width}else width&&(scale=width/this.width),height&&(scale=height/this.height);var scaled={width:Math.round(this.width*scale),height:Math.round(this.height*scale),scale:scale};return scaled},BettyImage.prototype.getStyles=function(width,height,ratio){0===height&&(height=null);var selection=this.selections[ratio],scaledSelection=selection.scaleToFit(width,height);return{"background-image":"url("+this.url("original",1200,"jpg")+")","background-size":Math.floor(scaledSelection.width()/selection.width()*this.width)+"px","background-position":"-"+scaledSelection.x0+"px -"+scaledSelection.y0+"px",height:scaledSelection.height()+"px",width:scaledSelection.width()+"px","background-repeat":"no-repeat",position:"relative"}},BettyImage.prototype.url=function(ratio,width,format){for(var exp=$interpolate("{{ base_url }}/{{ id }}/{{ ratio }}/{{ width }}.{{ format }}"),idStr=this.id.toString(),segmentedId="",i=0;i<idStr.length;i++)i%4===0&&0!==i&&(segmentedId+="/"),segmentedId+=idStr.substr(i,1);return exp({base_url:CmsConfig.buildImageApiUrl(),id:segmentedId,ratio:ratio,width:width,format:format})},BettyImage.prototype.updateSelection=function(ratio,selection){var data={x0:selection.x0,x1:selection.x1,y0:selection.y0,y1:selection.y1};return selection.source&&(data.source=selection.source),$http({method:"POST",url:CmsConfig.buildImageApiUrl("api/"+this.id+"/"+ratio),headers:{"X-Betty-Api-Key":CmsConfig.getImageApiKey(),"Content-Type":void 0,"X-CSRFToken":void 0},data:data,transformResponse:function(data,headersGetter){return"string"==typeof data&&(data=$.parseJSON(data)),[ratio,new Selection(data.selections[ratio])]}})},BettyImage}function SelectionFactory(){function Selection(data){this.x0=data.x0,this.x1=data.x1,this.y0=data.y0,this.y1=data.y1,this.source=data.source}return Selection.prototype.width=function(){return this.x1-this.x0},Selection.prototype.height=function(){return this.y1-this.y0},Selection.prototype.scaleBy=function(scale){var scaledToFit=new Selection({x0:Math.round(this.x0*scale),x1:Math.round(this.x1*scale),y0:Math.round(this.y0*scale),y1:Math.round(this.y1*scale)});return scaledToFit},Selection.prototype.scaleToFit=function(width,height){var scale;if(width&&height){var fitRatio=width/height,thisRatio=this.width()/this.height();scale=fitRatio>thisRatio?height/this.height():width/this.width()}else width&&(scale=width/this.width()),height&&(scale=height/this.height());return this.scaleBy(scale)},Selection}angular.module("BettyCropper",["bulbs.cms.site.config","restangular","jquery"]).factory("Selection",SelectionFactory).factory("BettyImage",BettyImageFactory).service("BettyCropper",BettyCropperService)}(),angular.module("autocompleteBasic",["bulbs.cms.site.config","BulbsAutocomplete","BulbsAutocomplete.suggest","lodash"]).value("AUTOCOMPLETE_BASIC_DEBOUNCE",200).directive("autocompleteBasic",["_","CmsConfig",function(_,CmsConfig){return{controller:["$scope","BULBS_AUTOCOMPLETE_EVENT_KEYPRESS","AUTOCOMPLETE_BASIC_DEBOUNCE",function($scope,BULBS_AUTOCOMPLETE_EVENT_KEYPRESS,AUTOCOMPLETE_BASIC_DEBOUNCE){$scope.writables={searchTerm:""},$scope.autocompleteItems=[];var $getItems=function(){return $scope.searchFunction($scope.writables.searchTerm).then(function(data){return _.map(data,function(item){return{name:$scope.displayFormatter(item),value:item}})})};$scope.updateAutocomplete=_.debounce(function(){$scope.writables.searchTerm&&$getItems().then(function(results){$scope.autocompleteItems=results})},AUTOCOMPLETE_BASIC_DEBOUNCE),$scope.delayClearAutocomplete=function(){_.delay(function(){$scope.clearAutocomplete(),$scope.$digest()},200)},$scope.clearAutocomplete=function(){$scope.writables.searchTerm="",$scope.autocompleteItems=[]},$scope.clearSelectionOverlay=function(){$scope.clearAutocomplete(),$scope.showSelectionOverlay=!1,$scope.updateNgModel(),$scope.onSelect({})},$scope.handleKeypress=function($event){27===$event.keyCode?$scope.clearAutocomplete():40===$event.keyCode&&_.isEmpty($scope.autocompleteItems)?$scope.updateAutocomplete():$scope.$broadcast(BULBS_AUTOCOMPLETE_EVENT_KEYPRESS,$event)},$scope.handleSelect=function(selection){selection&&$scope.updateNgModel&&($scope.updateNgModel(selection),$scope.showSelectionOverlay=!0),$scope.clearAutocomplete(),$scope.onSelect({selection:selection})}}],link:function(scope,iElement,iAttrs,ngModelCtrl){var defaultFormatter=function(context){return context.item};if(scope.valueFormatter=function(viewValue){return(scope.itemValueFormatter||defaultFormatter)({item:viewValue})},scope.displayFormatter=function(modelValue){return(scope.itemDisplayFormatter||defaultFormatter)({item:modelValue})},ngModelCtrl){ngModelCtrl.$formatters.push(function(modelValue){return scope.displayFormatter(modelValue)}),ngModelCtrl.$render=function(){scope.selectedValue=ngModelCtrl.$viewValue},ngModelCtrl.$parsers.push(function(viewValue){return scope.valueFormatter(viewValue)});var unbindInitialValue=scope.$watch("initialValue",function(){scope.selectedValue=scope.initialValue});scope.updateNgModel=function(selection){unbindInitialValue();var newValue=_.isUndefined(selection)?null:angular.copy(selection.value);ngModelCtrl.$setViewValue(angular.copy(newValue)),scope.selectedValue=scope.displayFormatter(newValue)}}},require:"?ngModel",restrict:"E",scope:{hideSearchIcon:"&",inputId:"@",inputPlaceholder:"@",initialValue:"=",itemDisplayFormatter:"&",itemValueFormatter:"&",onSelect:"&",searchFunction:"=",ngDisabled:"&"},templateUrl:CmsConfig.buildComponentPath("autocomplete-basic/autocomplete-basic.html")}}]),angular.module("bettyEditable",["BettyCropper","bulbs.cms.imageCropModal","bulbs.cms.site.config","ui.bootstrap.modal"]).directive("bettyEditable",["$http","CmsConfig","BettyCropper","openImageCropModal",function($http,CmsConfig,BettyCropper,openImageCropModal){return{restrict:"E",templateUrl:CmsConfig.buildComponentPath("betty-editable/betty-editable.html"),scope:{addStyles:"@",editable:"=?",hideMetas:"=",image:"=",placeholderText:"@",ratio:"@",onChange:"&"},controller:function($scope,$element){$scope.editable=angular.isDefined($scope.editable)?$scope.editable:!0,$scope.upload=function(e){BettyCropper.upload().then(function(success){$scope.image={id:success.id,caption:null,alt:null},$scope.bettyImage=success},function(error){console.log(error)},function(progress){console.log(progress)})},$scope.edit=function(e){openImageCropModal($scope.image).then(function(image){null===image.id?$scope.image=null:($scope.image=image,BettyCropper.get($scope.image.id).then(function(response){$scope.bettyImage=response.data,$scope.setStyles()}))})}},link:function(scope,element,attrs){void 0===scope.bettyImage&&(scope.bettyImage=null),scope.setStyles=function(){if(scope.bettyImage)scope.imageStyling=scope.bettyImage.getStyles(element.parent().width(),null,scope.ratio);else{var ratioWidth=parseInt(scope.ratio.split("x")[0],10),ratioHeight=parseInt(scope.ratio.split("x")[1],10);scope.imageStyling={"background-color":"#333",position:"relative",width:element.parent().width(),height:Math.floor(element.parent().width()*ratioHeight/ratioWidth)+"px"}}},scope.$watch("image",function(newImage,oldImage){newImage&&newImage.id?BettyCropper.get(newImage.id).then(function(response){scope.bettyImage=response.data,oldImage&&parseInt(response.data.id,10)===oldImage.id||scope.onChange()}):angular.equals(newImage,oldImage)||scope.onChange()}),scope.$watch("bettyImage",function(newImage,oldImage){scope.setStyles()},!0),element.resize(scope.setStyles),scope.removeImage=function(){scope.image=null},scope.editImage=function(){openImageCropModal(scope.image).then(function(success){console.log(success)})}}}}]),angular.module("bulbs.cms.breadcrumb",["bulbs.cms.site.config","bulbs.cms.superFeatures.api"]).directive("breadcrumb",["$sce","CmsConfig",function($sce,CmsConfig){return{scope:{linksList:"="},link:function(scope,element,attrs){scope.renderValue=function(value){return $sce.trustAsHtml(angular.isFunction(value)?value():value)}},templateUrl:CmsConfig.buildComponentPath("breadcrumb","breadcrumb.html")}}]),angular.module("bugReporter",["bulbs.cms.config"]).directive("bugReporter",["$http","$window","CmsConfig",function($http,$window,CmsConfig){return{restrict:"E",templateUrl:CmsConfig.buildComponentPath("bug-reporter/bug-reporter-button.html"),scope:{},controller:function($scope,$element,$timeout){$scope.report={},$scope.reportButton={idle:"Submit",busy:"Sending",finished:"Sent!",error:"Error!"},$scope.modalVisible=!1,$scope.showThankYou=!1,$scope.showModal=function(){$scope.modalVisible=!0},$scope.dismissModal=function(){$scope.modalVisible=!1,$scope.showThankYou=!1},$scope.sendToWebtech=function(){var report="When I tried to:\n\n"+$scope.report.firstRes+"\n\nI thought this would happen:\n\n"+$scope.report.secondRes+"\n\n...but this happened instead:\n\n"+$scope.report.thirdRes,data={report:report,url:$window.location.href,user_agent:$window.navigator.userAgent};return $http.post("/cms/api/v1/report-bug/",data)},$scope.sendToWebtechCbk=function(promise){promise.then(function(){$scope.showThankYou=!0,$timeout(function(){$scope.dismissModal();for(var entry in $scope.report)$scope.report[entry]=""},5e3)})},$window.showBugReportModal=function(){$scope.$apply($scope.showModal())}},link:function(scope,element){}}}]),angular.module("campaignAutocomplete",["autocompleteBasic","bulbs.cms.site.config","cms.tunic.config","lodash","uuid4"]).directive("campaignAutocomplete",["$http","CmsConfig","TunicConfig","uuid4","_",function($http,CmsConfig,TunicConfig,uuid4,_){return{controller:["$scope",function($scope){$scope.itemDisplayFormatter=function(campaign){return _.isObject(campaign)?campaign.name+" - "+campaign.id:void 0},$scope.itemValueFormatter=function(campaign){return _.isObject(campaign)?campaign.id:null},$scope.searchCampaigns=function(searchTerm){return $http.get(TunicConfig.buildBackendApiUrl("campaign/"),{params:{search:searchTerm}}).then(function(response){return response.data.results})}}],link:function(scope,iElement,iAttrs,ngModelCtrl){scope.uuid=uuid4.generate(),ngModelCtrl&&(scope.ngModel=ngModelCtrl,ngModelCtrl.$render=function(){_.isNumber(ngModelCtrl.$modelValue)&&!scope.initialValue&&$http.get(TunicConfig.buildBackendApiUrl("campaign/"+ngModelCtrl.$modelValue+"/")).then(function(result){scope.initialValue=scope.itemDisplayFormatter(result.data)})},scope.onSelect=function(selection){ngModelCtrl.$commitViewValue()})},restrict:"E",templateUrl:CmsConfig.buildComponentPath("campaign-autocomplete/campaign-autocomplete.html"),require:"ngModel",scope:{label:"@campaignAutocompleteLabel",onSelect:"&campaignAutocompleteOnSelect"}}}]),angular.module("campaigns.edit.directive",["apiServices.campaign.factory","BettyCropper","bulbs.cms.site.config","campaigns.edit.sponsorPixel","lodash","saveButton.directive","topBar"]).directive("campaignsEdit",function(CmsConfig){return{controller:function(_,$location,$q,$routeParams,$scope,Campaign){"new"===$routeParams.id?($scope.model=Campaign.$build(),$scope.isNew=!0):$scope.model=Campaign.$find($routeParams.id),window.onbeforeunload=function(e){return!_.isEmpty($scope.model.$dirty())||$scope.isNew||$scope.needsSave?"You have unsaved changes.":void 0},$scope.$on("$destroy",function(){delete window.onbeforeunload}),$scope.addPixel=function(){var pixel={url:"",campaign_type:""};$scope.model.pixels.push(pixel)},$scope.deletePixel=function(pixel){$scope.model.pixels=_.without($scope.model.pixels,pixel)},$scope.saveModel=function(){var promise;if($scope.model)promise=$scope.model.$save().$asPromise().then(function(data){$location.path("/cms/app/campaigns/edit/"+data.id+"/")});else{var deferred=$q.defer();deferred.reject(),promise=deferred.promise}return promise}},restrict:"E",scope:{getModelId:"&modelId"},templateUrl:CmsConfig.buildComponentPath("campaigns/campaigns-edit/campaigns-edit.html")}}),angular.module("campaigns.edit.sponsorPixel.directive",["bulbs.cms.config"]).constant("PIXEL_TYPES",[{name:"Listing",value:"Listing"},{name:"Detail",value:"Detail"}]).directive("campaignsEditSponsorPixel",function(CmsConfig){return{controller:function($scope,PIXEL_TYPES){$scope.PIXEL_TYPES=PIXEL_TYPES},restrict:"E",scope:{model:"="},templateUrl:CmsConfig.buildComponentPath("campaigns/campaigns-edit/campaigns-edit-sponsor-pixel/campaigns-edit-sponsor-pixel.html")}}),angular.module("campaigns.edit.sponsorPixel",["campaigns.edit.sponsorPixel.directive"]),angular.module("campaigns.edit",["bulbs.cms.site.config","campaigns.edit.directive"]).config(function($routeProvider){$routeProvider.when("/cms/app/campaigns/edit/:id/",{controller:function($routeParams,$scope,$window,CmsConfig){$window.document.title=CmsConfig.getCmsName()+" | Edit Campaign",$scope.routeId=$routeParams.id},template:'<campaigns-edit model-id="routeId"></campaigns-edit>',reloadOnSearch:!1})}),angular.module("campaigns.list",["apiServices.campaign.factory","bulbs.cms.site.config","listPage","moment"]).config(function($injector,$routeProvider,CmsConfigProvider){var CmsConfig=$injector.invoke(CmsConfigProvider.$get);$routeProvider.when("/cms/app/campaigns/",{controller:function($scope,$window,Campaign){$window.document.title=CmsConfig.getCmsName()+" | Campaign",$scope.modelFactory=Campaign},templateUrl:CmsConfig.buildComponentPath("campaigns/campaigns-list/campaigns-list-page.html")})}),angular.module("campaigns",["campaigns.edit","campaigns.list"]),angular.module("confirmationModal",["confirmationModal.factory","ui.bootstrap"]).directive("confirmationModalOpener",function(ConfirmationModal){return{restrict:"A",scope:{modalBody:"@",modalCancelText:"@",modalOkText:"@",modalOnCancel:"&",modalOnOk:"&",modalTitle:"@"},link:function(scope,element){var modalInstance=null;element.addClass("confirmation-modal-opener"),element.on("click",function(){modalInstance=new ConfirmationModal(scope)})}}}),angular.module("confirmationModal.factory",["bulbs.cms.site.config","ui.bootstrap.modal"]).factory("ConfirmationModal",function($modal,CmsConfig){var ConfirmationModal=function(scope){return function(scope){$modal.open({controller:function($scope,$modalInstance){$scope.confirm=function(){$scope.$close(),$scope.modalOnOk()},$scope.cancel=function(){$scope.$dismiss(),$scope.modalOnCancel()}},scope:scope,templateUrl:CmsConfig.buildComponentPath("confirmation-modal/confirmation-modal.html")})}(scope)};return ConfirmationModal}),angular.module("bulbs.cms.contentSearch",["autocompleteBasic","bulbs.cms.site.config","contentServices.factory","lodash"]).directive("contentSearch",["_","CmsConfig","ContentFactory",function(_,CmsConfig,ContentFactory){return{link:function(scope,element,attrs,ngModelCtrl){scope.itemDisplayFormatter=function(content){return _.isObject(content)?content.title+" - "+content.id:void 0},scope.itemValueFormatter=function(content){return _.isObject(content)?content.id:null},scope.searchContent=function(searchTerm){return ContentFactory.all("content").getList({search:searchTerm})},ngModelCtrl?(scope.ngModel=ngModelCtrl,ngModelCtrl.$render=function(){_.isNumber(ngModelCtrl.$modelValue)&&!scope.initialValue&&ContentFactory.one("content",ngModelCtrl.$modelValue).get().then(function(content){scope.initialValue=scope.itemDisplayFormatter(content)})},scope.autocompleteOnSelect=function(){ngModelCtrl.$commitViewValue()}):scope.autocompleteOnSelect=function(selection){scope.onSelect({selection:scope.itemValueFormatter(selection.value)})}},require:"?ngModel",restrict:"E",scope:{inputId:"@",onSelect:"&",ngDisabled:"&"},templateUrl:CmsConfig.buildComponentPath("content-search","content-search.html")}}]),angular.module("bulbs.cms.currentUser.api",["bulbs.cms.site.config","lodash"]).service("CurrentUserApi",["_","$http","$q","CmsConfig",function(_,$http,$q,CmsConfig){var currentUser,pendingGetCurrentUserRequest,parsePayload=function(payload){var data=_.cloneDeep(payload);return data.displayName=data.first_name&&data.last_name?data.first_name+" "+data.last_name:data.email||data.username,data},getCurrentUser=function(){return pendingGetCurrentUserRequest||(pendingGetCurrentUserRequest=$http.get(CmsConfig.buildApiUrlRoot("me/")).then(function(response){return currentUser=parsePayload(response.data)})["finally"](function(){pendingGetCurrentUserRequest=null})),pendingGetCurrentUserRequest};return{getCurrentUserWithCache:function(){return currentUser?$q.when(currentUser):getCurrentUser()},logout:function(){return $http.get(CmsConfig.buildApiUrlRoot("me","logout/")).then(function(){currentUser=null})}}}]),angular.module("bulbs.cms.currentUser",["bulbs.cms.currentUser.api","bulbs.cms.user.nameDisplayFilter"]),angular.module("bulbs.cms.user.nameDisplayFilter",[]).filter("userNameDisplay",[function(){return function(user){return user?user.full_name?user.full_name:user.first_name&&user.last_name?user.first_name+" "+user.last_name:user.username:""}}]),angular.module("bulbs.cms.customSearch.config",["lodash"]).provider("CustomSearchConfig",["_",function(_){var CustomSearchConfigError=BulbsCmsConfigError.build("CustomSearchConfig"),checkOrError=function(value,test,errorMsg){if(test(value))return value;throw new CustomSearchConfigError(errorMsg)},conditionFieldMappings=[],conditionTypes=[],timePeriodMappings=[],requestCapMs=150;this.addConditionField=function(name,endpoint,valueStructureName,valueStructureValue){return conditionFieldMappings.push({name:checkOrError(name,_.isString,"condition field name must be a string!"),endpoint:checkOrError(endpoint,_.isString,"condition field endpoint must be a string!"),value_structure:{name:checkOrError(valueStructureName,_.isString,"condition field value structure name must be a string!"),value:checkOrError(valueStructureValue,_.isString,"condition field value structure value must be a string!")}}),this},this.addConditionType=function(name,value){return conditionTypes.push({name:checkOrError(name,_.isString,"condition type name must be a string!"),value:checkOrError(value,_.isString,"condition type value must be a string!")}),this},this.addTimePeriod=function(name,value){return timePeriodMappings.push({name:checkOrError(name,_.isString,"time period name must be a string!"),value:checkOrError(value,_.isString,"time period value must be a string!")}),this},this.setRequestCapMs=function(value){return requestCapMs=checkOrError(value,_.isNumber,"request cap milliseconds must be a number!"),this},this.$get=[function(){return{getConditionFields:_.constant(conditionFieldMappings),getConditionTypes:_.constant(conditionTypes),getRequestCapMs:_.constant(requestCapMs),getTimePeriods:_.constant(timePeriodMappings)}}]}]),angular.module("customSearch.contentItem.directive",["bulbs.cms.site.config"]).directive("customSearchContentItem",function(CmsConfig){return{restrict:"E",scope:{model:"=",controllerService:"=",onUpdate:"&"},templateUrl:CmsConfig.buildComponentPath("custom-search/custom-search-content-item/custom-search-content-item.html")}}),angular.module("customSearch.contentItem",["customSearch.contentItem.directive"]),angular.module("customSearch.directive",["bulbs.cms.contentSearch","bulbs.cms.site.config","customSearch.contentItem","customSearch.group","customSearch.service"]).directive("customSearch",function(CmsConfig){return{controller:function(_,$scope,CustomSearchService){$scope.customSearchService=new CustomSearchService,$scope.resetFilters=function(){$scope.customSearchService.setPage(1),$scope.customSearchService.setQuery(""),$scope.addedFilterOn=!1,$scope.removedFilterOn=!1},$scope.$conditionalContentRetrieve=function(){$scope.addedFilterOn?$scope.customSearchService.$filterContentByIncluded():$scope.removedFilterOn?$scope.customSearchService.$filterContentByExcluded():$scope.customSearchService.$retrieveContent()},$scope.$contentRetrieve=function(){$scope.customSearchService.$retrieveContent(),$scope.onUpdate()}},link:function(scope,iElement,iAttrs,ngModelCtrl){ngModelCtrl.$formatters.push(function(modelValue){scope.customSearchService.data(modelValue),scope.customSearchService.$retrieveContent()})},require:"ngModel",restrict:"E",scope:{onUpdate:"&"},templateUrl:CmsConfig.buildComponentPath("custom-search/custom-search.html")}}),angular.module("customSearch.group.condition.directive",["bulbs.cms.site.config","BulbsAutocomplete.suggest","BulbsAutocomplete","contentServices.factory"]).directive("customSearchGroupCondition",function(CmsConfig){return{controller:function(_,$q,$scope,BULBS_AUTOCOMPLETE_EVENT_KEYPRESS,ContentFactory,CustomSearchConfig){$scope.conditionTypes=CustomSearchConfig.getConditionTypes(),
$scope.fieldTypes=CustomSearchConfig.getConditionFields(),$scope.writables={searchTerm:""},$scope.autocompleteItems=[],$scope.data=$scope.controllerService.groupsConditionsGet($scope.groupIndex,$scope.conditionIndex);var $getItems=function(){return ContentFactory.all($scope.data.field).getList({search:$scope.writables.searchTerm}).then(function(items){var field=_.find($scope.fieldTypes,function(type){return type.endpoint===$scope.data.field});return _.map(items,function(item){return{name:item[field.value_structure.name],value:item[field.value_structure.value]}})})};$scope.updateAutocomplete=function(){$scope.writables.searchTerm&&$getItems().then(function(results){$scope.autocompleteItems=results})},$scope.delayClearAutocomplete=function(){_.delay(function(){$scope.clearAutocomplete(),$scope.$digest()},200)},$scope.clearAutocomplete=function(){$scope.writables.searchTerm="",$scope.autocompleteItems=[]},$scope.handleKeypress=function($event){27===$event.keyCode?$scope.clearAutocomplete():$scope.$broadcast(BULBS_AUTOCOMPLETE_EVENT_KEYPRESS,$event)}},restrict:"E",scope:{controllerService:"=",groupIndex:"=",conditionIndex:"=",onUpdate:"&",remove:"&"},templateUrl:CmsConfig.buildComponentPath("custom-search/custom-search-group/custom-search-group-condition/custom-search-group-condition.html")}}),angular.module("customSearch.group.condition",["customSearch.group.condition.directive"]),angular.module("customSearch.group.directive",["bulbs.cms.site.config","uuid4"]).directive("customSearchGroup",function(CmsConfig){return{controller:function($scope,CustomSearchConfig,uuid4){$scope.data=$scope.controllerService.groupsGet($scope.groupIndex),$scope.timePeriods=CustomSearchConfig.getTimePeriods(),$scope.uuid=uuid4.generate(),$scope.$update=function(){$scope.controllerService.$groupsUpdateResultCountFor($scope.groupIndex).then(function(){$scope.onUpdate()})},$scope.controllerService.$groupsUpdateResultCountFor($scope.groupIndex)},restrict:"E",scope:{controllerService:"=",groupIndex:"=",remove:"&",onUpdate:"&"},templateUrl:CmsConfig.buildComponentPath("custom-search/custom-search-group/custom-search-group.html")}}),angular.module("customSearch.group",["customSearch.group.directive","customSearch.group.condition"]),angular.module("customSearch.service",["bulbs.cms.site.config","apiServices.customSearch.factory"]).factory("CustomSearchService",function(_,CustomSearch,CustomSearchConfig){var defaultData={groups:[],includedIds:[],excludedIds:[],pinnedIds:[]},CustomSearchService=function(data){this.data(data),this.$page=1,this.$query="",this.content={}};return CustomSearchService.prototype.data=function(data){return _.isUndefined(data)?this._data=defaultData:this._data=_.defaults(data,defaultData),this._data},CustomSearchService.prototype._$getContent=_.debounce(function(queryData){var self=this;return CustomSearch.$retrieveContent(queryData).then(function(data){self.content=data})},CustomSearchConfig.getRequestCapMs()),CustomSearchService.prototype.$filterContentByIncluded=function(){var contentQuery={includedIds:this._data.includedIds,page:this.$page,query:this.$query};return this._$getContent(contentQuery)},CustomSearchService.prototype.$filterContentByExcluded=function(){var contentQuery={includedIds:this._data.excludedIds,page:this.$page,query:this.$query};return this._$getContent(contentQuery)},CustomSearchService.prototype.$retrieveContent=function(){var contentQuery=_.assign({page:this.$page,query:this.$query,preview:!0},this._data);return this._$getContent(contentQuery)},CustomSearchService.prototype.$groupsUpdateResultCountFor=function(index){var self=this;return function(index){return CustomSearch.$retrieveGroupCount(self._data.groups[index]).then(function(count){self._data.groups[index].$result_count=count})}(index)},CustomSearchService.prototype.groupsResultCountGet=function(index){return this._data.groups[index].$result_count||0},CustomSearchService.prototype.groupsList=function(){return this._data.groups},CustomSearchService.prototype.groupsAdd=function(data){return _.isUndefined(data)&&(data={}),data=_.defaults(data,{conditions:[],time:null,$result_count:0}),this._data.groups.push(data),data},CustomSearchService.prototype.groupsGet=function(index){return this._data.groups[index]},CustomSearchService.prototype.groupsRemove=function(index){return this._data.groups.splice(index,1).length>0},CustomSearchService.prototype.groupsClear=function(){this._data.groups=[]},CustomSearchService.prototype.groupsConditionsAdd=function(groupIndex,data){return _.isUndefined(data)&&(data={}),data=_.defaults(data,{field:CustomSearchConfig.getConditionFields()[0].endpoint,type:CustomSearchConfig.getConditionTypes()[0].value,values:[]}),this._data.groups[groupIndex].conditions.push(data),data},CustomSearchService.prototype.groupsConditionsGet=function(groupIndex,conditionIndex){return this._data.groups[groupIndex].conditions[conditionIndex]},CustomSearchService.prototype.groupsConditionsList=function(groupIndex){return this._data.groups[groupIndex].conditions},CustomSearchService.prototype.groupsConditionsRemove=function(groupIndex,conditionIndex){return this._data.groups[groupIndex].conditions.splice(conditionIndex,1).length>0},CustomSearchService.prototype.groupsTimePeriodSet=function(groupIndex){var value=CustomSearchConfig.getTimePeriods()[0].value;return this._data.groups[groupIndex].time=value,value},CustomSearchService.prototype.groupsTimePeriodGet=function(groupIndex){return this._data.groups[groupIndex].time||null},CustomSearchService.prototype.groupsTimePeriodRemove=function(groupIndex){this._data.groups[groupIndex].time=null},CustomSearchService.prototype.groupsConditionsValuesAdd=function(groupIndex,conditionIndex,value){var values=this._data.groups[groupIndex].conditions[conditionIndex].values,matches=_.find(values,function(existingValue){return existingValue.name===value.name&&existingValue.value===value.value});matches||values.push(value)},CustomSearchService.prototype.groupsConditionsValuesClear=function(groupIndex,conditionIndex){this._data.groups[groupIndex].conditions[conditionIndex].values=[]},CustomSearchService.prototype.groupsConditionsValuesList=function(groupIndex,conditionIndex){return this._data.groups[groupIndex].conditions[conditionIndex].values},CustomSearchService.prototype.groupsConditionsValuesRemove=function(groupIndex,conditionIndex,valueIndex){return this._data.groups[groupIndex].conditions[conditionIndex].values.splice(valueIndex,1).length>0},CustomSearchService.prototype.includesList=function(){return this._data.includedIds},CustomSearchService.prototype.includesAdd=function(id){this._data.includedIds.push(id),this._data.includedIds=_.uniq(this._data.includedIds),this.excludesRemove(id)},CustomSearchService.prototype.includesRemove=function(id){this._data.includedIds=_.without(this._data.includedIds,id)},CustomSearchService.prototype.includesHas=function(id){return _.includes(this._data.includedIds,id)},CustomSearchService.prototype.excludesList=function(){return this._data.excludedIds},CustomSearchService.prototype.excludesAdd=function(id){this._data.excludedIds.push(id),this._data.excludedIds=_.uniq(this._data.excludedIds),this.includesRemove(id),this.pinsRemove(id)},CustomSearchService.prototype.excludesRemove=function(id){this._data.excludedIds=_.without(this._data.excludedIds,id)},CustomSearchService.prototype.excludesHas=function(id){return _.includes(this._data.excludedIds,id)},CustomSearchService.prototype.pinsList=function(){return this._data.pinnedIds},CustomSearchService.prototype.pinsAdd=function(id){this._data.pinnedIds.push(id),this._data.pinnedIds=_.uniq(this._data.pinnedIds),this.excludesRemove(id)},CustomSearchService.prototype.pinsRemove=function(id){this._data.pinnedIds=_.without(this._data.pinnedIds,id)},CustomSearchService.prototype.pinsHas=function(id){return _.includes(this._data.pinnedIds,id)},CustomSearchService.prototype.getPage=function(){return this.$page},CustomSearchService.prototype.setPage=function(page){this.$page=page},CustomSearchService.prototype.getQuery=function(){return this.$query},CustomSearchService.prototype.setQuery=function(query){this.$query=query},CustomSearchService}),angular.module("customSearch",["customSearch.directive"]),angular.module("bulbs.cms.dateTimeFilter",["bulbs.cms.site.config","lodash","moment"]).filter("dateTimeFormat",["_","moment","CmsConfig",function(_,moment,CmsConfig){function isInvalidDateValue(dateValue){return!_.isString(dateValue)&&!_.isDate(dateValue)&&!moment.isMoment(dateValue)}return function(date,format){return isInvalidDateValue(date)?"":(_.isString(format)||(date=moment(date),format=CmsConfig.getDateTimeFormatHumanReadable()),moment.tz(date,CmsConfig.getTimezoneName()).format(format))}}]),angular.module("bulbs.cms.dateTimeModal.controller",["bulbs.cms.site.config","moment","ui.bootstrap.modal"]).controller("DatetimeSelectionModalCtrl",["$scope","$modalInstance","CmsConfig","moment",function($scope,$modalInstance,CmsConfig,moment){$scope.nowInTimezone=function(){return $scope.dateInTimezone(moment())},$scope.dateInTimezone=function(date){return date.clone().tz(CmsConfig.getTimezoneName())},$scope.TIMEZONE_LABEL=moment.tz(CmsConfig.getTimezoneName()).format("z"),$scope.dateTime=$scope.modDatetime?$scope.dateInTimezone($scope.modDatetime):$scope.nowInTimezone(),$scope.time=$scope.dateTime.toDate(),$scope.date=$scope.dateTime.clone(),$scope.$watch("time",function(){var time=moment($scope.time),newTime=moment().year($scope.date.year()).dayOfYear($scope.date.dayOfYear()).hours(time.hours()).minutes(time.minutes());$scope.dateTime=$scope.dateInTimezone(newTime)}),$scope.$watch("date",function(){var date=$scope.date.clone(),time=moment($scope.time),newDate=moment().year($scope.date.year()).dayOfYear(date.dayOfYear()).hours(time.hours()).minutes(time.minutes());$scope.dateTime=$scope.dateInTimezone(newDate)}),$scope.setDate=function(selectedDate){$scope.date=$scope.dateInTimezone(moment(selectedDate))},$scope.isDateTimeInvalid=function(){return!$scope.dateTime.isValid()},$scope.setDateToday=function(){var today=$scope.nowInTimezone();$scope.date=$scope.dateTime.clone().year(today.year()).dayOfYear(today.dayOfYear())},$scope.setDateTomorrow=function(){var tomorrow=moment().add(1,"day");$scope.date=$scope.dateInTimezone(tomorrow.clone())},$scope.setTimeNow=function(){var now=$scope.nowInTimezone();$scope.date=now.clone(),$scope.time=now.clone().toDate()},$scope.setTimeMidnight=function(){var midnightTonight=$scope.nowInTimezone().startOf("day");$scope.date=midnightTonight.clone(),$scope.time=midnightTonight.clone().toDate()},$scope.clearDatetime=function(){$modalInstance.close(null)},$scope.chooseDatetime=function(){$scope.dateTime.isValid()&&$modalInstance.close($scope.dateTime)}}]),angular.module("bulbs.cms.dateTimeModal.opener",["bulbs.cms.dateTimeModal.controller","bulbs.cms.site.config","ui.bootstrap.modal"]).directive("datetimeSelectionModalOpener",["$modal","$q","CmsConfig",function($modal,$q,CmsConfig){return{restrict:"A",scope:{modalClearText:"@",modalOkText:"@",modDatetime:"=?ngModel",modalTitle:"@",modalOnBeforeClose:"&",modalOnClear:"&",modalOnClose:"&"},link:function(scope,element){var modalInstance=null;element.addClass("datetime-selection-modal-opener"),element.on("click",function(){modalInstance=$modal.open({templateUrl:CmsConfig.buildComponentPath("date-time-modal","date-time-modal.html"),controller:"DatetimeSelectionModalCtrl",scope:scope}),modalInstance.result.then(function(newDate){return $q.when(scope.modalOnBeforeClose({newDate:newDate})).then(function(result){result!==!1&&(scope.modDatetime=newDate,newDate?scope.modalOnClose({newDate:newDate}):scope.modalOnClear())})})})}}}]),angular.module("bulbs.cms.dateTimeModal",["bulbs.cms.dateTimeModal.opener"]),angular.module("bulbs.cms.dynamicContent.api",["bulbs.cms.site.config"]).service("DynamicContentApi",["$http","CmsConfig",function($http,CmsConfig){return{retrieveSchema:function(url){return $http({method:"OPTIONS",url:url})}}}]),angular.module("bulbs.cms.dynamicContent.form.field.boolean",["bulbs.cms.site.config","bulbs.cms.dynamicContent.form.input.label","bulbs.cms.dynamicContent.form.input.errors"]).directive("dynamicContentFormFieldBoolean",["CmsConfig",function(CmsConfig){return{require:["ngModel","^^form"],restrict:"E",scope:{uuid:"@",name:"@",ngModel:"=",schema:"="},templateUrl:CmsConfig.buildComponentPath("dynamic-content","dynamic-content-form","dynamic-content-form-field","dynamic-content-form-field-boolean","dynamic-content-form-field-boolean.html")}}]),angular.module("bulbs.cms.dynamicContent.form.field.color",["bulbs.cms.site.config","bulbs.cms.dynamicContent.form.input.label","bulbs.cms.dynamicContent.form.input.errors"]).directive("dynamicContentFormFieldColor",["CmsConfig",function(CmsConfig){return{require:["ngModel","^^form"],restrict:"E",scope:{uuid:"@",name:"@",ngModel:"=",schema:"="},templateUrl:CmsConfig.buildComponentPath("dynamic-content","dynamic-content-form","dynamic-content-form-field","dynamic-content-form-field-color","dynamic-content-form-field-color.html"),link:function(scope,element,attr,ctrls){var formField=ctrls[1][scope.name];formField.$validators.rgbhex=function(modelValue){return modelValue?/^#[0-9a-fA-F]{6}$/.test(modelValue):!0}}}}]),angular.module("bulbs.cms.dynamicContent.form.field.contentReferences",["bulbs.cms.dynamicContent.form.input.errors","bulbs.cms.dynamicContent.form.input.label","bulbs.cms.recircChooser","bulbs.cms.site.config"]).directive("dynamicContentFormFieldContentReferences",["CmsConfig",function(CmsConfig){return{require:["ngModel","^^form"],restrict:"E",scope:{uuid:"@",name:"@",ngModel:"=",schema:"="},templateUrl:CmsConfig.buildComponentPath("dynamic-content","dynamic-content-form","dynamic-content-form-field","dynamic-content-form-field-content-references","dynamic-content-form-field-content-references.html")}}]),angular.module("bulbs.cms.dynamicContent.form.field.dateTime",["bulbs.cms.dateTimeFilter","bulbs.cms.dateTimeModal","bulbs.cms.dynamicContent.form.input.label","bulbs.cms.dynamicContent.form.input.errors","bulbs.cms.site.config"]).directive("dynamicContentFormFieldDateTime",["CmsConfig",function(CmsConfig){return{controller:["$scope",function($scope){$scope.setDate=function(newDate){$scope.ngModel[$scope.name]=newDate.format()},$scope.clearDate=function(){$scope.ngModel[$scope.name]=null}}],require:["ngModel","^^form"],restrict:"E",scope:{uuid:"@",name:"@",ngModel:"=",schema:"="},templateUrl:CmsConfig.buildComponentPath("dynamic-content","dynamic-content-form","dynamic-content-form-field","dynamic-content-form-field-date-time","dynamic-content-form-field-date-time.html")}}]),angular.module("bulbs.cms.dynamicContent.form.field.image",["bettyEditable","bulbs.cms.site.config","bulbs.cms.staticImage","bulbs.cms.dynamicContent.form.input.errors","bulbs.cms.dynamicContent.form.input.label"]).directive("dynamicContentFormFieldImage",["CmsConfig",function(CmsConfig){return{require:["ngModel","^^form"],restrict:"E",scope:{name:"@",ngModel:"=",schema:"="},templateUrl:CmsConfig.buildComponentPath("dynamic-content","dynamic-content-form","dynamic-content-form-field","dynamic-content-form-field-image","dynamic-content-form-field-image.html")}}]),angular.module("bulbs.cms.dynamicContent.form.input.errors",["bulbs.cms.site.config"]).directive("dynamicContentFormFieldInputErrors",["CmsConfig",function(CmsConfig){return{link:function(scope,element,attrs,formCtrl){scope.form=formCtrl},require:"^^form",restrict:"E",scope:{name:"@",schema:"="},templateUrl:CmsConfig.buildComponentPath("dynamic-content","dynamic-content-form","dynamic-content-form-field","dynamic-content-form-field-input-errors","dynamic-content-form-field-input-errors.html")}}]),angular.module("bulbs.cms.dynamicContent.form.input.label",["bulbs.cms.site.config","lodash"]).directive("dynamicContentFormFieldInputLabel",["_","CmsConfig",function(_,CmsConfig){return{link:function(scope,element,attrs,formCtrl){scope.form=formCtrl,scope.isEmpty=_.isEmpty},require:"^^form",restrict:"E",scope:{inputId:"@",name:"@",schema:"="},templateUrl:CmsConfig.buildComponentPath("dynamic-content","dynamic-content-form","dynamic-content-form-field","dynamic-content-form-field-input-label","dynamic-content-form-field-input-label.html")}}]),angular.module("bulbs.cms.dynamicContent.form.field.integer",["bulbs.cms.site.config","bulbs.cms.dynamicContent.form.input.label","bulbs.cms.dynamicContent.form.input.errors"]).directive("dynamicContentFormFieldInteger",["CmsConfig",function(CmsConfig){return{require:["ngModel","^^form"],restrict:"E",scope:{uuid:"@",name:"@",ngModel:"=",schema:"="},templateUrl:CmsConfig.buildComponentPath("dynamic-content","dynamic-content-form","dynamic-content-form-field","dynamic-content-form-field-integer","dynamic-content-form-field-integer.html"),link:function(scope,element,attr,ctrls){var formField=ctrls[1][scope.name];formField.$validators.integer=function(modelValue){return modelValue?parseInt(modelValue,10)===modelValue:!0}}}}]),angular.module("bulbs.cms.dynamicContent.form.field.invalid",["bulbs.cms.dynamicContent.form.input.label","bulbs.cms.site.config"]).directive("dynamicContentFormFieldInvalid",["CmsConfig",function(CmsConfig){return{require:"^^form",restrict:"E",scope:{name:"@",schema:"="},templateUrl:CmsConfig.buildComponentPath("dynamic-content","dynamic-content-form","dynamic-content-form-field","dynamic-content-form-field-invalid","dynamic-content-form-field-invalid.html")}}]),angular.module("bulbs.cms.dynamicContent.form.field.list",["bulbs.cms.dynamicContent.form.field.object","bulbs.cms.dynamicContent.form.input.label","bulbs.cms.dynamicContent.form.types","bulbs.cms.site.config","bulbs.cms.utils","lodash"]).directive("dynamicContentFormFieldList",["CmsConfig","FIELD_TYPES_META","Utils",function(CmsConfig,FIELD_TYPES_META,Utils){return{controller:["_","$scope",function(_,$scope){_.isUndefined($scope.ngModel[$scope.name])&&($scope.ngModel[$scope.name]=[]),$scope.itemOrderingMemory=[],$scope.redoOrdering=function(){$scope.itemOrderingMemory=$scope.ngModel[$scope.name].map(function(v,i){return i+1})},$scope.redoOrdering(),$scope.newItem=function(){$scope.readOnly||($scope.ngModel[$scope.name].push({}),$scope.redoOrdering())},$scope.moveItem=function(fromIndex,toIndex){Utils.moveTo($scope.ngModel[$scope.name],fromIndex,toIndex,!0),$scope.redoOrdering()},$scope.removeItem=function(index){Utils.removeFrom($scope.ngModel[$scope.name],index),$scope.redoOrdering()}}],link:function(scope,elements,attrs,ctrls){scope.form=ctrls[1],0===scope.ngModel[scope.name].length&&scope.newItem()},require:["ngModel","^^form"],restrict:"E",scope:{name:"@",schema:"=",ngModel:"=",readOnly:"="},templateUrl:CmsConfig.buildComponentPath("dynamic-content","dynamic-content-form","dynamic-content-form-field","dynamic-content-form-field-list","dynamic-content-form-field-list.html")}}]),angular.module("bulbs.cms.dynamicContent.form.field.object",["bulbs.cms.dynamicContent.form.field.boolean","bulbs.cms.dynamicContent.form.field.color","bulbs.cms.dynamicContent.form.field.contentReferences","bulbs.cms.dynamicContent.form.field.dateTime","bulbs.cms.dynamicContent.form.field.image","bulbs.cms.dynamicContent.form.field.list","bulbs.cms.dynamicContent.form.field.integer","bulbs.cms.dynamicContent.form.field.invalid","bulbs.cms.dynamicContent.form.field.richtext","bulbs.cms.dynamicContent.form.field.text","bulbs.cms.dynamicContent.form.input.label","bulbs.cms.dynamicContent.form.types","bulbs.cms.site.config","lodash","uuid4"]).directive("dynamicContentFormFieldObject",["_","$compile","CmsConfig","FIELD_TYPES_META","uuid4",function(_,$compile,CmsConfig,FIELD_TYPES_META,uuid4){return{link:function(scope,element,attrs){var $form=element.find("ng-form");scope.hideLabel="hideLabel"in attrs,scope.$watch("form.$valid",function(isValid){scope.onValidityChange({isValid:isValid,internalForm:scope.form})}),scope.$watch("schema",function(){if(_.has(scope.schema,"fields")){var fieldKeys=Object.keys(scope.schema.fields),includeOnlyProvided=_.isArray(scope.includeOnly),hideOnlyChildLabel=!1;includeOnlyProvided&&(fieldKeys=_.intersection(fieldKeys,scope.includeOnly),1===scope.includeOnly.length&&(hideOnlyChildLabel=!0)),fieldKeys.forEach(function(id){var fieldSchema=scope.schema.fields[id],fieldMeta=FIELD_TYPES_META[fieldSchema.type];_.isUndefined(fieldMeta)&&(fieldMeta=_.has(fieldSchema,"fields")?FIELD_TYPES_META.object:FIELD_TYPES_META.invalid);var tagName=fieldMeta.tagName,html=angular.element("<"+tagName+"></"+tagName+">");html.attr("uuid",uuid4.generate()),html.attr("name",id),html.attr("schema","schema.fields."+id),html.attr("class","dynamic-content-form-field"),hideOnlyChildLabel&&html.attr("hide-label","true"),_.isString(scope.name)?html.attr("ng-model","ngModel[name]"):html.attr("ng-model","ngModel"),$form.append(html),$compile(html)(scope)})}},!0)},require:"ngModel",restrict:"E",scope:{name:"@",schema:"=",ngModel:"=",onValidityChange:"&",includeOnly:"="},templateUrl:CmsConfig.buildComponentPath("dynamic-content","dynamic-content-form","dynamic-content-form-field","dynamic-content-form-field-object","dynamic-content-form-field-object.html")}}]),angular.module("bulbs.cms.dynamicContent.form.field.richtext",["bulbs.cms.site.config","bulbs.cms.dynamicContent.form.input.label","bulbs.cms.dynamicContent.form.input.errors","OnionEditor"]).directive("dynamicContentFormFieldRichtext",["CmsConfig",function(CmsConfig){return{link:function(scope,element,attr,ctrls){scope.formField=ctrls[1][scope.name]},require:["ngModel","^^form"],restrict:"E",scope:{name:"@",ngModel:"=",schema:"="},templateUrl:CmsConfig.buildComponentPath("dynamic-content","dynamic-content-form","dynamic-content-form-field","dynamic-content-form-field-richtext","dynamic-content-form-field-richtext.html")}}]),angular.module("bulbs.cms.dynamicContent.form.field.text",["bulbs.cms.site.config","bulbs.cms.dynamicContent.form.input.label","bulbs.cms.dynamicContent.form.input.errors","jquery"]).directive("dynamicContentFormFieldText",["CmsConfig",function(CmsConfig){return{link:function(scope,element,attr,ctrls){if(scope.formField=ctrls[1][scope.name],scope.schema.max_length>0){var input=element.find("input");input.css("width",scope.schema.max_length+"em"),element.width()<=input.width()&&input.css("width","")}},require:["ngModel","^^form"],restrict:"E",scope:{uuid:"@",name:"@",ngModel:"=",schema:"="},templateUrl:CmsConfig.buildComponentPath("dynamic-content","dynamic-content-form","dynamic-content-form-field","dynamic-content-form-field-text","dynamic-content-form-field-text.html")}}]),angular.module("bulbs.cms.dynamicContent.form.types",[]).constant("FIELD_TYPES_META",{array:{tagName:"dynamic-content-form-field-list"},"boolean":{tagName:"dynamic-content-form-field-boolean"},color:{tagName:"dynamic-content-form-field-color"},content:{tagName:"dynamic-content-form-field-content-references"},datetime:{tagName:"dynamic-content-form-field-date-time"},image:{tagName:"dynamic-content-form-field-image"},invalid:{tagName:"dynamic-content-form-field-invalid"},object:{tagName:"dynamic-content-form-field-object"},richtext:{tagName:"dynamic-content-form-field-richtext"},string:{tagName:"dynamic-content-form-field-text"},integer:{tagName:"dynamic-content-form-field-integer"},slideshow_ids:{tagName:"dynamic-content-form-field-slideshow-ids"}}),angular.module("bulbs.cms.dynamicContent.form",["bulbs.cms.dynamicContent.api","bulbs.cms.dynamicContent.form.field.object","bulbs.cms.site.config","lodash"]).directive("dynamicContentForm",["_","CmsConfig",function(_,CmsConfig){var DynamicContentFormError=BulbsCmsError.build("<dynamic-content>"),template=function(name){return CmsConfig.buildComponentPath("dynamic-content","dynamic-content-form",name)};return{controller:["$scope","DynamicContentApi",function($scope,DynamicContentApi){if(!_.isString($scope.schemaSrc))throw new DynamicContentFormError("must be provided a schema url!");if(!_.isObject($scope.ngModel))throw new DynamicContentFormError("must be provided an object for ng-model!");$scope.template=template("dynamic-content-form-loading.html"),$scope.schema={},$scope.validityCallback=function(isValid){$scope.onValidityChange({isValid:isValid})},DynamicContentApi.retrieveSchema($scope.schemaSrc).then(function(response){$scope.template=template("dynamic-content-form-loaded.html"),$scope.schema=response.data})["catch"](function(){$scope.template=template("dynamic-content-form-error.html"),$scope.errorMessage="Unable to retrieve schema"})}],require:"ngModel",restrict:"E",scope:{schemaSrc:"@",ngModel:"=",onValidityChange:"&",includeOnly:"="},template:'<ng-include src="template"></ng-include>'}}]),angular.module("bulbs.cms.dynamicContent",["bulbs.cms.dynamicContent.form"]),angular.module("bulbs.cms.editor.wrapper",["BettyCropper","bulbs.cms.imageCropModal","bulbs.cms.site.config","jquery","OnionEditor"]).run(["$",function($){$(document).unbind("keydown").bind("keydown",function(event){var doPrevent=!1;if(8===event.keyCode){var d=event.srcElement||event.target;doPrevent=["TEXTAREA","INPUT"].indexOf(-1!==d.tagName.toUpperCase())?d.readOnly||d.disabled:d.isContentEditable?!1:!0}doPrevent&&event.preventDefault()})}]).directive("onionEditor",["$","BettyCropper","CmsConfig","OnionEditor","openImageCropModal","Zencoder",function($,BettyCropper,CmsConfig,OnionEditor,openImageCropModal,Zencoder){var safeApply=function(scope,fn){scope.$$phase||scope.$root.$$phase?fn():scope.$apply(function(){fn()})};return{controller:["$scope",function($scope){$scope.editor=null,this.getEditor=function(){return $scope.editor}}],require:"ngModel",replace:!0,restrict:"E",templateUrl:CmsConfig.buildComponentPath("editor","editor-wrapper","editor-wrapper.html"),scope:{ngModel:"="},link:function(scope,element,attrs,ngModel){function read(){safeApply(scope,function(){var html=scope.editor.getContent();html===defaultValue&&(html=""),ngModel.$setViewValue(html)})}if(ngModel){var formatting;attrs.formatting&&(formatting=attrs.formatting.split(","));var options={},defaultValue="";"multiline"===attrs.role?(defaultValue="<p><br></p>",options={multiline:!0,formatting:formatting||["link","bold","italic","blockquote","heading","list","strike","underline"],placeholder:{text:attrs.placeholder||"<p>Write here</p>",container:$(".editorPlaceholder",element[0])[0]},link:{domain:attrs.linkDomain||!1,searchHandler:window[attrs.linkSearchHandler]||!1},statsContainer:".wordcount",inlineObjects:attrs.inlineObjects||CmsConfig.getInlineObjecsPath(),image:{insertDialog:BettyCropper.upload,editDialog:openImageCropModal},video:{insertDialog:Zencoder.onVideoFileUpload,editDialog:Zencoder.openVideoThumbnailModal,videoEmbedUrl:CmsConfig.buildVideoUrl()}}):($(".document-tools, .embed-tools",element).hide(),defaultValue="",options={multiline:!1,placeholder:{text:attrs.placeholder||"Write here",container:$(".editorPlaceholder",element[0])[0]},formatting:formatting||[]}),scope.editor=new OnionEditor($(".editor",element[0])[0],options),ngModel.$render=function(){scope.editor.setContent(ngModel.$viewValue||defaultValue),setTimeout(function(){scope.editor.setChangeHandler(read)})},ngModel.$isEmpty=function(value){return!value||scope.editor.scribe.allowsBlockElements()&&value===defaultValue},scope.$watch(ngModel,function(){scope.editor.setContent(ngModel.$viewValue||defaultValue),window.picturefill&&window.picturefill(element[0])})}}}}]),angular.module("bulbs.cms.editor",["bulbs.cms.editor.wrapper"]),angular.module("EditorsPick",["bulbs.cms.site.config","customSearch"]).config(function($injector,$routeProvider,CmsConfigProvider){var CmsConfig=$injector.invoke(CmsConfigProvider.$get);$routeProvider.when("/cms/app/sod/",{controller:function($scope,$window){$window.document.title=CmsConfig.getCmsName()+" | SoD",$scope.$watch("queryData",function(){console.log(arguments)}),$scope.queryData={},$scope.updateQueryData=function(){$scope.queryData={groups:[{conditions:[{field:"content-type",type:"all",values:[{name:"for display",value:"actually-use-this-value-123"}]}],time:"1 day"}],included_ids:[1],excluded_ids:[2],pinned_ids:[3],page:1,query:"query balh blah blahb"}},$scope.updateConditionData=function(){$scope.queryData.groups[0].conditions=[{field:"content-type",type:"all",values:[{name:"ANOTHER THIGN",value:"actually-use-this-value-123"}]}]}},templateUrl:CmsConfig.buildComponentPath("editors-pick/editors-pick.html"),reloadOnSearch:!1})}),angular.module("evergreenField.directive",["lodash","saveButton.directive"]).directive("evergreenField",["CmsConfig",function(CmsConfig){return{restrict:"E",scope:{article:"="},templateUrl:CmsConfig.buildComponentPath("evergreen-field/evergreen-field.html")}}]),angular.module("evergreenField",["evergreenField.directive"]),angular.module("filterListWidget.directive",["bulbs.cms.site.config"]).directive("filterListWidget",function(_,$http,$location,$timeout,$,CmsConfig){return{restrict:"E",scope:{filters:"="},templateUrl:CmsConfig.buildComponentPath("filter-list-widget/filter-list-widget.html"),link:function(scope,element,attrs){function getAutocompletes(search){return $timeout.cancel(filterInputTimeout),filterInputCounter=0,search.length<1?(scope.autocompleteArray=[],void scope.$apply()):void $http({url:"/cms/api/v1/things/?type=tag&type=feature_type&type=author",method:"GET",params:{q:search}}).success(function(data){scope.autocompleteArray=data})}function arrowSelect(direction){var $toSelect,$entries=$element.find(".entry"),$selected=$element.find(".entry.selected");$selected.length>0?("up"===direction&&($toSelect=$selected.first().prev()),"down"===direction&&($toSelect=$selected.first().next())):("up"===direction&&($toSelect=$entries.last()),"down"===direction&&($toSelect=$entries.first())),scope.selectEntry($toSelect)}function applyFilterChange(filterObject){filterObject.page=1,$location.search(filterObject),scope.autocompleteArray=[],$input.trigger("blur")}function getFilterObjects(){var search=$location.search();if(scope.filters={},"undefined"==typeof search)return void console.log("undefined");var filterParamsToTypes={authors:"author",tags:"tag",feature_types:"feature_type"};for(var filterParam in filterParamsToTypes){var filterType=filterParamsToTypes[filterParam];"string"==typeof search[filterParam]&&(search[filterParam]=[search[filterParam]]);for(var i in search[filterParam]){var value=search[filterParam][i];scope.filters[filterType+value]={query:value,type:filterParam},getQueryToLabelMappings(filterType,value)}}search.search&&(scope.filterInputValue=search.search)}function getQueryToLabelMappings(type,query){scope.queryToLabelMappings=scope.queryToLabelMappings||{},query in scope.queryToLabelMappings||$http({url:"/cms/api/v1/things/?type="+type,method:"GET",params:{q:query}}).success(function(data){for(var i in data)scope.queryToLabelMappings[data[i].value]=data[i].name})}var $element=$(element),$input=$element.find("input");scope.autocompleteArray=[];var filterInputTimeout,filterInputCounter=0;$input.on("input",function(e){var search=$input.val();scope.searchTerm=search,$timeout.cancel(filterInputTimeout),filterInputTimeout=$timeout(function(){getAutocompletes(search)},200),filterInputCounter>2&&getAutocompletes(search)}),$input.on("keyup",function(e){38===e.keyCode&&arrowSelect("up"),40===e.keyCode&&arrowSelect("down"),13===e.keyCode&&($element.find(".selected").length>0?$timeout(function(){angular.element(".selected > a").triggerHandler("click")},0):scope.addFilter("search",$input.val()))}),scope.search=function(){scope.addFilter("search",scope.filterInputValue)},scope.clearSearch=function(){scope.filterInputValue=""},scope.clearFilters=function(){return scope.filters={},scope.filterInputValue="",applyFilterChange({})},$element.on("mouseover",".entry",function(){scope.selectEntry(this)}),scope.selectEntry=function(entry){$element.find(".selected").removeClass("selected"),$(entry).addClass("selected")},$input.on("blur",function(){$element.find(".dropdown-menu").fadeOut(200)}),$input.on("focus",function(){
$element.find(".dropdown-menu").fadeIn(200)}),scope.addFilter=function(type,newFilterValue){var filterObject=$location.search();return"search"===type?filterObject.search=newFilterValue:(filterObject[type]||(filterObject[type]=[]),"string"==typeof filterObject[type]&&(filterObject[type]=[filterObject[type]]),_.contains(filterObject[type],newFilterValue)||filterObject[type].push(newFilterValue)),applyFilterChange(filterObject)},scope.deleteFilter=function(key){var filterObject=$location.search(),toDelete=scope.filters[key];"string"==typeof filterObject[toDelete.type]&&(filterObject[toDelete.type]=[filterObject[toDelete.type]]);var toSplice;for(var i in filterObject[toDelete.type])if(filterObject[toDelete.type][i]===toDelete.query){toSplice=i;break}return filterObject[toDelete.type].splice(i,1),filterObject.search=$input.val(),delete scope.filters[key],applyFilterChange(filterObject)},scope.$on("$routeUpdate",function(){getFilterObjects()}),getFilterObjects()}}}),angular.module("filterListWidget",["filterListWidget.directive"]),angular.module("filterWidget.directive",["contentServices.listService"]).directive("filterWidget",function(_,$http,$location,$timeout,$,ContentListService,CmsConfig){return{restrict:"E",scope:{},templateUrl:CmsConfig.buildComponentPath("filter-widget/filter-widget.html"),link:function(scope,element,attrs){function getAutocompletes(search){return $timeout.cancel(filterInputTimeout),filterInputCounter=0,search.length<1?(scope.autocompleteArray=[],void scope.$apply()):void $http({url:"/cms/api/v1/things/?type=tag&type=feature_type&type=author",method:"GET",params:{q:search}}).success(function(data){scope.autocompleteArray=data})}function arrowSelect(direction){var $toSelect,$entries=$element.find(".entry"),$selected=$element.find(".entry.selected");$selected.length>0?("up"===direction&&($toSelect=$selected.first().prev()),"down"===direction&&($toSelect=$selected.first().next())):("up"===direction&&($toSelect=$entries.last()),"down"===direction&&($toSelect=$entries.first())),scope.selectEntry($toSelect)}function applyFilterChange(filterObject){return filterObject.page=1,$location.search(filterObject),scope.autocompleteArray=[],$input.trigger("blur"),ContentListService.$updateContent(filterObject)}function getFilterObjects(){var search=$location.search();if(scope.filterObjects={},"undefined"==typeof search)return void console.log("undefined");var filterParamsToTypes={authors:"author",tags:"tag",feature_types:"feature_type"};for(var filterParam in filterParamsToTypes){var filterType=filterParamsToTypes[filterParam];"string"==typeof search[filterParam]&&(search[filterParam]=[search[filterParam]]);for(var i in search[filterParam]){var value=search[filterParam][i];scope.filterObjects[filterType+value]={query:value,type:filterParam},getQueryToLabelMappings(filterType,value)}}search.search&&(scope.filterInputValue=search.search)}function getQueryToLabelMappings(type,query){scope.queryToLabelMappings=scope.queryToLabelMappings||{},query in scope.queryToLabelMappings||$http({url:"/cms/api/v1/things/?type="+type,method:"GET",params:{q:query}}).success(function(data){for(var i in data)scope.queryToLabelMappings[data[i].value]=data[i].name})}var $element=$(element),$input=$element.find("input");scope.autocompleteArray=[];var filterInputTimeout,filterInputCounter=0;$input.on("input",function(e){var search=$input.val();scope.searchTerm=search,$timeout.cancel(filterInputTimeout),filterInputTimeout=$timeout(function(){getAutocompletes(search)},200),filterInputCounter>2&&getAutocompletes(search)}),$input.on("keyup",function(e){38===e.keyCode&&arrowSelect("up"),40===e.keyCode&&arrowSelect("down"),13===e.keyCode&&($element.find(".selected").length>0?$timeout(function(){angular.element(".selected > a").triggerHandler("click")},0):scope.addFilter("search",$input.val()))}),scope.search=function(){scope.addFilter("search",scope.filterInputValue)},scope.clearSearch=function(){scope.filterInputValue=""},scope.clearFilters=function(){return scope.filterObjects={},scope.filterInputValue="",applyFilterChange({})},$element.on("mouseover",".entry",function(){scope.selectEntry(this)}),scope.selectEntry=function(entry){$element.find(".selected").removeClass("selected"),$(entry).addClass("selected")},$input.on("blur",function(){$element.find(".dropdown-menu").fadeOut(200)}),$input.on("focus",function(){$element.find(".dropdown-menu").fadeIn(200)}),scope.addFilter=function(type,newFilterValue){var filterObject=$location.search();return"search"===type?filterObject.search=newFilterValue:(filterObject[type]||(filterObject[type]=[]),"string"==typeof filterObject[type]&&(filterObject[type]=[filterObject[type]]),_.contains(filterObject[type],newFilterValue)||filterObject[type].push(newFilterValue)),applyFilterChange(filterObject)},scope.deleteFilter=function(key){var filterObject=$location.search(),toDelete=scope.filterObjects[key];"string"==typeof filterObject[toDelete.type]&&(filterObject[toDelete.type]=[filterObject[toDelete.type]]);var toSplice;for(var i in filterObject[toDelete.type])if(filterObject[toDelete.type][i]===toDelete.query){toSplice=i;break}return filterObject[toDelete.type].splice(i,1),filterObject.search=$input.val(),delete scope.filterObjects[key],applyFilterChange(filterObject)},scope.$on("$routeUpdate",function(){getFilterObjects()}),getFilterObjects()}}}),angular.module("filterWidget",["filterWidget.directive"]),angular.module("genericAjaxButton.controller",[]).controller("GenericAjaxButtonController",function($scope){$scope.STATES={DONE:"done",PROGRESS:"in-progress",ERROR:"error"},$scope.doClick=function(){$scope.state=$scope.STATES.PROGRESS,$scope.clickFunction().then(function(){$scope.state=$scope.STATES.DONE})["catch"](function(){$scope.state=$scope.STATES.ERROR})}}),angular.module("genericAjaxButton.directive",["bulbs.cms.site.config","genericAjaxButton.controller"]).directive("genericAjaxButton",function(CmsConfig){return{controller:"GenericAjaxButtonController",restrict:"E",scope:{disableWhen:"&",clickFunction:"=",cssBtnClassComplete:"@",cssBtnClassError:"@",cssBtnClassProgress:"@",cssIconComplete:"@",textError:"@",textProgress:"@",textComplete:"@"},templateUrl:CmsConfig.buildComponentPath("generic-ajax-button/generic-ajax-button.html")}}),angular.module("genericAjaxButton",["genericAjaxButton.directive"]),angular.module("saveButton.directive",["bulbs.cms.site.config","genericAjaxButton"]).directive("saveButton",function(CmsConfig){return{controller:"GenericAjaxButtonController",link:{pre:function(scope){scope.cssIconComplete="glyphicon-floppy-disk",scope.textProgress="Saving...",scope.textComplete="Save"}},restrict:"E",scope:{disableWhen:"&",clickFunction:"="},templateUrl:CmsConfig.buildComponentPath("generic-ajax-button/generic-ajax-button.html")}}),angular.module("hideFromRssField.directive",["bulbs.cms.site.config"]).directive("hideFromRssField",["CmsConfig",function(CmsConfig){return{restrict:"E",scope:{article:"="},templateUrl:CmsConfig.buildComponentPath("hide-from-rss-field","hide-from-rss-field.html")}}]),angular.module("hideFromRssField",["hideFromRssField.directive"]),angular.module("bulbs.cms.imageCropModal.controller",["BettyCropper","jquery","ui.bootstrap.modal"]).controller("ImageCropModalCtrl",["$","$modalInstance","$scope","$timeout","BettyCropper","Selection","imageData","ratios",function($,$modalInstance,$scope,$timeout,BettyCropper,Selection,imageData,ratios){$scope.selectedCrop=null,$scope.cropMode=!1,$scope.ratios=ratios,$scope.finished=!1,$scope.thumb_container_styles={},$scope.imageData=imageData,$scope.image||($scope.image=null,BettyCropper.get(imageData.id).then(function(success){$scope.image=success.data})),$scope.$watch("image",function(image){if(image){var finished=!0;for(var ratio in image.selections)if("auto"===image.selections[ratio].source){finished=!1;break}$scope.finished=finished,$scope.scaleData=image.scaleToFit(550,400),angular.element(".crop-image-container img").one("load",function(){$(this).Jcrop({allowSelect:!1,allowMove:!0,allowResize:!0,keySupport:!1},function(){$scope.jcrop_api=this})}),$scope.image_url=image.url("original",1200,"jpg"),$scope.ratios||($scope.ratios=Object.keys(image.selections)),$scope.setThumbStyles()}}),$scope.$watch("selectedCrop",function(crop){if($scope.image){var finished=!0;for(var ratio in $scope.image.selections)if("auto"===$scope.image.selections[ratio].source&&ratio!==crop){finished=!1;break}$scope.finished=finished}}),$scope.selectCrop=function(ratio){if(!ratio){ratio=Object.keys($scope.image.selections)[0];for(var key in $scope.image.selections)if("auto"===$scope.image.selections[key].source){ratio=key;break}}var selection=$scope.image.selections[ratio].scaleBy($scope.scaleData.scale);$scope.jcrop_api&&($scope.jcrop_api.setOptions({aspectRatio:selection.width()/selection.height()}),$scope.jcrop_api.setSelect([selection.x0,selection.y0,selection.x1,selection.y1])),$scope.cropMode=!0,$scope.selectedCrop=ratio},$scope.setThumbStyles=function(){$scope.thumb_styles=$scope.thumb_styles||{};for(var ratio in $scope.image.selections){var scaledSelection=$scope.image.selections[ratio].scaleToFit(170,170);$scope.thumb_container_styles[ratio]={"padding-top":Math.round((180-scaledSelection.height())/2)+"px","padding-bottom":"5px","padding-left":Math.round((180-scaledSelection.width())/2)+"px","padding-right":"5px"},$scope.thumb_styles[ratio]=$scope.image.getStyles(170,170,ratio)}},$scope.save=function(ratio){var jcrop_selection=$scope.jcrop_api.tellSelect(),newSelection=new Selection({x0:jcrop_selection.x,x1:jcrop_selection.x2,y0:jcrop_selection.y,y1:jcrop_selection.y2,source:"user"});return newSelection=newSelection.scaleBy(1/$scope.scaleData.scale),newSelection.x1>$scope.image.width&&(newSelection.x1=$scope.image.width),newSelection.y1>$scope.image.height&&(newSelection.y1=$scope.image.height),this.image.updateSelection(ratio,newSelection)},$scope.saveAndQuit=function(){var ratio=$scope.selectedCrop;this.save(ratio).then(function(success){var ratio=success.data[0],selection=success.data[1];$scope.image.selections[ratio]=selection}),$scope.cropMode=!1,$modalInstance.close(imageData)},$scope.saveAndNext=function(){var ratio=$scope.selectedCrop;this.save(ratio).then(function(success){var ratio=success.data[0],selection=success.data[1];$scope.image.selections[ratio]=selection;var nextRatioIndex=($scope.ratios.indexOf(ratio)+1)%$scope.ratios.length;$scope.selectCrop($scope.ratios[nextRatioIndex])})}}]),angular.module("bulbs.cms.imageCropModal",["bulbs.cms.imageCropModal.controller","bulbs.cms.site.config","ui.bootstrap.modal"]).factory("openImageCropModal",["$modal","CmsConfig",function($modal,CmsConfig){return function(imageData,ratios){return $modal.open({templateUrl:CmsConfig.buildComponentPath("image-crop-modal","image-crop-modal.html"),controller:"ImageCropModalCtrl",resolve:{imageData:function(){return imageData},ratios:function(){return ratios||!1}},backdrop:"static"}).result}}]),angular.module("bulbs.cms.liveBlog.api",["bulbs.cms.site.config","bulbs.cms.utils","lodash","moment"]).service("LiveBlogApi",["_","$http","CmsConfig","moment","Utils",function(_,$http,CmsConfig,moment,Utils){var liveBlogEndpoint=CmsConfig.buildApiUrlRoot.bind(null,"liveblog"),liveBlogEntryEndpoint=liveBlogEndpoint.bind(null,"entry"),liveBlogEntryResponseEndpoint=function(entryId){return liveBlogEntryEndpoint.bind(null,entryId,"responses")},parseEntryPayload=function(payload){var data=_.chain(payload).cloneDeep().mapKeys(function(value,key){return Utils.toCamelCase(key)}).value();return payload.published&&(data.published=moment.tz(payload.published,CmsConfig.getTimezoneName())),payload.created&&(data.created=moment.tz(payload.created,CmsConfig.getTimezoneName())),payload.updated&&(data.updated=moment.tz(payload.updated,CmsConfig.getTimezoneName())),data},cleanEntryData=function(data){var payload=_.chain(data).omit("published").cloneDeep().mapKeys(function(value,key){return Utils.toSnakeCase(key)}).value();return data.published&&(payload.published=data.published.format()),data.created&&(payload.created=data.created.format()),data.updated&&(payload.updated=data.updated.format()),payload},parseEntryResponsePayload=function(payload){var data=_.chain(payload).cloneDeep().mapValues(function(value,key){return _.includes(["created","last_modified"],key)?moment.tz(value,CmsConfig.getTimezoneName()):value}).mapKeys(function(value,key){return Utils.toCamelCase(key)}).value();return data},cleanEntryResponseData=function(data){var payload=_.chain(data).mapValues(function(value){return moment.isMoment(value)?value.format():value}).cloneDeep().mapKeys(function(value,key){return Utils.toSnakeCase(key)}).value();return payload};return{createEntry:function(data){var payload=cleanEntryData(data);return $http.post(liveBlogEntryEndpoint("/"),payload).then(function(response){return parseEntryPayload(response.data)})},updateEntry:function(entry){var payload=cleanEntryData(entry);return $http.put(liveBlogEntryEndpoint(payload.id,"/"),payload).then(function(response){return parseEntryPayload(response.data)})},deleteEntry:function(entry){return $http["delete"](liveBlogEntryEndpoint(entry.id,"/"))},getEntries:function(parentId){var params;return parentId&&(params=Utils.param({liveblog:parentId})),$http.get(liveBlogEntryEndpoint("/",params)).then(function(response){return{results:response.data.results.map(function(result){return parseEntryPayload(result)})}})},createEntryResponse:function(entry,data){var payload=cleanEntryResponseData(data);return $http.post(liveBlogEntryResponseEndpoint(entry.id)("/"),payload).then(function(response){return parseEntryResponsePayload(response.data)})},updateEntryResponse:function(entryResponse){var payload=cleanEntryResponseData(entryResponse);return $http.put(liveBlogEntryResponseEndpoint(entryResponse.entry)(entryResponse.id,"/"),payload).then(function(response){return parseEntryResponsePayload(response.data)})},deleteEntryResponse:function(entryResponse){return $http["delete"](liveBlogEntryResponseEndpoint(entryResponse.entry)(entryResponse.id,"/"))},getEntryResponses:function(entryId){return $http.get(liveBlogEntryResponseEndpoint(entryId)("/")).then(function(response){return{results:response.data.results.map(function(result){return parseEntryResponsePayload(result)})}})}}}]),angular.module("bulbs.cms.liveBlog.entries.authorBridge",["bulbs.cms.site.config"]).directive("liveBlogEntriesAuthorBridge",["$compile","CmsConfig",function($compile,CmsConfig){return{link:function(scope,element){var name=CmsConfig.getLiveBlogAuthorSelectorDirectiveName();if(scope.authors=scope.ngModel,name){var html=angular.element("<"+name+' ng-model="authors"></'+name+">");element.find("> div").html($compile(html)(scope))}scope.$watch("authors",function(newValue,oldValue){angular.equals(newValue,oldValue)||(scope.onUpdate({newValue:newValue}),scope.ngModel=newValue)},!0)},restrict:"E",scope:{ngModel:"=",onUpdate:"&"},template:'<div><i class="fa fa-exclamation-triangle"></i> <span>No live blog author selector has been configured!</span></div>'}}]),angular.module("bulbs.cms.liveBlog.entries",["OnionEditor","Raven","bulbs.cms.currentUser","bulbs.cms.dateTimeFilter","bulbs.cms.dateTimeModal","bulbs.cms.dateTimeModal","bulbs.cms.liveBlog.api","bulbs.cms.liveBlog.entries.authorBridge","bulbs.cms.liveBlog.responses","bulbs.cms.recircChooser","bulbs.cms.site.config","bulbs.cms.user.nameDisplayFilter","bulbs.cms.utils","confirmationModal","jquery"]).directive("liveBlogEntries",["$","$compile","$q","CmsConfig","CurrentUserApi","LiveBlogApi","Raven","Utils",function($,$compile,$q,CmsConfig,CurrentUserApi,LiveBlogApi,Raven,Utils){return{link:function(scope,element){var reportError=function(message,data){Raven.captureMessage(message,data),scope.errorMessage=message},titleDisplay=function(entry){return entry.headline?'"'+entry.headline+'"':"an entry"},recirc=scope.article.recirc_query;angular.isUndefined(recirc.included_ids)&&(recirc.included_ids=[]),scope.clearError=function(){scope.errorMessage=""},LiveBlogApi.getEntries(scope.article.id).then(function(response){scope.entries=response.results})["catch"](function(response){var message="An error occurred retrieving entries!";reportError(message,{response:response})});var panelOpen={};scope.isPanelOpen=function(entry){return angular.isUndefined(panelOpen[entry.id])&&(panelOpen[entry.id]=!0),panelOpen[entry.id]},scope.togglePanel=function(entry){panelOpen[entry.id]=!panelOpen[entry.id]},scope.collapseAll=function(){scope.entries.forEach(function(entry){panelOpen[entry.id]=!1})},scope.expandAll=function(){scope.entries.forEach(function(entry){panelOpen[entry.id]=!0})};var entryForm="entryForm_";scope.wrapperForm={},scope.makeEntryFormName=function(entry){return entryForm+entry.id},scope.getEntryForm=function(entry){var name=scope.makeEntryFormName(entry);return scope.wrapperForm[name]?scope.wrapperForm[name]:(scope.wrapperForm[name]={},scope.wrapperForm[name])},scope.isEntryFormSaveDisabled=function(entry){return scope.transactionsLocked()||scope.getEntryForm(entry).$pristine};var lock=Utils.buildLock();scope.transactionsLocked=lock.isLocked,scope.addEntry=lock(function(){return CurrentUserApi.getCurrentUserWithCache().then(function(user){var now=moment();return LiveBlogApi.createEntry({liveblog:scope.article.id,createdBy:user,created:now,updatedBy:user,updated:now,recircContent:[]}).then(function(entry){scope.entries.unshift(entry)})["catch"](function(response){var message="An error occurred attempting to add an entry!";reportError(message,{response:response})})})}),scope.saveEntry=lock(function(entry){return CurrentUserApi.getCurrentUserWithCache().then(function(user){var oldUpdateBy=entry.updatedBy,oldUpdated=entry.updated;return entry.updatedBy=user,entry.updated=moment(),LiveBlogApi.updateEntry(entry).then(function(){scope.getEntryForm(entry).$setPristine()})["catch"](function(response){entry.updatedBy=oldUpdateBy,entry.updated=oldUpdated;var message="An error occurred attempting to save "+titleDisplay(entry)+"!";return reportError(message,{response:response}),$q.reject()})})}),scope.publishAndSave=function(entry,newDate){var oldDate=entry.published;return entry.published=newDate,scope.saveEntry(entry).then(function(){scope.entries.sort(function(entry1,entry2){var entry1IsMoment=moment.isMoment(entry1.published),entry2IsMoment=moment.isMoment(entry2.published);return!entry1IsMoment||entry2IsMoment&&!entry1.published.isBefore(entry2.published)?!entry2IsMoment||entry1IsMoment&&!entry2.published.isBefore(entry1.published)?0:-1:1})})["catch"](function(){return entry.published=oldDate,!1})},scope.deleteEntry=lock(function(entry){return LiveBlogApi.deleteEntry(entry).then(function(){var index=scope.entries.indexOf(entry);Utils.removeFrom(scope.entries,index)})["catch"](function(response){var message="An error occurred attempting to delete "+titleDisplay(entry)+"!";reportError(message,{response:response})})}),scope.jumpToTop=function(){$(document).scrollTop(element.find(".live-blog-entries-header").offset().top-50)};var stickyClass="live-blog-entries-jump-to-top-fixed";$(document).on("scroll",function(){var offsetTop=element.find(".live-blog-entries-header").offset().top,windowTop=$(window).scrollTop(),inThreshold=windowTop-offsetTop>500,jumpButton=element.find(".live-blog-entries-jump-to-top"),alreadyHasClass=jumpButton.hasClass(stickyClass);inThreshold&&!alreadyHasClass?jumpButton.addClass(stickyClass):!inThreshold&&alreadyHasClass&&jumpButton.removeClass(stickyClass)})},restrict:"E",scope:{article:"="},templateUrl:CmsConfig.buildComponentPath("live-blog","live-blog-entries","live-blog-entries.html")}}]),angular.module("bulbs.cms.liveBlog.responses",["OnionEditor","bulbs.cms.currentUser","bulbs.cms.liveBlog.api","bulbs.cms.site.config","bulbs.cms.user.nameDisplayFilter","bulbs.cms.utils","confirmationModal","lodash"]).directive("liveBlogResponses",["_","$q","CmsConfig","CurrentUserApi","LiveBlogApi","Raven","Utils",function(_,$q,CmsConfig,CurrentUserApi,LiveBlogApi,Raven,Utils){return{link:function(scope,element){var reportError=function(message,data){Raven.captureMessage(message,data),scope.errorMessage=message};scope.clearError=function(){scope.errorMessage=""},LiveBlogApi.getEntryResponses(scope.entry.id).then(function(response){scope.entryResponses=response.results})["catch"](function(response){var message="An error occurred retrieving responses for entry with id "+scope.entry.id+"!";reportError(message,{response:response})});var panelOpen={};scope.isPanelOpen=function(entryResponse){return angular.isUndefined(panelOpen[entryResponse.id])&&(panelOpen[entryResponse.id]=!0),panelOpen[entryResponse.id]},scope.togglePanel=function(entryResponse){panelOpen[entryResponse.id]=!panelOpen[entryResponse.id]},scope.collapseAll=function(){scope.entryResponses.forEach(function(entryResponse){panelOpen[entryResponse.id]=!1})},scope.expandAll=function(){scope.entryResponses.forEach(function(entryResponse){panelOpen[entryResponse.id]=!0})};var responseForm="responseForm_";scope.wrapperForm={},scope.makeEntryResponseFormName=function(entryResponse){return responseForm+entryResponse.id},scope.getEntryResponseForm=function(entryResponse){var name=scope.makeEntryResponseFormName(entryResponse);return scope.wrapperForm[name]?scope.wrapperForm[name]:(scope.wrapperForm[name]={},scope.wrapperForm[name])},scope.isEntryResponseFormSaveDisabled=function(entryResponse){return scope.transactionsLocked()||scope.getEntryResponseForm(entryResponse).$pristine};var lock=Utils.buildLock();scope.transactionsLocked=lock.isLocked,scope.addEntryResponse=lock(function(entry,newData){return CurrentUserApi.getCurrentUserWithCache().then(function(user){var now=moment(),newDataPayload=_.assign({entry:entry.id,createdBy:user,created:now,updatedBy:user,updated:now},newData);return LiveBlogApi.createEntryResponse(entry,newDataPayload).then(function(entryResponse){scope.entryResponses.push(entryResponse)})["catch"](function(response){var message="An error occurred attempting to add a response for entry with id "+scope.entry.id+"!";reportError(message,{response:response})})})}),scope.copyEntryResponse=function(entry,entryResponseToCopy){var newData=_.omit(entryResponseToCopy,"id");return newData.internalName=entryResponseToCopy.internalName||"(copy)",newData.published=!1,scope.addEntryResponse(entry,newData)},scope.saveEntryResponse=lock(function(entryResponse){return CurrentUserApi.getCurrentUserWithCache().then(function(user){var oldUpdateBy=entryResponse.updatedBy,oldUpdated=entryResponse.updated;return entryResponse.updatedBy=user,entryResponse.updated=moment(),LiveBlogApi.updateEntryResponse(entryResponse).then(function(){scope.getEntryResponseForm(entryResponse).$setPristine()})["catch"](function(response){entryResponse.updatedBy=oldUpdateBy,entryResponse.updated=oldUpdated;var message="An error occurred attempting to save response with id "+entryResponse.id+" for entry with id "+scope.entry.id+"!";return reportError(message,{response:response}),$q.reject()})})}),scope.publishAndSaveEntryResponse=function(entryResponse){var wasPublished=!!entryResponse.published;return entryResponse.published=!wasPublished,scope.saveEntryResponse(entryResponse)["catch"](function(){return entryResponse.published=wasPublished,!1})},scope.deleteEntryResponse=lock(function(entryResponse){return LiveBlogApi.deleteEntryResponse(entryResponse).then(function(){var index=scope.entryResponses.indexOf(entryResponse);Utils.removeFrom(scope.entryResponses,index)})["catch"](function(response){var message="An error ocurred attempting to delete response with id "+entryResponse.id+" for entry with id "+scope.entry.id+"!";reportError(message,{response:response})})})},restrict:"E",scope:{entry:"="},templateUrl:CmsConfig.buildComponentPath("live-blog","live-blog-responses","live-blog-responses.html")}}]),angular.module("bulbs.cms.liveBlog",["bulbs.cms.liveBlog.entries"]),angular.module("notifications.edit.directive",["apiServices.notification.factory","BettyCropper","bulbs.cms.site.config","copyButton","customSearch","lodash","saveButton.directive","notifications.settings","topBar"]).directive("notificationsEdit",function(CmsConfig){return{controller:function(_,$location,$q,$scope,NOTIFICATIONS_LIST_REL_PATH,Notification){$scope.LIST_URL=CmsConfig.buildExternalUrl(NOTIFICATIONS_LIST_REL_PATH),$scope.needsSave=!1;var modelId=$scope.getModelId();"new"===modelId?($scope.model=Notification.$build(),$scope.isNew=!0):$scope.model=Notification.$find($scope.getModelId()),window.onbeforeunload=function(e){return!_.isEmpty($scope.model.$dirty())||$scope.isNew||$scope.needsSave?"You have unsaved changes.":void 0},$scope.$on("$destroy",function(){delete window.onbeforeunload}),$scope.saveModel=function(){var promise;if($scope.model)promise=$scope.model.$save().$asPromise().then(function(data){"new"===modelId&&$location.path("/cms/app/notification/edit/"+data.id+"/"),$scope.isNew=!1,$scope.needsSave=!1});else{var deferred=$q.defer();deferred.reject(),promise=deferred.promise}return promise}},restrict:"E",scope:{getModelId:"&modelId"},templateUrl:CmsConfig.buildComponentPath("notifications/notifications-edit/notifications-edit.html")}}),angular.module("notifications.edit",["bulbs.cms.site.config","notifications.edit.directive"]).config(function($routeProvider){$routeProvider.when("/cms/app/notifications/edit/:id/",{controller:function($routeParams,$scope,$window,CmsConfig){$window.document.title=CmsConfig.getCmsName()+" | Edit Notification",$scope.routeId=$routeParams.id},template:'<notifications-edit model-id="routeId"></notifications-edit>',reloadOnSearch:!1})}),angular.module("notifications.list",["apiServices.notification.factory","bulbs.cms.site.config","listPage","moment","notifications.settings"]).config(function($injector,$routeProvider,CmsConfigProvider){var CmsConfig=$injector.invoke(CmsConfigProvider.$get);$routeProvider.when("/cms/app/notifications/",{controller:function($scope,$window,NOTIFICATIONS_LIST_REL_PATH,Notification){$window.document.title=CmsConfig.getCmsName()+" | Notification",$scope.modelFactory=Notification,$scope.LIST_URL=CmsConfig.buildExternalUrl(NOTIFICATIONS_LIST_REL_PATH)},templateUrl:CmsConfig.buildComponentPath("notifications/notifications-list/notifications-list-page.html")})}),angular.module("notifications.settings",[]).value("NOTIFICATIONS_LIST_REL_PATH","/notification/"),angular.module("notifications",["notifications.list","notifications.edit"]),angular.module("polls.edit.directive",["apiServices.answer.factory","apiServices.poll.factory","BettyCropper","bulbs.cms.site.config","lodash","saveButton.directive","topBar"]).constant("RESPONSE_TYPES",[{name:"Text Only",value:"Text"},{name:"Image + Text",value:"Image"}]).directive("pollsEdit",function(CmsConfig){return{templateUrl:CmsConfig.buildComponentPath("polls/polls-edit/polls-edit.html"),controller:function(_,$http,$location,$q,$routeParams,$scope,$timeout,Answer,Poll){"new"===$routeParams.id?($scope.model={},$scope.isNew=!0):Poll.getPoll($routeParams.id).then(function(response){$scope.model=response,$scope.answers=_.cloneDeep(response.answers)}),window.onbeforeunload=function(e){return!_.isEmpty($scope.model.$dirty())||$scope.isNew||$scope.needsSave?"You have unsaved changes.":void 0},$scope.$on("$destroy",function(){delete window.onbeforeunload}),$scope.embedCode=function(){return'<bulbs-poll src="/poll/'+$scope.model.id+'/merged.json"></bulbs-poll>'},$scope.validatePublication=function(){$timeout(function(){var published=$scope.model.published,endDate=$scope.model.end_date,publishedField=$scope.pollForm.published,endDateField=$scope.pollForm.endDate;publishedField.$setValidity("requiredWithEndDate",!(endDate&&!published));var comesAfterPublishedValid=!0;endDate&&published&&(comesAfterPublishedValid=published.isBefore(endDate)),endDateField.$setValidity("comesAfterPublished",comesAfterPublishedValid)})},$scope.saveModel=function(){return $scope.model?$scope.isNew?Poll.postPoll($scope.model).then(function(data){var answerPromise=_.map($scope.answers,function(answer){return Answer.postAnswer(answer,data.id)});return $q.all(answerPromise).then(function(){$location.path("/cms/app/polls/edit/"+data.id+"/")})}):(Answer.updatePollAnswers($scope),$scope.deletedAnswers=[],Poll.updatePoll($scope.model)):$q.reject("Save failed")},$scope.deletedAnswers=[];var newId=$scope.answers?$scope.answers.length:0;$scope.addAnswer=function(){$scope.answers.push({id:newId++,notOnSodahead:!0})},$scope.isNew&&($scope.answers=[],_.times(3,$scope.addAnswer)),$scope.removeAnswer=function(answerId){var deletedAnswer=_.remove($scope.answers,function(a){return a.id===answerId});deletedAnswer[0].notOnSodahead||$scope.deletedAnswers.push(deletedAnswer[0])}},restrict:"E",scope:{getModelId:"&modelId"}}}),angular.module("polls.edit",["bulbs.cms.site.config","polls.edit.directive"]).config(function($routeProvider){$routeProvider.when("/cms/app/polls/edit/:id/",{controller:function($routeParams,$scope,$window,CmsConfig){$window.document.title=CmsConfig.getCmsName()+" | Edit Poll",$scope.routeId=$routeParams.id},template:'<polls-edit model-id="routeId"></polls-edit>',reloadOnSearch:!1})}),angular.module("polls.list",["apiServices.poll.factory","bulbs.cms.site.config","bulbsCmsApp.nonRestmodListPage","moment"]).config(function($injector,$routeProvider,CmsConfigProvider){var CmsConfig=$injector.invoke(CmsConfigProvider.$get);$routeProvider.when("/cms/app/polls/",{controller:function($scope,$window,Poll){$window.document.title=CmsConfig.getCmsName()+" | Poll",$scope.modelFactory=Poll},templateUrl:CmsConfig.buildComponentPath("polls/polls-list/polls-list-page.html")})}),angular.module("polls",["polls.list","polls.edit"]),angular.module("promotedContentArticle.directive",["bulbs.cms.site.config"]).directive("promotedContentArticle",function(CmsConfig){return{restrict:"E",scope:{article:"="},templateUrl:CmsConfig.buildComponentPath("promoted-content/promoted-content-article/promoted-content-article.html")}}),angular.module("promotedContentArticle",["promotedContentArticle.directive"]),angular.module("promotedContentList.directive",["bulbs.cms.site.config","promotedContentArticle","promotedContentSave","ui.sortable"]).directive("promotedContentList",function($,CmsConfig){return{controller:function($scope,PromotedContentService){$scope.pzoneData=PromotedContentService.getData(),$scope.moveUp=function(index){PromotedContentService.moveContentUp(index)},$scope.moveDown=function(index){PromotedContentService.moveContentDn(index)},$scope.remove=function(article){PromotedContentService.$removeContentFromPZone(article.id)},$scope.completeAction=function(index){PromotedContentService.$completeContentAction(index)},$scope.stopAction=function(){PromotedContentService.stopContentAction()},$scope.markDirty=function(){PromotedContentService.markDirtySelectedPZone()},$scope.disableControls=function(){return PromotedContentService.isPZoneRefreshPending()}},link:function(scope,element,attr){scope.sortableOptions={beforeStop:function(e,ui){ui.helper.css("margin-top",0),ui.item.parent().removeClass("ui-sortable-dragging")},cancel:".ui-sortable-unsortable",change:function(e,ui){ui.helper.css("margin-top",$(window).scrollTop())},containment:"promoted-content-list",distance:3,opacity:.75,placeholder:"dropzone",start:function(e,ui){ui.item.parent().addClass("ui-sortable-dragging"),ui.helper.css("margin-top",$(window).scrollTop())},stop:function(){scope.markDirty()}}},restrict:"E",scope:{},templateUrl:CmsConfig.buildComponentPath("promoted-content/promoted-content-list/promoted-content-list.html")}}),angular.module("promotedContentList",["promotedContentList.directive"]),angular.module("promotedContentOperationsList.directive",["bulbs.cms.site.config","promotedContent.service"]).directive("promotedContentOperationsList",function(_,CmsConfig,moment){return{controller:function(moment,$scope,PromotedContentService){$scope.pzoneData=PromotedContentService.getData(),$scope.scheduleDateFrom=moment(),
$scope.scheduleDateTo=moment().add(3,"days"),$scope.deleteStatus={message:"",isError:!1},PromotedContentService.$ready().then(function(){$scope.aggregatedOperations=$scope.pzoneData.operations.concat($scope.pzoneData.unsavedOperations)}),$scope.removeOperation=function(operation){PromotedContentService.$removeOperation(operation.id).then(function(){$scope.deleteStatus={message:"Operation successfully removed!",isError:!1}})["catch"](function(err){$scope.deleteStatus={message:err,isError:!0}})},$scope.clearDeleteStatus=function(){$scope.deleteStatus.message=""},$scope.setPreviewTime=function(time){PromotedContentService.setPreviewTime(time.add(1,"minute"))},$scope.disableControls=function(){return PromotedContentService.isPZoneRefreshPending()},$scope.operationsStale=function(){return PromotedContentService.isPZoneOperationsStale()},$scope.refreshingOperations=!1,$scope.refreshOperations=function(){$scope.refreshingOperations||($scope.refreshingOperations=!0,PromotedContentService.$refreshOperations({from:$scope.scheduleDateFrom.toISOString(),to:$scope.scheduleDateTo.toISOString()})["finally"](function(){$scope.refreshingOperations=!1}))}},link:function(scope,element,attr){var operationTime=function(operation){var compTime;return compTime=operation.whenAsMoment?operation.whenAsMoment:scope.pzoneData.previewTime?scope.pzoneData.previewTime:moment()};scope.aggregatedOperations={},scope.groupDateFormat="M/D/YY @ h:mma";var aggregator=function(){var tempAggregate=scope.pzoneData.operations.concat(scope.pzoneData.unsavedOperations);scope.aggregatedOperations=_.chain(tempAggregate).sortBy(operationTime).groupBy(function(operation){return operationTime(operation).format(scope.groupDateFormat)}).pairs().map(function(pair){return[moment(pair[0],scope.groupDateFormat),pair[1]]}).sortBy(function(pair){return pair[0]}).value()};scope.$watchCollection("pzoneData.operations",aggregator),scope.$watchCollection("pzoneData.unsavedOperations",aggregator)},restrict:"E",scope:{},templateUrl:CmsConfig.buildComponentPath("promoted-content/promoted-content-operations-list/promoted-content-operations-list.html")}}),angular.module("promotedContentOperationsList",["promotedContentOperationsList.directive"]),angular.module("promotedContentPzoneSelect.directive",["bulbs.cms.site.config","promotedContent.service"]).directive("promotedContentPzoneSelect",function(CmsConfig){return{controller:function($scope,PromotedContentService){$scope.pzoneData=PromotedContentService.getData(),$scope.selectedPZoneName="",PromotedContentService.$ready().then(function(){$scope.selectedPZoneName=$scope.pzoneData.selectedPZone.name}),$scope.changePZone=function(name){!function(name){PromotedContentService.$refreshPZones().then(function(){PromotedContentService.$selectPZone(name)})}(name)},$scope.disableControls=function(){return PromotedContentService.isPZoneRefreshPending()}},restrict:"E",scope:{},templateUrl:CmsConfig.buildComponentPath("promoted-content/promoted-content-pzone-select/promoted-content-pzone-select.html")}}),angular.module("promotedContentPzoneSelect",["promotedContentPzoneSelect.directive"]),angular.module("promotedContentSave.directive",["bulbs.cms.site.config","promotedContent.service"]).directive("promotedContentSave",function(CmsConfig){return{controller:function($scope,PromotedContentService){$scope.pzoneData=PromotedContentService.getData(),$scope.savePZone=function(){PromotedContentService.$saveSelectedPZone()},$scope.clearOperations=function(){PromotedContentService.clearUnsavedOperations(),PromotedContentService.$refreshSelectedPZone($scope.pzoneData.previewTime)},$scope.disableControls=function(){return PromotedContentService.isPZoneRefreshPending()}},restrict:"E",scope:{},templateUrl:CmsConfig.buildComponentPath("promoted-content/promoted-content-save/promoted-content-save.html")}}),angular.module("promotedContentSave",["promotedContentSave.directive"]),angular.module("promotedContentSearch.directive",["bulbs.cms.site.config","statusFilter","filterWidget","promotedContent.service","promotedContentArticle"]).directive("promotedContentSearch",function(CmsConfig){return{controller:function(_,moment,$scope,$location,PromotedContentService){$scope.pzoneData=PromotedContentService.getData(),$scope.pageNumber=$location.search().page||"1",$scope.goToPage=function(){PromotedContentService.$refreshAllContent({page:$scope.pageNumber},!0)},$scope.contentIsEnabled=function(content){var notAlreadyInList=$scope.pzoneData.selectedPZone&&_.isUndefined(_.find($scope.pzoneData.selectedPZone.content,{id:content.id})),immediateDraggable=null===$scope.pzoneData.previewTime&&moment().isAfter(content.published),futureDraggable=null!==$scope.pzoneData.previewTime&&moment().isBefore($scope.pzoneData.previewTime)&&$scope.pzoneData.previewTime.isAfter(content.published);return notAlreadyInList&&(immediateDraggable||futureDraggable)},$scope.beginInsert=function(article){PromotedContentService.beginContentInsert(article)},$scope.beginReplace=function(article){PromotedContentService.beginContentReplace(article)},$scope.stopAction=function(){PromotedContentService.stopContentAction()},$scope.disableControls=function(){return PromotedContentService.isPZoneRefreshPending()}},link:function(scope,element,attr){scope.tools=null,scope.openToolsFor=function(article){var doOpen=!1;return scope.disableControls()||(scope.tools=article.id,doOpen=!0),doOpen},scope.closeTools=function(){return scope.tools=null,!0},scope.toolsOpenFor=function(article){return scope.tools===article.id}},restrict:"E",scope:{},templateUrl:CmsConfig.buildComponentPath("promoted-content/promoted-content-search/promoted-content-search.html")}}),angular.module("promotedContentSearch",["promotedContentSearch.directive"]),angular.module("promotedContent.service",["contentServices","moment","restangular"]).service("PromotedContentService",function($,_,moment,$q,Restangular,ContentFactory,ContentListService){var PromotedContentService=this;PromotedContentService._serviceData={allContent:ContentListService.getData(),actionContent:null,action:null,pzones:[],unsavedOperations:[],operations:[],selectedPZone:null,previewTime:null};var _data=PromotedContentService._serviceData,setupDefer=$q.defer(),readableOperationTypes={INSERT:"INSERT",DELETE:"DELETE",REPLACE:"REPLACE"};PromotedContentService.readableOperationTypes=readableOperationTypes;var operationTypeToReadable={promotion_insertoperation:readableOperationTypes.INSERT,promotion_deleteoperation:readableOperationTypes.DELETE,promotion_replaceoperation:readableOperationTypes.REPLACE},readableToOperationType=_.reduce(operationTypeToReadable,function(result,val,key){return result[val]=key,result},{}),pzoneRefreshPending=!1,pzoneOperationsStale=!0;PromotedContentService.isPZoneRefreshPending=function(){return pzoneRefreshPending},PromotedContentService.isPZoneOperationsStale=function(){return pzoneOperationsStale},PromotedContentService.$refreshPZones=function(filters){var deferred=$q.defer();return pzoneRefreshPending?(deferred.reject(),deferred.promise):(pzoneRefreshPending=!0,ContentFactory.all("pzone").getList(filters).then(function(data){return _data.pzones=data,_.each(_data.pzones,function(pzone){pzone.saved=!0}),deferred.resolve(),_data.pzones})["catch"](function(err){return deferred.reject(),err})["finally"](function(){pzoneRefreshPending=!1}))},PromotedContentService.markDirtySelectedPZone=function(){delete _data.selectedPZone.saved},PromotedContentService.markSavedSelectedPZone=function(){_data.selectedPZone.saved=!0},PromotedContentService.makeOperationsStale=function(){_data.operations=[],pzoneOperationsStale=!0},PromotedContentService.$saveSelectedPZone=function(){var defer=$q.defer();return _data.previewTime&&_data.previewTime.isAfter(moment())?(PromotedContentService.makeOperationsStale(),_.each(_data.unsavedOperations,function(operation){operation.when=_data.previewTime?_data.previewTime.toISOString():null,delete operation.client_id}),_data.selectedPZone.all("operations").post(_data.unsavedOperations).then(function(){defer.resolve(_data.selectedPZone)}),PromotedContentService.clearUnsavedOperations()):_data.previewTime?defer.reject("Cannot save operations in the past."):(PromotedContentService.clearUnsavedOperations(),PromotedContentService.makeOperationsStale(),_data.selectedPZone.put().then(function(){defer.resolve(_data.selectedPZone)})["catch"](function(err){defer.reject(err)})),defer.promise},PromotedContentService.$refreshAllContent=function(){return ContentListService.$updateContent.apply(ContentListService,arguments)},PromotedContentService.$addOperation=function(props){var defer=$q.defer();if(PromotedContentService.isPreviewTimeImmediate())defer.resolve();else if(PromotedContentService.isPreviewTimePast())defer.reject("Cannot add operations in the past.");else{var lastId=_.max(_data.unsavedOperations,"client_id").client_id,nextId=lastId?lastId+1:0,allProps=_.assign({client_id:nextId,type_name:readableToOperationType[props.cleanType]||"",pzone:_data.selectedPZone.id,applied:!1,content:null,content_title:"",index:null},props),operation=Restangular.restangularizeElement(_data.selectedPZone.all("operations"),allProps);_data.unsavedOperations.push(operation),defer.resolve(operation)}return defer.promise},PromotedContentService.$removeOperation=function(id){var defer=$q.defer(),index=_.findIndex(_data.operations,{id:id}),operation=_data.operations[index];return operation?operation.whenAsMoment.isAfter(moment())?operation.remove().then(function(){_data.operations.splice(index,1),defer.resolve()})["catch"](function(err){404===err.status?defer.reject("Cannot find operation to delete."):defer.reject(err)}):defer.reject("Cannot delete an operation in the past."):defer.reject("Could not find saved operation with id "+id+" to delete."),defer.promise},PromotedContentService.clearUnsavedOperations=function(){_data.unsavedOperations=[],PromotedContentService.markSavedSelectedPZone()},PromotedContentService.$refreshOperations=function(params){return _data.selectedPZone.getList("operations",params).then(function(data){return _data.operations=data,_.each(_data.operations,function(operation){operation.cleanType=operationTypeToReadable[operation.type_name],operation.whenAsMoment=moment(operation.when)}),pzoneOperationsStale=!1,_data.operations})["catch"](function(err){return err})},PromotedContentService.$selectPZone=function(name){return _data.selectedPZone=_.find(_data.pzones,{name:name})||_data.pzones[0],PromotedContentService.clearUnsavedOperations(),PromotedContentService.$refreshSelectedPZone(_data.previewTime)},PromotedContentService.$removeContentFromPZone=function(contentId){var defer=$q.defer(),i=_.findIndex(_data.selectedPZone.content,{id:contentId});return i>=0?PromotedContentService.$addOperation({cleanType:readableOperationTypes.DELETE,content:contentId,content_title:_data.selectedPZone.content[i].title}).then(function(){PromotedContentService.markDirtySelectedPZone(),_data.selectedPZone.content.splice(i,1),defer.resolve()})["catch"](function(err){defer.reject(err)}):defer.reject("Could not find content with given id to delete."),defer.promise};var moveTo=function(indexFrom,indexTo){var ret=!1,content=_data.selectedPZone.content;if(indexFrom>=0&&indexFrom<content.length&&indexTo>=0&&indexTo<content.length){var splicer=content.splice(indexFrom,1,content[indexTo]);splicer.length>0&&(content[indexTo]=splicer[0],ret=!0,PromotedContentService.markDirtySelectedPZone())}return ret};PromotedContentService.moveContentUp=function(index){return moveTo(index,index-1)},PromotedContentService.moveContentDn=function(index){return moveTo(index,index+1)},PromotedContentService.beginContentInsert=function(article){_data.actionContent=article,_data.action=readableOperationTypes.INSERT},PromotedContentService.beginContentReplace=function(article){_data.actionContent=article,_data.action=readableOperationTypes.REPLACE},PromotedContentService.stopContentAction=function(){_data.actionContent=null,_data.action=null},PromotedContentService.$completeContentAction=function(index){var deferred=$q.defer();return _data.action?PromotedContentService.$addOperation({cleanType:_data.action,content:_data.actionContent.id,content_title:_data.actionContent.title,index:index}).then(function(){var duplicateIndex=_.findIndex(_data.selectedPZone.content,{id:_data.actionContent.id});index!==duplicateIndex&&duplicateIndex>=0&&_data.selectedPZone.content.splice(duplicateIndex,1);var replace=_data.action===readableOperationTypes.REPLACE;_data.selectedPZone.content.splice(index,replace?1:0,_data.actionContent),PromotedContentService.stopContentAction(),PromotedContentService.markDirtySelectedPZone(),deferred.resolve()})["catch"](deferred.reject):deferred.reject("No action to complete in progress."),deferred.promise},PromotedContentService.setPreviewTime=function(time){return _data.previewTime=time,PromotedContentService.clearUnsavedOperations(),PromotedContentService.$refreshSelectedPZone(_data.previewTime)},PromotedContentService.setPreviewTimeToImmediate=function(){PromotedContentService.setPreviewTime(null)},PromotedContentService.isPreviewTimeImmediate=function(){return null===_data.previewTime},PromotedContentService.isPreviewTimePast=function(){return!PromotedContentService.isPreviewTimeImmediate()&&_data.previewTime.isBefore(moment())},PromotedContentService.$refreshSelectedPZone=function(time){var params={};time&&(params.preview=time.toISOString()),PromotedContentService.makeOperationsStale();var deferred=$q.defer();return pzoneRefreshPending?deferred.reject():(pzoneRefreshPending=!0,_data.selectedPZone.get(params).then(function(data){return deferred.resolve(),_data.selectedPZone=data,_data.selectedPZone})["catch"](function(err){return deferred.reject(),err})["finally"](function(){PromotedContentService.markSavedSelectedPZone(),pzoneRefreshPending=!1})),deferred.promise},PromotedContentService.getData=function(){return _data},PromotedContentService.$ready=function(){return setupDefer.promise},PromotedContentService.$refreshPZones().then(function(){return PromotedContentService.$refreshAllContent()}).then(function(){return PromotedContentService.$selectPZone()}).then(function(){setupDefer.resolve()})}),angular.module("promotedContentTimePicker.directive",["bulbs.cms.site.config","promotedContent.service"]).directive("promotedContentTimePicker",function(CmsConfig){return{controller:function(moment,$scope,PromotedContentService){$scope.contentData=PromotedContentService.getData(),$scope.setPreviewTime=function(previewTime){PromotedContentService.setPreviewTime(previewTime)},$scope.setPreviewTimeToImmediate=function(){$scope.previewTime=null,PromotedContentService.setPreviewTimeToImmediate()},$scope.disableControls=function(){return PromotedContentService.isPZoneRefreshPending()}},restrict:"E",scope:{},templateUrl:CmsConfig.buildComponentPath("promoted-content/promoted-content-time-picker/promoted-content-time-picker.html")}}),angular.module("promotedContentTimePicker",["promotedContentTimePicker.directive"]),angular.module("promotedContent",["bulbs.cms.site.config","promotedContentPzoneSelect","promotedContentList","promotedContentSearch","promotedContentTimePicker","promotedContentOperationsList"]).config(function($injector,$routeProvider,CmsConfigProvider){var CmsConfig=$injector.invoke(CmsConfigProvider.$get);$routeProvider.when("/cms/app/promotion/",{controller:["$window","CmsConfig",function($window){$window.document.title=CmsConfig.getCmsName()+" | Promotion Tool"}],templateUrl:CmsConfig.buildComponentPath("promoted-content/promoted-content.html"),reloadOnSearch:!1})}),angular.module("bulbs.cms.recircChooser",["bulbs.cms.contentSearch","bulbs.cms.site.config","uuid4"]).directive("recircChooser",["CmsConfig","ContentFactory","Utils","uuid4",function(CmsConfig,ContentFactory,Utils,uuid4){return{link:function(scope,element,attrs,controllers){var parentForm=controllers[1];scope.maxRecircItemsInt=scope.maxRecircItems?parseInt(scope.maxRecircItems,10):3,scope.inputId=angular.isString(scope.inputId)?scope.inputId:uuid4.generate(),scope.fullRecircContents=[];var retrieveContent=function(contentId){return ContentFactory.one("content",contentId).get()};scope.includeRecirc=function(contentId){var newRecircIdsLength=scope.ngModel.push(contentId);scope.onSelect(contentId),retrieveContent(contentId).then(function(content){scope.fullRecircContents[newRecircIdsLength-1]=content}),angular.isObject(parentForm)&&parentForm.$setDirty()},scope.removeRecirc=function(index){scope.onRemove(index),Utils.removeFrom(scope.ngModel,index),Utils.removeFrom(scope.fullRecircContents,index),angular.isObject(parentForm)&&parentForm.$setDirty()},angular.isArray(scope.ngModel)&&scope.ngModel.forEach(function(contentId,i){retrieveContent(contentId).then(function(content){scope.fullRecircContents[i]=content})})},require:["ngModel","?^^form"],restrict:"E",scope:{inputId:"@",maxRecircItems:"@",ngModel:"=",onRemove:"&",onSelect:"&"},templateUrl:CmsConfig.buildComponentPath("recirc-chooser","recirc-chooser.html")}}]),angular.module("lineItems.edit.directive",["apiServices.lineItem.factory","bulbs.cms.site.config","lodash","saveButton.directive","topBar"]).directive("lineItemsEdit",function(CmsConfig){return{controller:function(_,$location,$q,$routeParams,$scope,LineItem){"new"===$routeParams.id?($scope.model=LineItem.$build(),$scope.isNew=!0):$scope.model=LineItem.$find($routeParams.id),window.onbeforeunload=function(e){return!_.isEmpty($scope.model.$dirty())||$scope.isNew||$scope.needsSave?"You have unsaved changes.":void 0},$scope.$on("$destroy",function(){delete window.onbeforeunload}),$scope.saveModel=function(){var promise;if($scope.model)promise=$scope.model.$save().$asPromise().then(function(data){$location.path("/cms/app/line-items/edit/"+data.id+"/")});else{var deferred=$q.defer();deferred.reject(),promise=deferred.promise}return promise}},restrict:"E",scope:{getModelId:"&modelId"},templateUrl:CmsConfig.buildComponentPath("reporting/reporting-line-items-edit/reporting-line-items-edit.html")}}),angular.module("lineItems.edit",["bulbs.cms.site.config","lineItems.edit.directive"]).config(function($routeProvider){$routeProvider.when("/cms/app/line-items/edit/:id/",{controller:function($routeParams,$scope,$window,CmsConfig){$window.document.title=CmsConfig.getCmsName()+" | Edit Line Item",$scope.routeId=$routeParams.id},template:'<line-items-edit id="routeId"></line-items-edit>',reloadOnSearch:!1})}),angular.module("lineItems.list",["apiServices.lineItem.factory","bulbs.cms.site.config","listPage"]).config(function($injector,$routeProvider,CmsConfigProvider){var CmsConfig=$injector.invoke(CmsConfigProvider.$get);$routeProvider.when("/cms/app/line-items/",{controller:function($modal,$scope,$window,LineItem){$window.document.title=CmsConfig.getCmsName()+" | Line Items",$scope.modelFactory=LineItem,$scope.LineItemExportModal=function(){return $modal.open({templateUrl:"/views/modals/line-item-export-modal.html",controller:"LineitemexportmodalCtrl"})},$scope.utilityButtons=[{title:"Export CSV",click:function(){$scope.LineItemExportModal()},buttonClasses:"add-item btn btn-primary",iconClasses:"font-awesome"}]},templateUrl:CmsConfig.buildComponentPath("reporting/reporting-line-items-list/reporting-line-items-list.html")})}),angular.module("rateOverrides.edit.directive",["apiServices.rateOverride.factory","apiServices.featureType.factory","bulbs.cms.site.config","lodash","saveButton.directive","topBar"]).directive("rateOverridesEdit",function(CmsConfig){return{controller:function(_,$location,$http,$q,$routeParams,$scope,ContentFactory,FeatureType,RateOverride,Raven){var resourceUrl="/cms/api/v1/contributions/role/";"new"===$routeParams.id?($scope.model=RateOverride.$build(),$scope.isNew=!0):($scope.model=RateOverride.$find($routeParams.id),$scope.model.$promise.then(function(){$scope.model.hasOwnProperty("role")&&null!==$scope.model.role&&($scope.model.role=$scope.model.role.id)})),window.onbeforeunload=function(e){return!_.isEmpty($scope.model.$dirty())||$scope.isNew||$scope.needsSave?"You have unsaved changes.":void 0},$scope.$on("$destroy",function(){delete window.onbeforeunload}),$scope.getPaymentType=function(roleId){if($scope.hasOwnProperty("roles")){for(var i=0;i<$scope.roles.length;i++)if($scope.roles[i].id===roleId)return $scope.roles[i].payment_type;return null}},$scope.isFeatureRated=function(){return"FeatureType"===$scope.getPaymentType($scope.model.role)?!0:!1},$scope.isHourlyRated=function(){return"Hourly"===$scope.getPaymentType($scope.model.role)?!0:!1},$scope.isFlatRated=function(){return"Flat Rate"===$scope.getPaymentType($scope.model.role)?!0:!1},$scope.addFeatureType=function(){$scope.model.hasOwnProperty("featureTypes")||($scope.model.featureTypes=[]),$scope.model.featureTypes.push({featureType:null,rate:0})},$scope.getFeatureTypes=function(){$http({method:"GET",url:resourceUrl}).success(function(data){$scope.featureTypes=data.results||data}).error(function(data,status,headers,config){Raven.captureMessage("Error fetching FeatureTypes",{extra:data})})},$scope.getRoles=function(){$http({method:"GET",url:resourceUrl}).success(function(data){$scope.roles=data.results||data}).error(function(data,status,headers,config){Raven.captureMessage("Error fetching Roles",{extra:data})})},$scope.searchFeatureTypes=function(searchTerm){return FeatureType.simpleSearch(searchTerm)},$scope.saveModel=function(){var promise;if($scope.model)promise=$scope.model.$save().$asPromise().then(function(data){$location.path("/cms/app/rate-overrides/edit/"+data.id+"/"),$scope.model.hasOwnProperty("role")&&null!==$scope.model.role&&($scope.model.role=$scope.model.role.id)});else{var deferred=$q.defer();deferred.reject(),promise=deferred.promise}return promise},$scope.getRoles(),$scope.getFeatureTypes()},restrict:"E",scope:{getModelId:"&modelId"},templateUrl:CmsConfig.buildComponentPath("reporting/reporting-rate-overrides-edit/reporting-rate-overrides-edit.html")}}),angular.module("rateOverrides.edit",["bulbs.cms.site.config","rateOverrides.edit.directive"]).config(function($routeProvider){$routeProvider.when("/cms/app/rate-overrides/edit/:id/",{controller:function($routeParams,$scope,$window,CmsConfig){$window.document.title=CmsConfig.getCmsName()+" | Edit Rate Override",$scope.routeId=$routeParams.id},template:'<rate-overrides-edit id="routeId"></rate-overrides-edit>',reloadOnSearch:!1})}),angular.module("rateOverrides.list",["apiServices.rateOverride.factory","bulbs.cms.site.config","listPage"]).config(function($injector,$routeProvider,CmsConfigProvider){var CmsConfig=$injector.invoke(CmsConfigProvider.$get);$routeProvider.when("/cms/app/rate-overrides/",{controller:function($scope,$window,RateOverride){$window.document.title=CmsConfig.getCmsName()+" | Rate Overrides",$scope.modelFactory=RateOverride},templateUrl:CmsConfig.buildComponentPath("reporting/reporting-rate-overrides-list/reporting-rate-overrides-list.html")})}),angular.module("roles.edit.directive",["apiServices.reporting.factory","bulbs.cms.site.config","lodash","saveButton.directive","topBar"]).constant("PAYMENT_TYPES",[{name:"Flat Rate",value:"Flat Rate"},{name:"FeatureType",value:"FeatureType"},{name:"Hourly",value:"Hourly"},{name:"Manual",value:"Manual"}]).directive("rolesEdit",function(CmsConfig){return{controller:function(_,$location,$q,$routeParams,$scope,Role,PAYMENT_TYPES){$scope.page="contributions",$scope.PAYMENT_TYPES=PAYMENT_TYPES,"new"===$routeParams.id?($scope.model=Role.$build(),$scope.isNew=!0):$scope.model=Role.$find($routeParams.id).$then(function(){$scope.model.feature_type_rates.$fetch(),$scope.model.flat_rates.$fetch(),$scope.model.hourly_rates.$fetch()}),window.onbeforeunload=function(e){return!_.isEmpty($scope.model.$dirty())||$scope.isNew||$scope.needsSave?"You have unsaved changes.":void 0},$scope.$on("$destroy",function(){delete window.onbeforeunload}),$scope.rateEditable=function(){var paymentTypes=PAYMENT_TYPES.slice(0,3);return paymentTypes.indexOf($scope.model.paymentType>=0)?!0:!1},$scope.getDirtyRates=function(){var dirty=[];return $scope.model.hasOwnProperty("flat_rate")&&!_.isEmpty($scope.model.flat_rate.$dirty())&&dirty.push($scope.model.flat_rate),$scope.model.hasOwnProperty("hourly_rate")&&!_.isEmpty($scope.model.hourly_rate.$dirty())&&dirty.push($scope.model.hourly_rate),$scope.model.feature_type_rates.forEach(function(rate){_.isEmpty(rate.$dirty())||dirty.push(rate)}),dirty},$scope.saveDirtyRates=function(){var dirtyRates=$scope.getDirtyRates();dirtyRates.forEach(function(rate){rate.$save()})},$scope.saveModel=function(){var promise;if($scope.saveDirtyRates(),$scope.model)promise=$scope.model.$save().$asPromise().then(function(data){$location.path("/cms/app/roles/edit/"+data.id+"/")});else{var deferred=$q.defer();deferred.reject(),promise=deferred.promise}return promise}},restrict:"E",scope:{getModelId:"&modelId"},templateUrl:CmsConfig.buildComponentPath("reporting/reporting-roles-edit/reporting-roles-edit.html")}}),angular.module("roles.edit",["bulbs.cms.site.config","roles.edit.directive"]).config(function($routeProvider){$routeProvider.when("/cms/app/roles/edit/:id/",{controller:function($routeParams,$scope,$window,CmsConfig){$window.document.title=CmsConfig.getCmsName()+" | Edit Role",$scope.routeId=$routeParams.id},template:'<roles-edit model-id="routeId"></roles-edit>',reloadOnSearch:!1})}),angular.module("roles.list",["apiServices.reporting.factory","bulbs.cms.site.config","listPage"]).config(function($injector,$routeProvider,CmsConfigProvider){var CmsConfig=$injector.invoke(CmsConfigProvider.$get);$routeProvider.when("/cms/app/roles/",{controller:function($scope,$window,Role){$window.document.title=CmsConfig.getCmsName()+" | Roles",$scope.modelFactory=Role},templateUrl:CmsConfig.buildComponentPath("reporting/reporting-roles-list/reporting-roles-list.html")})}),angular.module("reports",["lineItems.edit","lineItems.list","rateOverrides.edit","rateOverrides.list","roles.edit","roles.list"]),angular.module("sections.edit.directive",["apiServices.section.factory","BettyCropper","bulbs.cms.site.config","copyButton","customSearch","lodash","saveButton.directive","sections.settings","topBar"]).directive("sectionsEdit",function(CmsConfig){return{controller:function(_,$location,$q,$scope,SECTIONS_LIST_REL_PATH,Section){$scope.LIST_URL=CmsConfig.buildExternalUrl(SECTIONS_LIST_REL_PATH),$scope.needsSave=!1;var modelId=$scope.getModelId();"new"===modelId?($scope.model=Section.$build(),$scope.isNew=!0):$scope.model=Section.$find($scope.getModelId()),window.onbeforeunload=function(e){return!_.isEmpty($scope.model.$dirty())||$scope.isNew||$scope.needsSave?"You have unsaved changes.":void 0},$scope.$on("$destroy",function(){delete window.onbeforeunload}),$scope.saveModel=function(){var promise;if($scope.model)promise=$scope.model.$save().$asPromise().then(function(data){"new"===modelId&&$location.path("/cms/app/section/edit/"+data.id+"/"),$scope.isNew=!1,$scope.needsSave=!1});else{var deferred=$q.defer();deferred.reject(),promise=deferred.promise}return promise}},restrict:"E",scope:{getModelId:"&modelId"},templateUrl:CmsConfig.buildComponentPath("sections/sections-edit/sections-edit.html")}}),angular.module("sections.edit",["bulbs.cms.site.config","sections.edit.directive"]).config(function($routeProvider){$routeProvider.when("/cms/app/section/edit/:id/",{controller:function($routeParams,$scope,$window,CmsConfig){$window.document.title=CmsConfig.getCmsName()+" | Edit Section",$scope.routeId=$routeParams.id},template:'<sections-edit model-id="routeId"></sections-edit>',reloadOnSearch:!1})}),angular.module("sections.list",["apiServices.section.factory","bulbs.cms.site.config","listPage","sections.settings"]).config(function($injector,$routeProvider,CmsConfigProvider){var CmsConfig=$injector.invoke(CmsConfigProvider.$get);$routeProvider.when("/cms/app/section/",{controller:function($scope,$window,SECTIONS_LIST_REL_PATH,Section){$window.document.title=CmsConfig.getCmsName()+" | Section",$scope.modelFactory=Section,$scope.LIST_URL=CmsConfig.buildExternalUrl(SECTIONS_LIST_REL_PATH)},templateUrl:CmsConfig.buildComponentPath("sections/sections-list/sections-list-page.html")})}),angular.module("sections.settings",[]).value("SECTIONS_LIST_REL_PATH","/section/"),angular.module("sections",["sections.list","sections.edit"]),angular.module("bulbs.cms.sendToEditorModal.api",["bulbs.cms.dateTimeFilter","bulbs.cms.site.config","bulbs.cms.utils","lodash"]).service("SendToEditorApi",["_","$http","CmsConfig","dateTimeFormatFilter","moment","Utils",function(_,$http,CmsConfig,dateTimeFormatFilter,moment,Utils){var endpoint=function(article){return CmsConfig.buildApiUrlRoot("content",article.id,"send/")},parsePayload=function(payload){var data=_.cloneDeep(payload.data);return data};return{sendToEditor:function(article,status,notes){return $http.post(endpoint(article),{status:status,notes:notes}).then(function(response){return parsePayload(response)})}}}]),angular.module("bulbs.cms.sendToEditorModal",["bulbs.cms.sendToEditorModal.api","bulbs.cms.site.config","Raven","ui.bootstrap","ui.bootstrap.modal"]).directive("sendToEditorModalOpener",["$modal","$q","CmsConfig","SendToEditorApi","Raven",function($modal,$q,CmsConfig,SendToEditorApi,Raven){return{restrict:"A",scope:{modalArticle:"=",modalOnBeforeOpen:"&",modalOnCancel:"&",modalOnOk:"&"},link:function(scope,element){scope.statuses=CmsConfig.getArticleEditoralStatuses(),scope.modalInstance=!1;var setupAndOpenModal=function(){scope.clearError=function(){scope.errorMessage=""},scope.sendToEditor=function(status,note){return scope.clearError(),SendToEditorApi.sendToEditor(scope.modalArticle,status,"Status: "+status+"\n\n"+note).then(scope.modalInstance.close)["catch"](function(response){Raven.captureMessage("Error attempting to send to editor",{response:response}),scope.errorMessage="An error occurred!"})},scope.modalInstance=$modal.open({scope:scope,templateUrl:CmsConfig.buildComponentPath("send-to-editor-modal","send-to-editor-modal.html")}),scope.modalInstance.result.then(scope.modalOnOk)["catch"](scope.modalOnCancel)["finally"](function(){scope.modalInstance=!1})};element.addClass("send-to-editor-modal-opener"),element.on("click",function(){scope.modalInstance||$q.when(scope.modalOnBeforeOpen()).then(function(result){result!==!1&&setupAndOpenModal()})})}}}]),angular.module("specialCoverage.edit.directive",["apiServices.campaign.factory","apiServices.specialCoverage.factory","bulbs.cms.site.config","campaignAutocomplete","copyButton","customSearch","lodash","specialCoverage.settings","topBar","ui.bootstrap.tooltip","videoList","bulbs.cms.superFeatures.tab"]).directive("specialCoverageEdit",function(CmsConfig){return{controller:function(_,$location,$q,$scope,$modal,Campaign,SPECIAL_COVERAGE_LIST_REL_PATH,SpecialCoverage){$scope.ACTIVE_STATES=SpecialCoverage.ACTIVE_STATES,$scope.LIST_URL=CmsConfig.buildExternalUrl(SPECIAL_COVERAGE_LIST_REL_PATH),$scope.needsSave=!1,$scope.tunicCampaignIdMapping={};var modelId=$scope.getModelId();"new"===modelId?($scope.model=SpecialCoverage.$build(),$scope.isNew=!0):$scope.model=SpecialCoverage.$find($scope.getModelId()).$then(function(){$scope.model.$loadTunicCampaign().then(function(campaign){$scope.tunicCampaignIdMapping[campaign.id]=campaign})}),window.onbeforeunload=function(e){return!_.isEmpty($scope.model.$dirty())||$scope.isNew||$scope.needsSave?"You have unsaved changes.":void 0},$scope.$on("$destroy",function(){delete window.onbeforeunload}),$scope.saveModel=function(){var promise;if($scope.model)promise=$scope.model.$save().$asPromise().then(function(data){"new"===modelId&&$location.path("/cms/app/special-coverage/edit/"+data.id+"/"),$scope.isNew=!1,$scope.needsSave=!1});else{var deferred=$q.defer();deferred.reject(),promise=deferred.promise}return promise},$scope.previewLinkModal=function(){return $modal.open({templateUrl:"/views/modals/preview-link-modal.html",scope:$scope,resolve:{}})},$scope.tunicCampaignFormatter=function(campaignId){
if(campaignId in $scope.tunicCampaignIdMapping){var campaign=$scope.tunicCampaignIdMapping[campaignId];return campaign.name+" - "+campaign.number}},$scope.searchCampaigns=function(searchTerm){return $scope.model.$searchCampaigns({search:searchTerm}).then(function(campaigns){return campaigns.forEach(function(campaign){$scope.tunicCampaignIdMapping[campaign.id]=campaign}),campaigns.map(function(campaign){return campaign.id})})}},restrict:"E",scope:{getModelId:"&modelId"},templateUrl:CmsConfig.buildComponentPath("special-coverage/special-coverage-edit/special-coverage-edit.html")}}),angular.module("specialCoverage.edit",["bulbs.cms.site.config","specialCoverage.edit.directive"]).config(function($routeProvider){$routeProvider.when("/cms/app/special-coverage/edit/:id/",{controller:function($routeParams,$scope,$window,CmsConfig){$window.document.title=CmsConfig.getCmsName()+" | Edit Special Coverage",$scope.routeId=$routeParams.id},template:'<special-coverage-edit model-id="routeId"></special-coverage-edit>'})}),angular.module("specialCoverage.list",["apiServices.specialCoverage.factory","bulbs.cms.site.config","listPage","moment","specialCoverage.settings"]).config(function($injector,$routeProvider,CmsConfigProvider){var CmsConfig=$injector.invoke(CmsConfigProvider.$get);$routeProvider.when("/cms/app/special-coverage/",{controller:function($scope,$window,CmsConfig,SPECIAL_COVERAGE_LIST_REL_PATH,SpecialCoverage){$window.document.title=CmsConfig.getCmsName()+" | Special Coverage",$scope.modelFactory=SpecialCoverage,$scope.LIST_URL=CmsConfig.buildExternalUrl(SPECIAL_COVERAGE_LIST_REL_PATH)},templateUrl:CmsConfig.buildComponentPath("special-coverage/special-coverage-list/special-coverage-list-page.html")})}),angular.module("specialCoverage.settings",[]).value("SPECIAL_COVERAGE_LIST_REL_PATH","/special/"),angular.module("specialCoverage",["specialCoverage.list","specialCoverage.edit"]),angular.module("bulbs.cms.staticImage",["bulbs.cms.site.config"]).directive("staticImage",["CmsConfig",function(CmsConfig){return{templateUrl:CmsConfig.buildComponentPath("static-image","static-image.html"),restrict:"E",scope:{image:"=",ratio:"@"},link:function(scope,element,attrs){scope.$watch("image",function(){scope.image&&scope.image.id?scope.imageUrl=CmsConfig.buildImageApiUrl(scope.image.id,scope.ratio||"16x9","1200.jpg"):scope.imageUrl=!1})}}}]),angular.module("statusFilter.config",["bulbs.cms.site.config","contentServices.listService","moment"]).provider("StatusFilterOptions",function(moment){var _statuses=[{label:"Draft",key:"status",value:"Draft"},{label:"Awaiting Review",key:"status",value:"Waiting for Editor"},{label:"Published",key:"before",value:function(){return moment().format("YYYY-MM-DDTHH:mmZ")}},{label:"Scheduled",key:"after",value:function(){return moment().format("YYYY-MM-DDTHH:mmZ")}},{label:"All",key:null,value:null}];this.setStatuses=function(statuses){_statuses=statuses},this.$get=function(){return{getStatuses:function(){return _statuses}}}}),angular.module("statusFilter.directive",["bulbs.cms.site.config","contentServices.listService","statusFilter.config"]).directive("statusFilter",function($location,_,StatusFilterOptions,ContentListService,CmsConfig){return{templateUrl:CmsConfig.buildComponentPath("status-filter/status-filter.html"),restrict:"E",scope:{},controller:"ContentlistCtrl",link:function(scope,element,attrs){function getValue(option){var value;return value="function"==typeof option.value?option.value():option.value}scope.options=StatusFilterOptions.getStatuses(),scope.isActive=function(option){if(option.key&&option.key in $location.search()&&$location.search()[option.key]===getValue(option))return!0;if(!option.key){var possibleKeys=_.pluck(scope.options,"key"),searchKeys=_.keys($location.search());return _.intersection(possibleKeys,searchKeys).length>0?!1:!0}return!1},scope.filterByStatus=function(option){var value,search={};return option.key&&(value=getValue(option),search[option.key]=value),ContentListService.$updateContent(search,!1)}}}}),angular.module("statusFilter",["statusFilter.directive"]),angular.module("bulbs.cms.superFeatures.api",["bulbs.cms.dateTimeFilter","bulbs.cms.dynamicContent.api","bulbs.cms.site.config","bulbs.cms.utils","lodash","moment"]).service("SuperFeaturesApi",["_","$http","$sce","CmsConfig","dateTimeFormatFilter","moment","Utils",function(_,$http,$sce,CmsConfig,dateTimeFormatFilter,moment,Utils){var superFeatureEndpoint=CmsConfig.buildApiUrlRoot.bind(null,"super-feature"),contentEndpoint=CmsConfig.buildApiUrlRoot.bind(null,"content"),parsePayload=function(payload){var data=_.cloneDeep(payload);return payload.published&&(data.published=moment.tz(payload.published,CmsConfig.getTimezoneName())),data},cleanData=function(data){var payload=_.chain(data).omit("published").cloneDeep().value();return data.published&&(payload.published=data.published.format()),payload};return{createSuperFeature:function(data){var payload=cleanData(data);return $http.post(contentEndpoint(Utils.param({doctype:CmsConfig.getSuperFeaturesType()})),payload).then(function(response){return parsePayload(response.data)})},deleteSuperFeature:function(data){return $http["delete"](contentEndpoint(data.id,"/"))},fields:[{title:"Super Feature Name",sorts:"title",content:function(superFeature){return $sce.trustAsHtml(superFeature.title)}},{title:"Total Nested Pages",content:"children_count"},{title:"Publish Date",content:function(superFeature){var now=moment(),cellContent="";return superFeature.published?now.isSameOrAfter(superFeature.published)?cellContent=dateTimeFormatFilter(superFeature.published):now.isBefore(superFeature.published)&&(cellContent=dateTimeFormatFilter(superFeature.published,"[Scheduled for] M/D/YY h:mma z")):cellContent="Draft",cellContent}}],getSuperFeature:function(id){return $http.get(superFeatureEndpoint(id,"/")).then(function(response){return parsePayload(response.data)})},getSuperFeatures:function(params){return $http.get(superFeatureEndpoint(Utils.param(params))).then(function(response){return{results:response.data.results.map(function(result){return parsePayload(result)})}})},getSuperFeatureRelations:function(id){return $http.get(superFeatureEndpoint(id,"relations/")).then(function(response){return{results:response.data.map(function(result){return parsePayload(result)})}})},name:"Super Feature",namePlural:"Super Features",updateSuperFeature:function(data){var payload=cleanData(data);return $http.put(contentEndpoint(data.id,"/"),payload).then(function(response){return parsePayload(response.data)})},updateSuperFeatureRelationsOrdering:function(id,relations){var remappedRelations=relations.map(function(relation){return _.pick(relation,"id","ordering")});return $http.put(superFeatureEndpoint(id,"relations","ordering/"),remappedRelations)},updateAllRelationPublishDates:function(id){return $http.put(superFeatureEndpoint(id,"set-children-dates/"))}}}]),angular.module("bulbs.cms.superFeatures.edit",["bulbs.cms.breadcrumb","bulbs.cms.dynamicContent","bulbs.cms.recircChooser","bulbs.cms.site.config","bulbs.cms.superFeatures.api","bulbs.cms.superFeatures.relations"]).directive("superFeaturesEdit",["CmsConfig","SuperFeaturesApi","Utils",function(CmsConfig,SuperFeaturesApi,Utils){return{link:function(scope){var recirc=scope.article.recirc_query;angular.isUndefined(recirc.included_ids)&&(recirc.included_ids=[]),scope.breadcrumbs=[{label:"Super Features",href:"/cms/app/super-features"},{label:function(){return scope.article.title}}];var addParentToBreadcrumb=function(article){angular.isNumber(article.parent)&&SuperFeaturesApi.getSuperFeature(article.parent).then(function(superFeature){scope.breadcrumbs.splice(1,0,{label:superFeature.title,href:"/cms/app/edit/"+superFeature.id+"/"+CmsConfig.getSuperFeaturesType()}),addParentToBreadcrumb(superFeature)})};addParentToBreadcrumb(scope.article)},scope:!1,restrict:"E",templateUrl:CmsConfig.buildComponentPath("super-features","super-features-edit","super-features-edit.html")}}]),angular.module("bulbs.cms.superFeatures.list",["bulbs.cms.site.config","bulbs.cms.superFeatures.api","bulbsCmsApp.nonRestmodListPage","lodash","moment","ngRoute","statusFilter.config"]).config(["_","$injector","$routeProvider","CmsConfigProvider","StatusFilterOptionsProvider",function(_,$injector,$routeProvider,CmsConfigProvider,StatusFilterOptionsProvider){var CmsConfig=$injector.invoke(CmsConfigProvider.$get),StatusFilterOptions=$injector.invoke(StatusFilterOptionsProvider.$get);$routeProvider.when("/cms/app/super-features/",{controller:["$scope","$window","SuperFeaturesApi",function($scope,$window,SuperFeaturesApi){$window.document.title=CmsConfig.getCmsName()+" | Super Feature",$scope.modelFactory=SuperFeaturesApi,$scope.editPageUrlBuilder=function(item){return"/cms/app/edit/"+item.id+"/"+(item.polymorphic_ctype||CmsConfig.getSuperFeaturesType())},$scope.statusFilterOptions=StatusFilterOptions.getStatuses().filter(function(option){return"All"!==option.label}).map(function(option){var params={};return option.key&&(params[option.key]=_.isFunction(option.value)?option.value():option.value),{title:option.label,params:params}})}],templateUrl:CmsConfig.buildComponentPath("super-features","super-features-list","super-features-list.html")})}]),angular.module("bulbs.cms.superFeatures.relations.modal",["bulbs.cms.site.config","ui.bootstrap","ui.bootstrap.modal"]).directive("superFeaturesRelationsModalOpener",["$","$modal","CmsConfig",function($,$modal,CmsConfig){return{restrict:"A",scope:{modalOnCancel:"&",modalOnOk:"&",modalRelationType:"@",modalChoices:"="},link:function(scope,element){element.addClass("super-features-relations-modal-opener"),element.on("click",function(){scope.modalInstance||(scope.modalInstance=$modal.open({scope:scope,templateUrl:CmsConfig.buildComponentPath("super-features","super-features-relations","super-features-relations-modal","super-features-relations-modal.html")}),scope.modalInstance.result.then(scope.modalOnOk)["catch"](scope.modalOnCancel)["finally"](function(){scope.modalInstance=!1}),scope.setInitialChoice=function(){if(scope.modalChoices){var choiceUl=$(".supefeature-choices"),li=choiceUl.find("li");scope.modalRelationType=scope.modalChoices[0],updateActiveChoiceElement(li)}},scope.setRelationTypeChoice=function(e,choice){scope.modalRelationType=choice,updateActiveChoiceElement(e.currentTarget)},scope.setInitialChoice())});var updateActiveChoiceElement=function(el){var parentEl=$(el).parent(),oldEl=parentEl.siblings().filter(".active");oldEl.removeClass("active"),parentEl.addClass("active")}}}}]),angular.module("bulbs.cms.superFeatures.relations",["bettyEditable","bulbs.cms.dateTimeFilter","bulbs.cms.site.config","bulbs.cms.superFeatures.api","bulbs.cms.superFeatures.relations.modal","bulbs.cms.sendToEditorModal","bulbs.cms.titleModal","bulbs.cms.utils","confirmationModal","lodash","moment","Raven","statusFilter.config"]).directive("superFeaturesRelations",["_","$q","CmsConfig","moment","Raven","SuperFeaturesApi","StatusFilterOptions","Utils",function(_,$q,CmsConfig,moment,Raven,SuperFeaturesApi,StatusFilterOptions,Utils){return{link:function(scope,element,attrs){var reportError=function(message,data){Raven.captureMessage(message,data),scope.errorMessage=message};scope.clearError=function(){scope.errorMessage=""},scope.$watch("relations",function(newRelations,oldRelations){angular.equals(newRelations,oldRelations)||scope.clearError()},!0);var normalizeOrderings=function(relations){relations.forEach(function(relation,i){relation.ordering=i+1})};SuperFeaturesApi.getSuperFeatureRelations(scope.article.id).then(function(response){scope.relations=response.results,normalizeOrderings(scope.relations)})["catch"](function(response){var message="An error occurred retrieving relations!";reportError(message,{response:response})}),scope.statuses=StatusFilterOptions.getStatuses().filter(function(status){return!!status.value});var relationFormPrefix="relationForm_",orderingFormPrefix="orderingInputForm_";scope.wrapperForm={},scope.makeRelationFormName=function(relation){return relationFormPrefix+relation.id},scope.makeOrderingFormName=function(relation){return orderingFormPrefix+relation.id},scope.getRelationForm=function(relation){return scope.wrapperForm[scope.makeRelationFormName(relation)]},scope.getOrderingForm=function(relation){return scope.wrapperForm[scope.makeOrderingFormName(relation)]},scope.isAtLeastOneRelationFormDirty=function(){return Object.keys(scope.wrapperForm).reduce(function(isDirty,key){return key.startsWith(relationFormPrefix)?isDirty||scope.wrapperForm[key].$dirty:isDirty},!1)};var lock=Utils.buildLock();scope.transactionsLocked=lock.isLocked;var reorder=function(operation){return function(){var funcArgs=arguments,payload=scope.relations.map(function(relation){return _.pick(relation,"id","ordering")});return operation.bind(null,payload).apply(null,funcArgs),normalizeOrderings(payload),SuperFeaturesApi.updateSuperFeatureRelationsOrdering(scope.article.id,payload).then(function(){operation.bind(null,scope.relations).apply(null,funcArgs),normalizeOrderings(scope.relations)})["catch"](function(response){var message="An error occurred attempting to reorder a child!";reportError(message,{response:response})})}};scope.moveRelation=lock(reorder(Utils.moveTo)),scope.addRelation=lock(function(title,superfeatureType){return SuperFeaturesApi.createSuperFeature({parent:scope.article.id,superfeature_type:superfeatureType,title:title,ordering:(_.max(scope.relations,"ordering").ordering||0)+1}).then(function(relation){scope.relations.push(relation)})["catch"](function(response){var message="An error occurred attempting to add a child page!";reportError(message,{response:response})})}),scope.updateRelationsPublishDates=lock(function(){return SuperFeaturesApi.updateAllRelationPublishDates(scope.article.id).then(function(response){scope.relations.forEach(function(relation){relation.published=moment.tz(scope.article.published,CmsConfig.getTimezoneName())})})["catch"](function(response){var message="An error occurred attempting to update child publish dates!";reportError(message,{response:response})})}),scope.saveRelation=lock(function(relation){var relationCopy=angular.copy(relation);return relationCopy.parent=scope.article.id,SuperFeaturesApi.updateSuperFeature(relationCopy)["catch"](function(response){var titleDisplay=relation.title?'"'+relation.title+'"':"a relation",message="An error occurred attempting to update "+titleDisplay+"!";reportError(message,{response:response})})["finally"](function(){scope.getRelationForm(relation).$setPristine()})}),scope.deleteRelation=lock(function(relation){return SuperFeaturesApi.deleteSuperFeature(relation).then(function(){var index=scope.relations.indexOf(relation);reorder(Utils.removeFrom)(index)})["catch"](function(response){var titleDisplay=relation.title?'"'+relation.title+'"':"a relation",message="An error occurred attempting to delete "+titleDisplay+"!";reportError(message,{response:response})})})},restrict:"E",scope:{article:"="},templateUrl:CmsConfig.buildComponentPath("super-features","super-features-relations","super-features-relations.html")}}]),angular.module("bulbs.cms.superFeatures.tab.item",["bulbs.cms.site.config","bulbs.cms.superFeatures.api","filters.moment"]).directive("superFeaturesTabItem",function(CmsConfig,SuperFeaturesApi){return{link:function(scope){var requestSuperFeature=function(){angular.isNumber(scope.model)&&SuperFeaturesApi.getSuperFeature(scope.model).then(function(superFeature){scope.superFeature=superFeature})};scope.$watch("model",requestSuperFeature)},restrict:"E",scope:{model:"="},templateUrl:CmsConfig.buildComponentPath("super-features","super-features-tab","super-features-tab-item","super-features-tab-item.html")}}),angular.module("bulbs.cms.superFeatures.tab",["autocompleteBasic","bulbs.cms.site.config","bulbs.cms.utils","jquery","ui.sortable","bulbs.cms.superFeatures.tab.item","bulbs.cms.superFeatures.api"]).directive("superFeaturesTab",function($,SuperFeaturesApi,CmsConfig){return{controller:function(_,$scope,Utils,Video){$scope.moveUp=function(index){Utils.moveTo($scope.superFeatures,index,index-1),$scope.onUpdate()},$scope.moveDown=function(index){Utils.moveTo($scope.superFeatures,index,index+1),$scope.onUpdate()},$scope["delete"]=function(index){Utils.removeFrom($scope.superFeatures,index),$scope.onUpdate()},$scope.addSuperFeature=function(superFeature){$scope.addSuperFeatureCallback({superFeature:superFeature}),$scope.onUpdate()},$scope.searchSuperFeature=function(query){return SuperFeaturesApi.getSuperFeatures({search:query}).then(function(response){return response.results})}},link:function(scope,element,attr){scope.sortableOptions={beforeStop:function(e,ui){ui.helper.css("margin-top",0)},change:function(e,ui){ui.helper.css("margin-top",$(window).scrollTop())},containment:"super-feature-list",distance:3,opacity:.75,placeholder:"dropzone",start:function(e,ui){ui.helper.css("margin-top",$(window).scrollTop())}}},restrict:"E",scope:{addSuperFeatureCallback:"&addSuperFeature",superFeatures:"=",onUpdate:"&"},templateUrl:CmsConfig.buildComponentPath("super-features","super-features-tab","super-features-tab.html")}}),angular.module("bulbs.cms.superFeatures",["bulbs.cms.superFeatures.list","bulbs.cms.superFeatures.edit"]),angular.module("templateTypeField.directive",["bulbs.cms.site.config"]).directive("templateTypeField",function(CmsConfig){return{controller:function(_,$scope,ContentFactory,TEMPLATE_TYPES){$scope.templateTypes=_.filter(TEMPLATE_TYPES,{content_type:$scope.content.polymorphic_ctype})},restrict:"E",scope:{content:"="},templateUrl:CmsConfig.buildComponentPath("template-type-field/template-type-field.html")}}),angular.module("templateTypeField",["templateTypeField.directive"]).value("TEMPLATE_TYPES",[{name:"Small Width",slug:"small-width",content_type:"content_content"},{name:"Large Width",slug:"large-width",content_type:"content_content"}]),angular.module("bulbs.cms.titleModal",["bulbs.cms.site.config","ui.bootstrap","ui.bootstrap.modal"]).directive("titleModalOpener",["$modal","CmsConfig",function($modal,CmsConfig){return{restrict:"A",scope:{modalBodyBefore:"@",modalBodyAfter:"@",modalCancelText:"@",modalOkText:"@",modalOnCancel:"&",modalOnOk:"&",modalTitle:"@"},link:function(scope,element){element.addClass("title-modal-opener"),element.on("click",function(){scope.modalInstance||(scope.modalInstance=$modal.open({scope:scope,templateUrl:CmsConfig.buildComponentPath("title-modal","title-modal.html")}),scope.modalInstance.result.then(scope.modalOnOk)["catch"](scope.modalOnCancel)["finally"](function(){scope.modalInstance=!1}))})}}}]),angular.module("topBar.directive",["bulbs.cms.site.config"]).directive("topBar",function(CmsConfig){return{restrict:"E",scope:{logoHref:"@",itemsDropdownTitle:"@",itemsDropdown:"=",itemsTop:"=",saveFunction:"=",saveDisableWhen:"&"},templateUrl:CmsConfig.buildComponentPath("top-bar/top-bar-base.html"),link:function(scope){scope.NAV_LOGO=CmsConfig.getNavLogoPath()}}}),angular.module("topBar.item.factory",[]).factory("TopBarItem",function(){var TopBarItem=function(params){this.displayText=params.displayText||"",this.displayIconClasses=params.displayIconClasses||"",this.containerClasses=params.containerClasses||"",this.clickFunction=params.clickFunction||function(){}};return TopBarItem}),angular.module("topBar",["topBar.directive","topBar.item.factory"]),angular.module("apiServices.mixins.fieldDisplay",["restmod"]).factory("FieldDisplay",function($parse,restmod){var parserWrap=function(value){return function(value){var parsed=$parse(value);return function(record){return parsed({record:record})}}(value)},getOrdering=function(sorts){return function(sorts){return function(direction){var ordering="";return ordering="desc"===direction?"-"+sorts:sorts}}(sorts)};return restmod.mixin(function(){this.define("Scope.$fieldDisplays",function(){var fieldDisplays=this.getProperty("fieldDisplays");if(fieldDisplays){var i;for(i=0;i<fieldDisplays.length;i++){var fieldDisplay=fieldDisplays[i];fieldDisplay.value&&(fieldDisplay.evaluate=parserWrap(fieldDisplay.value)),fieldDisplay.sorts&&("function"==typeof fieldDisplay.sorts?fieldDisplay.getOrdering=fieldDisplay.sorts:fieldDisplay.getOrdering=getOrdering(fieldDisplay.sorts))}}return fieldDisplays})})}),angular.module("apiServices",["restmod","restmod.styles.drfPaged"]).constant("API_URL_ROOT","/cms/api/v1/").config(function(API_URL_ROOT,restmodProvider){restmodProvider.rebase("DjangoDRFPagedApi",{$config:{style:"BulbsApi",urlPrefix:API_URL_ROOT}})}),angular.module("apiServices.campaign.factory",["apiServices","apiServices.mixins.fieldDisplay","filters.moment"]).factory("Campaign",function(restmod){return restmod.model("campaign").mix("FieldDisplay","NestedDirtyModel",{$config:{name:"Campaign",plural:"Campaigns",primaryKey:"id",fieldDisplays:[{title:"Campaign",value:"record.campaignLabel",sorts:"campaign_label"},{title:"Sponsor",value:"record.sponsorName",sorts:"sponsor_name"},{title:"Start Date",value:'record.startDate.format("MM/DD/YY") || "--"',sorts:"start_date"},{title:"End Date",value:'record.endDate.format("MM/DD/YY") || "--"',sorts:"end_date"}]},pixels:{init:[{}]},end_date:{encode:"moment_to_date_string"},start_date:{encode:"moment_to_date_string"},endDate:{decode:"date_string_to_moment"},startDate:{decode:"date_string_to_moment"},$extend:{Model:{simpleSearch:function(searchTerm){return this.$search({search:searchTerm,ordering:"campaign_label"}).$asPromise()}}}})}),angular.module("apiServices.customSearch.count.factory",["apiServices","apiServices.customSearch.settings"]).factory("CustomSearchCount",function(_,CustomSearchSettings,restmod){var Count=restmod.model(CustomSearchSettings.countEndpoint).mix({count:0});return{$retrieveResultCount:function(query){return Count.$create(query).$asPromise().then(function(model){return model.$response.data.root.count})}}}),angular.module("apiServices.customSearch.factory",["apiServices.customSearch.count.factory","apiServices.customSearch.groupCount.factory","apiServices.customSearch.settings","lodash","restmod"]).factory("CustomSearch",function(_,restmod,CustomSearchCount,CustomSearchGroupCount,CustomSearchSettings){var CustomSearch=restmod.model(CustomSearchSettings.searchEndpoint).mix({$config:{jsonRootSingle:"results"},$hooks:{"before-save":function(_req){_req.url+="/?page="+_req.data.page}}});return{$retrieveResultCount:CustomSearchCount.$retrieveResultCount,$retrieveGroupCount:CustomSearchGroupCount.$retrieveResultCount,$retrieveContent:function(query){return CustomSearch.$create(query).$asPromise().then(function(model){return model.$response.data})}}}),angular.module("apiServices.customSearch.groupCount.factory",["apiServices","apiServices.customSearch.settings"]).factory("CustomSearchGroupCount",function(_,CustomSearchSettings,restmod){var Count=restmod.model(CustomSearchSettings.groupCountEndpoint).mix({count:0});return{$retrieveResultCount:function(query){return Count.$create(query).$asPromise().then(function(model){return model.$response.data.root.count})}}}),angular.module("apiServices.customSearch.settings",[]).service("CustomSearchSettings",function(){return{searchEndpoint:"custom-search-content",groupCountEndpoint:"custom-search-content/group_count",countEndpoint:"custom-search-content/count"}}),angular.module("apiServices.featureType.factory",["apiServices"]).factory("FeatureType",["restmod",function(restmod){return restmod.model("things").mix("NestedDirtyModel",{$config:{name:"FeatureType",plural:"FeatureTypes",primaryKey:"id"},$extend:{Model:{simpleSearch:function(searchTerm){return this.$search({type:"feature_type",q:searchTerm}).$asPromise()}}}})}]),angular.module("apiServices.notification.factory",["apiServices","apiServices.customSearch.count.factory","apiServices.mixins.fieldDisplay","filters.moment"]).factory("Notification",function(_,CustomSearchCount,restmod){var notificationEndpoint="notification";return restmod.model(notificationEndpoint).mix("FieldDisplay","NestedDirtyModel",{$config:{name:"Notification",plural:"Notifications",primaryKey:"id",fieldDisplays:[{title:"Internal Name",value:'record.internalTitle || "--"',sorts:"internal_title"},{title:"State",value:'record.isPublished ? "Published" : "Unpublished"',sorts:"is_published"},{title:"Created On",value:'record.createdOn.format("MM/DD/YYYY")',sorts:"created_on"}]},created_on:{encode:"moment_to_date_string"},createdOn:{decode:"date_string_to_moment"}})}),angular.module("apiServices.answer.factory",["apiServices","bulbs.cms.config","lodash"]).factory("Answer",["$http","$q","_","CmsConfig",function($http,$q,_,CmsConfig){function deleteAnswers(deletedAnswers){var deletePromise=_.map(deletedAnswers,function(deletedAnswer){return $http["delete"](answerUrl+deletedAnswer.id)});$q.all(deletePromise).then(function(response){return response})}function putAnswer(oldAnswers,newAnswer){var oldAnswer=_.filter(oldAnswers,{id:newAnswer.id})[0];return newAnswer.answer_text!==oldAnswer.answer_text?$http.put(answerUrl+newAnswer.id,{answer_text:newAnswer.answer_text}).then(function(response){return response.data}):void 0}function postAnswer(answer,pollId){if(!_.isNumber(pollId)||_.isUndefined(answer.answer_text))throw error("poll id and answer_text fields required");return $http.post(answerUrl,{poll:pollId,answer_text:answer.answer_text}).then(function(response){return response.data})}function updatePollAnswers(scope){deleteAnswers(scope.deletedAnswers),_.forEach(scope.answers,function(answer){answer.notOnSodahead?postAnswer(answer,scope.model.id):putAnswer(scope.model.answers,answer)})}var answerUrl=CmsConfig.buildApiUrlRoot("poll-answer/"),error=function(message){return new Error("Poll Error: "+message)};return{postAnswer:postAnswer,updatePollAnswers:updatePollAnswers}}]),angular.module("apiServices.poll.factory",["apiServices","apiServices.mixins.fieldDisplay","bulbsCmsApp.nonRestmodListPage","filters.moment","lodash"]).factory("Poll",["$filter","$http","$q","_","moment","Utils",function($filter,$http,$q,_,moment,Utils){function parsePayload(payload){var data=_.clone(payload),filter=$filter("date_string_to_moment");return data.end_date=filter(data.end_date),data.published=filter(data.published),data}function cleanPayload(originalPayload){var momentToDateString=$filter("moment_to_date_string"),payload=_.clone(originalPayload);if(_.isUndefined(payload.title)&&_.isUndefined(payload.question_text))throw error("title and question text required");if(payload.end_date){if(!moment.isMoment(payload.end_date))throw error("end_date must be a moment object");payload.end_date=momentToDateString(payload.end_date)}if(payload.published){if(!moment.isMoment(payload.published))throw error("published must be a moment object");payload.published=momentToDateString(payload.published)}return _.pick(payload,["title","question_text","published","end_date"])}function getPoll(pollId){return $http.get(pollUrl+pollId+"/").then(function(response){return parsePayload(response.data)})}function getPolls(params){var url=pollUrl+Utils.param(params);return $http.get(url).then(function(response){return response.data.results=response.data.results.map(function(poll){return parsePayload(poll)}),response.data})}function postPoll(data){var payload=cleanPayload(data);return $http.post(pollUrl,payload).then(function(response){return response.data})}function updatePoll(data){var payload=cleanPayload(data);return $http.put(pollUrl+data.id+"/",payload).then(function(response){return response.data})}function deletePoll(pollId){return $http["delete"](pollUrl+pollId+"/").then(function(response){return response})}var error=function(message){return new Error("Poll Error: "+message)},fields=[{title:"Poll Name",sorts:"title"},{title:"Publish Date",sorts:"publish_date",content:function(poll){return poll.published?poll.published.format("MM/DD/YY h:mma"):""}},{title:"Close Date",sorts:"end_date",content:function(poll){return poll.end_date?poll.end_date.format("MM/DD/YY h:mma"):""}}],name="Poll",namePlural="Polls",pollUrl="/cms/api/v1/poll/";return{getPoll:getPoll,getPolls:getPolls,fields:fields,name:name,namePlural:namePlural,postPoll:postPoll,updatePoll:updatePoll,deletePoll:deletePoll}}]),angular.module("apiServices.lineItem.factory",["apiServices","apiServices.mixins.fieldDisplay"]).factory("LineItem",function(_,restmod){var contributorEndpoint="contributions/line-items";return restmod.model(contributorEndpoint).mix("FieldDisplay","NestedDirtyModel",{$config:{name:"Line Item",plural:"Line Items",primaryKey:"id",fieldDisplays:[{title:"Contributor",value:"record.contributor.fullName"},{title:"Amount $",value:"record.amount"},{title:"Note",value:"record.note"},{title:"Date",value:'record.paymentDate.format("MM/DD/YY") || "--"'}]},paymentDate:{decode:"date_string_to_moment",encode:"moment_to_date_string"},payment_date:{decode:"date_string_to_moment",encode:"moment_to_date_string"}})}),angular.module("apiServices.rateOverride.factory",["apiServices","apiServices.mixins.fieldDisplay"]).factory("RateOverride",function(_,restmod){var rateOverrideEndpoint="contributions/rate-overrides";return restmod.model(rateOverrideEndpoint).mix("FieldDisplay","NestedDirtyModel",{$config:{name:"Rate Override",plural:"Rate Overrides",primaryKey:"id",fieldDisplays:[{title:"Name",value:"record.contributor.fullName"},{title:"Role",value:"record.role.name"}]},role:{init:{}},$hooks:{"before-save":function(_req){var featureTypes=_req.data.feature_types;if(featureTypes.length>0)for(var key in featureTypes){var obj=featureTypes[key];obj.hasOwnProperty("featureType")&&(obj.featureType.hasOwnProperty("name")?_req.data.feature_types[key].feature_type=obj.featureType.name:obj.featureType.hasOwnProperty("value")&&(_req.data.feature_types[key].feature_type.slug=obj.featureType.value))}},"before-render":function(record){if(record.hasOwnProperty("feature_types"))for(var key in record.feature_types)record.feature_types[key].hasOwnProperty("feature_type")&&record.feature_types[key].feature_type.hasOwnProperty("name")&&(record.feature_types[key].feature_type=record.feature_types[key].feature_type.name)}}})}),angular.module("apiServices.reporting.factory",["apiServices","apiServices.mixins.fieldDisplay"]).factory("Role",function(_,restmod){var roleEndpoint="contributions/role";return restmod.model(roleEndpoint).mix("FieldDisplay","NestedDirtyModel",{flat_rates:{hasMany:restmod.model(null,{}).mix("NestedDirtyModel"),path:"flat_rates",params:{},hooks:{"after-fetch-many":function(){this.length>0?this.$owner.flat_rate=this[0]:this.$owner.flat_rate=this.$owner.flat_rates.$create({rate:0})}}},hourly_rates:{hasMany:restmod.model(null,{rate:0}).mix("NestedDirtyModel"),path:"hourly_rates",params:{},hooks:{"after-fetch-many":function(){this.length>0?this.$owner.hourly_rate=this[0]:this.$owner.hourly_rate=this.$owner.hourly_rates.$create({rate:0})}}},feature_type_rates:{hasMany:restmod.model(null,{}).mix("NestedDirtyModel"),path:"feature_type_rates",params:{},hooks:{"after-fetch-many":function(){var next=this.$metadata.next;_.isUndefined(next)||null===next||(this.$owner.feature_type_rates.$page++,this.$owner.feature_type_rates.$fetch())}}},$config:{name:"Role",plural:"Roles",primaryKey:"id",fieldDisplays:[{title:"Role",value:"record.name"},{title:"Payment Type",value:"record.paymentType"}]}})}),angular.module("apiServices.section.factory",["apiServices","apiServices.customSearch.count.factory","apiServices.mixins.fieldDisplay"]).factory("Section",function(_,CustomSearchCount,restmod){var sectionEndpoint="section";return restmod.model(sectionEndpoint).mix("FieldDisplay","NestedDirtyModel",{$config:{name:"Section",plural:"Sections",primaryKey:"id",fieldDisplays:[{title:"Section Name",value:"record.name",sorts:"name"},{title:"Article Count",value:"record.$resultCount"}]},query:{init:{}},promoted:{init:!0},$hooks:{"after-fetch":function(){this.$refreshResultCount()},"after-fetch-many":function(){_.each(this,function(record){record.$refreshResultCount()})}},$extend:{Record:{$refreshResultCount:function(){
var record=this;return CustomSearchCount.$retrieveResultCount(this.query).then(function(count){record.$resultCount=count})}}}})}),angular.module("apiServices.specialCoverage.factory",["apiServices","apiServices.campaign.factory","apiServices.mixins.fieldDisplay","cms.tunic.config","filters.moment","VideohubClient.api"]).factory("SpecialCoverage",function(_,$http,$parse,$q,restmod,TunicConfig,Video){var ACTIVE_STATES={INACTIVE:"Inactive",PROMOTED:"Pin to HP"};return restmod.model("special-coverage").mix("FieldDisplay","NestedDirtyModel",{$config:{name:"Special Coverage",plural:"Special Coverages",primaryKey:"id",fieldDisplays:[{title:"List Title",value:"record.name",sorts:"name"},{title:"Sponsor",value:'record.campaign.sponsorName || "--"',sorts:"campaign__sponsor_name"},{title:"Campaign",value:'record.campaign.campaignLabel || "--"',sorts:"campaign__campaign_label"},{title:"Start Date",value:'record.startDate.format("MM/DD/YY") || "--"',sorts:"start_date"},{title:"End Date",value:'record.endDate.format("MM/DD/YY") || "--"',sorts:"end_date"}]},end_date:{encode:"moment_to_date_string"},start_date:{encode:"moment_to_date_string"},endDate:{decode:"date_string_to_moment"},startDate:{decode:"date_string_to_moment"},campaign:{belongsTo:"Campaign",prefetch:!0,key:"campaign"},listUrl:{mask:"CU"},query:{init:{}},videos:{belongsToMany:"Video",keys:"videos"},super_features:{init:[],keys:"super_features"},active:{init:!0},promoted:{init:!1},$hooks:{"after-fetch":function(){this.$loadVideosData()},"after-save":function(){this.$loadVideosData()}},$extend:{Record:{$loadVideosData:function(){_.each(this.videos,function(video){video.$fetch()})},$loadTunicCampaign:function(){return _.isNumber(this.tunicCampaignId)?$http.get(TunicConfig.buildBackendApiUrl("campaign/"+this.tunicCampaignId+"/")).then(function(result){return result.data}):$q.reject()},$searchCampaigns:function(params){return $http.get(TunicConfig.buildBackendApiUrl("campaign/"),{params:params}).then(function(response){return response.data.results})},addVideo:function(video){var added=!1,existingVideo=_.find(this.videos,function(existingVideo){return video.id===existingVideo.id});return existingVideo||(this.videos.push(video),added=!0),added},addSuperFeature:function(superFeature){var existingSuperFeature=this.superFeatures.find(function(existingSuperFeatureId){return superFeature.id===existingSuperFeatureId});existingSuperFeature||this.superFeatures.push(superFeature.id)},$activeState:function(activeState){return _.isString(activeState)?activeState===ACTIVE_STATES.ACTIVE?(this.active=!0,this.promoted=!1):activeState===ACTIVE_STATES.PROMOTED?(this.active=!0,this.promoted=!0):(this.active=!1,this.promoted=!1):(activeState=ACTIVE_STATES.INACTIVE,this.active&&this.promoted?activeState=ACTIVE_STATES.PROMOTED:this.active&&(activeState=ACTIVE_STATES.ACTIVE)),activeState}},Model:{ACTIVE_STATES:_.clone(ACTIVE_STATES)}}})}),angular.module("bulbs.cms.base.config",["bulbs.cms.config","bulbs.cms.customSearch.config","ngClipboard"]).config(["CmsConfigProvider","CustomSearchConfigProvider","ngClipProvider",function(CmsConfigProvider,CustomSearchConfigProvider,ngClipProvider){CmsConfigProvider.setContentPartialsPath("/content_type_views").setComponentPath("/components").setDateTimeFormatHumanReadable("M/D/YY h:mma z").setDirectivePartialsPath("/views").setSharedPath("/shared").setTopBarMapping("nav","/views/nav.html").setTopBarMapping("reportbar","/views/reportbar.html").setTopBarMapping("toolbar","/views/toolbar.html").setUnpublishedPath("unpublished"),CustomSearchConfigProvider.addConditionField("Content Type","content-type","name","doctype").addConditionField("Feature Type","feature-type","name","slug").addConditionField("Tag","tag","name","slug").addConditionType("is any of","any").addConditionType("is all of","all").addConditionType("is none of","none").addTimePeriod("Past Day","Past day").addTimePeriod("Past Week","Past week").addTimePeriod("Past Month","Past month"),ngClipProvider.setPath("/bower_components/zeroclipboard/dist/ZeroClipboard.swf")}]),angular.module("bulbs.cms.config",["bulbs.cms.utils","lodash"]).provider("CmsConfig",["_","UtilsProvider",function(_,Utils){var CmsConfigError=BulbsCmsConfigError.build("CmsConfig"),checkOrError=function(value,test,errorMsg){if(test(value))return value;throw new CmsConfigError(errorMsg)},pathBuilder=function(start){return function(){return Utils.path.join(arguments)}.bind(null,start)},apiUrlRoot="",articleEditoralStatuses=[],autoAddAuthor=!1,componentPath="",contentPartialsPath="",dateTimeFormatHumanReadable="",directivePartialsPath="",cmsName="",contentApiUrl="",externalUrl="",firebaseMaxArticleHistory=25,firebaseSiteRoot="",firebaseUrl="",imageApiUrl="",imageApiKey="",inlineObjectsPath="",internalUrl="",liveBlogAuthorSelectorDirectiveName="",navLogoPath="",sharedPath="",superFeaturesType="",timezoneName="America/Chicago",topBarMappings={},unpublishedPath="",videoPath="",videoThumbnailUrl="";return this.addArticleEditoralStatus=function(label,value){return checkOrError(label,_.isString,"article editoral status label must be a string!"),checkOrError(value,_.isString,"article editoral status value must be a string!"),articleEditoralStatuses.push({label:label,value:value}),this},this.setApiUrlRoot=function(value){return apiUrlRoot=checkOrError(value,_.isString,"api url root must be a string!"),this},this.setAutoAddAuthor=function(value){return autoAddAuthor=checkOrError(value,_.isBoolean,"auto add author must be a boolean!"),this},this.setComponentPath=function(value){return componentPath=checkOrError(value,_.isString,"component path must be a string!"),this},this.setContentPartialsPath=function(value){return contentPartialsPath=checkOrError(value,_.isString,"content partials path must be a string!"),this},this.setDateTimeFormatHumanReadable=function(value){return dateTimeFormatHumanReadable=checkOrError(value,_.isString,"date time format human readable must be a string!"),this},this.setDirectivePartialsPath=function(value){return directivePartialsPath=checkOrError(value,_.isString,"directive partials path must be a string!"),this},this.setCmsName=function(value){return cmsName=checkOrError(value,_.isString,"cms name must be a string!"),this},this.setContentApiUrl=function(value){return contentApiUrl=checkOrError(value,_.isString,"content api url must be a string!"),this},this.setExternalUrl=function(value){return externalUrl=checkOrError(value,_.isString,"external url must be a string!"),this},this.setFirebaseMaxArticleHistory=function(value){return firebaseMaxArticleHistory=checkOrError(value,_.isNumber,"firebase max article history must be a number!"),this},this.setFirebaseSiteRoot=function(value){return firebaseSiteRoot=checkOrError(value,_.isString,"firebase site url must be a string!"),this},this.setFirebaseUrl=function(value){return firebaseUrl=checkOrError(value,_.isString,"firebase url must be a string!"),this},this.setImageApiUrl=function(value){return imageApiUrl=checkOrError(value,_.isString,"image api url must be a string!"),window.BC_ADMIN_URL=imageApiUrl,this},this.setImageApiKey=function(value){return imageApiKey=checkOrError(value,_.isString,"image api key must be a string!"),window.BC_API_KEY=imageApiKey,this},this.setInlineObjectsPath=function(value){return inlineObjectsPath=checkOrError(value,_.isString,"inline objects path must be a string!"),this},this.setInternalUrl=function(value){return internalUrl=checkOrError(value,_.isString,"internal url must be a string!"),this},this.setLiveBlogAuthorSelectorDirectiveName=function(value){return liveBlogAuthorSelectorDirectiveName=checkOrError(value,_.isString,"live blog author selector directive name must be a string!"),this},this.setNavLogoPath=function(value){return navLogoPath=checkOrError(value,_.isString,"nav logo path must be a string!"),this},this.setSharedPath=function(value){return sharedPath=checkOrError(value,_.isString,"shared path must be a string!"),this},this.setSuperFeaturesType=function(value){return superFeaturesType=checkOrError(value,_.isString,"super features type must be a string!"),this},this.setTimezoneName=function(name){return timezoneName=checkOrError(name,moment.tz.zone,'given timezone name "'+name+'" is not a valid timezone!'),this},this.setTopBarMapping=function(name,template){var key=checkOrError(name,_.isString,"top bar mapping name must be a string!"),value=checkOrError(template,_.isString,"top bar mapping template must be a string!");return topBarMappings[key]=value,this},this.setUnpublishedPath=function(value){return unpublishedPath=checkOrError(value,_.isString,"unpublished path must be a string!"),this},this.setVideoPath=function(value){return videoPath=checkOrError(value,_.isString,"video path must be a string!"),this},this.setVideoThumbnailUrl=function(value){return videoThumbnailUrl=checkOrError(value,_.isString,"video thumbnail url must be a string!"),this},this.$get=[function(){return{buildApiUrlRoot:pathBuilder(apiUrlRoot),buildComponentPath:pathBuilder(componentPath),buildContentApiUrl:pathBuilder(contentApiUrl),buildContentPartialsPath:pathBuilder(contentPartialsPath),buildDirectivePartialsPath:pathBuilder(directivePartialsPath),buildExternalUrl:pathBuilder(externalUrl),buildFirebaseSiteUrl:pathBuilder(Utils.path.join(firebaseUrl,firebaseSiteRoot)),buildFirebaseUrl:pathBuilder(firebaseUrl),buildImageApiUrl:pathBuilder(imageApiUrl),buildInternalUrl:pathBuilder(internalUrl),buildSharedPath:pathBuilder(sharedPath),buildUnpublishedUrl:pathBuilder(Utils.path.join(internalUrl,unpublishedPath)),buildVideoUrl:pathBuilder(Utils.path.join(externalUrl,videoPath)),buildVideoThumbnailUrl:pathBuilder(videoThumbnailUrl),getAutoAddAuthor:_.constant(autoAddAuthor),getCmsName:_.constant(cmsName),getDateTimeFormatHumanReadable:_.constant(dateTimeFormatHumanReadable),getFirebaseMaxArticleHistory:_.constant(firebaseMaxArticleHistory),getImageApiKey:_.constant(imageApiKey),getInlineObjecsPath:_.constant(inlineObjectsPath),getLiveBlogAuthorSelectorDirectiveName:_.constant(liveBlogAuthorSelectorDirectiveName),getNavLogoPath:_.constant(navLogoPath),getSuperFeaturesType:_.constant(superFeaturesType),getTimezoneName:_.constant(timezoneName),getArticleEditoralStatuses:_.constant(_.cloneDeep(articleEditoralStatuses)),getTopBarMapping:function(name){if(_.has(topBarMappings,name))return topBarMappings[name];throw new CmsConfigError('no top bar mapping exists for name "'+name+'"!')}}}],this}]),window.BulbsCmsError=function(name,message){"function"==typeof Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=(new Error).stack,this.name=name||"CMS Error",this.message=message||"Something was misconfigured."},BulbsCmsError.prototype=Object.create(Error.prototype),BulbsCmsError.prototype.constructor=window.BulbsCmsError,BulbsCmsError.build=function(name){return function(message){return new BulbsCmsError(name,message)}},window.BulbsCmsConfigError=function(name,message){window.BulbsCmsError.call(this,name,message)},BulbsCmsConfigError.prototype=Object.create(window.BulbsCmsError.prototype),BulbsCmsConfigError.prototype.constructor=window.BulbsCmsConfigError,BulbsCmsConfigError.build=function(name){return function(message){return new BulbsCmsConfigError("Configuration Error ("+(name||"name not given!")+")",message)}},angular.module("contentServices.factory",["bulbs.cms.site.config","restangular"]).factory("ContentFactory",["CmsConfig","Restangular",function(CmsConfig,Restangular){return Restangular.withConfig(function(RestangularConfigurer){RestangularConfigurer.setBaseUrl(CmsConfig.buildApiUrlRoot())})}]),angular.module("contentServices.listService",["contentServices.factory"]).service("ContentListService",function(_,$location,$q,ContentFactory){var ContentListService=this;this._serviceData={filters:$location.search()||{},content:[],totalItems:0};var _data=this._serviceData;ContentListService.updateFilters=function(addFilters,merge){return merge?_data.filters=_.assign($location.search()||{},addFilters):_data.filters=addFilters,$location.search(_data.filters),_data.filters},ContentListService.$updateContent=function(addFilters,merge){var updateParams=ContentListService.updateFilters(addFilters||_data.filters,merge);return ContentFactory.all("content").getList(updateParams).then(function(data){return _data.content=data,_data.totalItems=data.metadata.count,_data})},ContentListService.getData=function(){return _data}}),angular.module("contentServices",["contentServices.factory","contentServices.listService"]),angular.module("copyButton",["bulbs.cms.site.config"]).directive("copyButton",function(CmsConfig){return{controller:function($scope,$timeout){$scope.okCopy=!1,$scope.okCopyButton=function(){$scope.okCopy=!0,$timeout(function(){$scope.okCopy=!1},1e3)}},restrict:"E",scope:{buttonClassesDefault:"@",buttonClassesSuccess:"@",buttonText:"@",content:"@"},templateUrl:CmsConfig.buildSharedPath("copy-button/copy-button.html")}}),angular.module("filters.moment",["moment"]).filter("date_string_to_moment",function(moment){return function(dateStr){if(dateStr&&dateStr.length){var m=moment(new Date(dateStr));if(m.isValid())return m}return null}}).filter("moment_to_date_string",function(moment){return function(momentObj){return moment.isMoment(momentObj)&&momentObj.isValid()?momentObj.format():""}}),angular.module("listPage",["bulbs.cms.site.config","bulbs.cms.utils","confirmationModal","copyButton","lodash"]).directive("listPage",function(CmsConfig){return{controller:function(_,$scope,$location,$parse,Utils){$scope.pathJoin=Utils.path.join,$scope.name=$scope.modelFactory.identity(),$scope.namePlural=$scope.modelFactory.identity(!0),$scope.fields=$scope.modelFactory.$fieldDisplays(),$scope.$list=$scope.modelFactory.$collection(),$scope.orderingFilter={},$scope.searchFilter={},$scope.toggledFilters={},$scope.copyContentInContext=function(record){var value="";return $scope.toolCopyContent&&(value=$parse($scope.toolCopyContent)({record:record})),value},$scope.$retrieve=_.debounce(function(addParams){$scope.loadingResults=!0;var allParams=_.merge({},$scope.orderingFilter,$scope.toggledFilters,$scope.searchFilter,addParams);return $scope.$list.$refresh(allParams).$then(function(){$scope.loadingResults=!1})},250),$scope.$search=function(query){$scope.searchFilter={},query&&($scope.searchFilter[$scope.searchParameter]=query),$scope.$list.$page=1,$scope.$retrieve()},$scope.filterButtonsParsed=$scope.filterButtons(),$scope.$toggleFilters=function(params){$scope.toggledFilters=params,$scope.$list.$page=1,$scope.$retrieve()},$scope.sortingField=null,$scope.sortDirection="asc",$scope.$sort=function(field){var direction;direction=field.title===$scope.sortingField&&"desc"===$scope.sortDirection?"asc":"desc",function(field,direction){$scope.orderingFilter={ordering:field.getOrdering(direction)},$scope.$retrieve().$then(function(){$scope.sortingField=field.title,$scope.sortDirection=direction})}(field,direction)},$scope.$add=function(){$location.path($scope.cmsEditPageUrl({item:{id:"new"}}))},$scope.$remove=function(item){item.$destroy()},$scope.goToEditPage=function(item){$location.path($scope.cmsEditPageUrl({item:item}))},$scope.activeFilterButton=_.chain($scope.filterButtonsParsed).findWhere({active:!0}).tap(function(button){button&&($scope.toggledFilters=button.params)}).result("title").value()||"",$scope.$retrieve()},link:function(scope,element,attrs){scope.showAddButton=!("disableAddButton"in attrs)},restrict:"E",scope:{cmsEditPageUrl:"&",filterButtons:"&",modelFactory:"=",searchParameter:"@",toolCopyContent:"@",utilityButtons:"="},templateUrl:CmsConfig.buildSharedPath("list-page/list-page.html")}}),angular.module("bulbsCmsApp.nonRestmodListPage",["bulbs.cms.site.config","confirmationModal","copyButton","lodash","bulbs.cms.utils"]).directive("nonRestmodListPage",function(CmsConfig){return{controller:function(_,$scope,$location,$parse,Utils){$scope.pathJoin=Utils.path.join,$scope.orderingFilter={},$scope.searchFilter={},$scope.toggledFilters={},$scope.pageNumber=1,$scope.copyContentInContext=function(record){var value="";return $scope.toolCopyContent&&(value=$parse($scope.toolCopyContent)({record:record})),value},$scope.$retrieve=_.debounce(function(addParams){$scope.loadingResults=!0;var allParams=_.merge({},$scope.orderingFilter,$scope.toggledFilters,$scope.searchFilter,addParams);return $scope.getItems({params:allParams}).then(function(response){$scope.items=response.results,$scope.loadingResults=!1})},250),$scope.$search=function(query){$scope.searchFilter={},query&&($scope.searchFilter[$scope.searchParameter]=query),$scope.pageNumber=1,$scope.$retrieve()},$scope.filterButtonsParsed=$scope.filterButtons(),$scope.$toggleFilters=function(params){$scope.toggledFilters=params,$scope.pageNumber=1,$scope.$retrieve()},$scope.sortingField=null,$scope.sortDirection="asc",$scope.$sort=function(fieldName){var direction;direction=fieldName===$scope.sortingField&&"desc"===$scope.sortDirection?"":"-",$scope.orderingFilter={ordering:direction+fieldName},$scope.$retrieve($scope.orderingFilter.ordering).then(function(){$scope.sortingField=fieldName,$scope.sortDirection="-"===direction?"desc":"asc"})},$scope.cellContents=function(item,field){var cellContents="-";return _.isFunction(field.content)?cellContents=field.content(item):_.isString(field.content)?cellContents=item[field.content]:field.sorts&&(cellContents=item[field.sorts]),cellContents},$scope.$add=function(){$location.path($scope.cmsEditPageUrl({item:{id:"new"}}))},$scope.$remove=function(removedItem){$scope.destroyItem({item:removedItem}),_.remove($scope.items,function(item){return item===removedItem})},$scope.goToEditPage=function(item){$location.path($scope.cmsEditPageUrl({item:item}))},$scope.activeFilterButton=_.chain($scope.filterButtonsParsed).findWhere({active:!0}).tap(function(button){button&&($scope.toggledFilters=button.params)}).result("title").value()||"",$scope.$retrieve()},link:function(scope,element,attrs){scope.showAddButton=!("disableAddButton"in attrs)},restrict:"E",scope:{cmsEditPageUrl:"&",destroyItem:"&",getItems:"&",filterButtons:"&",modelFields:"&",modelName:"&",modelNamePlural:"&",searchParameter:"@",toolCopyContent:"@"},templateUrl:CmsConfig.buildSharedPath("non-restmod-list-page/non-restmod-list-page.html")}}),angular.module("cms.tunic.config",["lodash"]).provider("TunicConfig",["_",function(_){var apiPath="",backendRoot="",requestToken="",error=function(message){return new Error("Configuration Error (TunicConfig) "+message)};this.setApiPath=function(value){if(!_.isString(value))throw error("apiPath must be a string!");return apiPath=value,this},this.setBackendRoot=function(value){if(!_.isString(value))throw error("backendRoot must be a string!");return backendRoot=value,this},this.setRequestToken=function(value){if(!_.isString(value))throw error("requestToken must be a string!");return requestToken=value,this},this.$get=function(){return{getRequestToken:_.constant(requestToken),buildBackendApiUrl:function(relUrl){return backendRoot+apiPath+(relUrl||"")},shouldBeIntercepted:function(url){var urlTest=backendRoot+apiPath;return""!==urlTest&&url.startsWith(urlTest)}}}}]),angular.module("cms.tunic.interceptor",["cms.tunic.config"]).service("TunicInterceptor",["TunicConfig",function(TunicConfig){return this.request=function(config){return TunicConfig.shouldBeIntercepted(config.url)&&(config.headers=config.headers||{},config.headers.Authorization="Token "+TunicConfig.getRequestToken()),config},this}]),angular.module("cms.tunic",["cms.tunic.config","cms.tunic.interceptor"]),angular.module("bulbs.cms.utils",["lodash"]).provider("Utils",["_",function(_){var Utils=this;return Utils.slugify=function(text){return text.toString().toLowerCase().replace(/\s+/g,"-").replace(/[^\w\-]+/g,"").replace(/\-\-+/g,"-").replace(/^-+/,"").replace(/-+$/,"")},Utils.toCamelCase=function(snakeCaseString,sep){if("string"==typeof snakeCaseString){var separator=sep||"_",matcher=new RegExp(separator+"\\w?","g");return snakeCaseString.replace(matcher,function(group){return group.length>1?group[1].toUpperCase():""})}},Utils.toSnakeCase=function(camelCaseString,sep){if("string"==typeof camelCaseString){var separator=sep||"_";return camelCaseString.replace(/[A-Z]/g,function(group){return separator+group.toLowerCase()})}},Utils.moveTo=function(list,indexFrom,indexTo,allowOutOfBounds){var ret=!1,modIndexTo=indexTo;if(allowOutOfBounds&&(0>indexTo?modIndexTo=0:indexTo>=list.length&&(modIndexTo=list.length-1)),indexFrom>=0&&indexFrom<list.length&&modIndexTo>=0&&modIndexTo<list.length){var splicer=list.splice(indexFrom,1,list[modIndexTo]);splicer.length>0&&(list[modIndexTo]=splicer[0],ret=!0)}return ret},Utils.removeFrom=function(list,index){return list.splice(index,1).length>0},Utils.param=function(params){params||(params={});var keys=Object.keys(params),query="";return keys.length>0&&(query+="?",query+=keys.map(function(key){return key+"="+params[key]}).join("&")),query},Utils.path={join:function(){var sep="/",replace=new RegExp(sep+"{1,}","g"),argsArr=_.flattenDeep(arguments),protocolPrefix="";if(argsArr.length>0&&"string"==typeof argsArr[0]){var matches=argsArr[0].match(/^(https?:)?\/\//);matches&&(protocolPrefix=matches[0],argsArr[0]=argsArr[0].replace(protocolPrefix,""))}return protocolPrefix+argsArr.join(sep).replace(replace,sep)}},Utils.$get=["$q",function($q){return Utils.buildLock=function(){var locked=!1,wrapper=function(func){return function(){return locked?$q.reject():(locked=!0,$q.when(func.apply(null,arguments))["finally"](function(){locked=!1}))}};return wrapper.isLocked=function(){return locked},wrapper},Utils}],Utils}]),angular.module("videoList.video.directive",["bulbs.cms.site.config","filters.moment"]).directive("videoListVideo",function(CmsConfig){return{restrict:"E",scope:{model:"="},templateUrl:CmsConfig.buildSharedPath("video-list/video-list-video/video-list-video.html")}}),angular.module("videoList",["autocompleteBasic","bulbs.cms.site.config","bulbs.cms.utils","jquery","ui.sortable","VideohubClient.api","VideohubClient.settings","videoList.video.directive"]).directive("videoList",function($,CmsConfig){return{controller:function(_,$scope,Utils,Video,VIDEOHUB_DEFAULT_CHANNEL){$scope.videoChannel=VIDEOHUB_DEFAULT_CHANNEL,$scope.moveUp=function(index){Utils.moveTo($scope.videos,index,index-1),$scope.onUpdate()},$scope.moveDown=function(index){Utils.moveTo($scope.videos,index,index+1),$scope.onUpdate()},$scope["delete"]=function(index){Utils.removeFrom($scope.videos,index),$scope.onUpdate()},$scope.addVideo=function(video){$scope.addVideoCallback({video:video}),$scope.onUpdate()},$scope.searchVideos=function(query){return Video.$postSearch({query:query,channel:VIDEOHUB_DEFAULT_CHANNEL})}},link:function(scope,element,attr){scope.sortableOptions={beforeStop:function(e,ui){ui.helper.css("margin-top",0)},change:function(e,ui){ui.helper.css("margin-top",$(window).scrollTop())},containment:"video-list",distance:3,opacity:.75,placeholder:"dropzone",start:function(e,ui){ui.helper.css("margin-top",$(window).scrollTop())}}},restrict:"E",scope:{addVideoCallback:"&addVideo",videos:"=",onUpdate:"&"},templateUrl:CmsConfig.buildSharedPath("video-list/video-list.html")}}),angular.module("bulbsCmsApp").directive("activeNav",function($location){return{template:'<li><a href="{{href}}">{{label}}</a></li>',restrict:"E",scope:{},replace:!0,link:function(scope,element,attrs){scope.href=attrs.href,scope.label=attrs.label,0===$location.path().indexOf(scope.href)&&element.addClass("active")}}}),angular.module("bulbsCmsApp").directive("addImage",function($http,$window){return{restrict:"E",templateUrl:"/views/add-image.html",scope:{article:"="},link:function(scope,element,attrs){var attrName=attrs.attrName||"images";scope.article[attrName]=scope.article[attrName]||[],"false"===attrs.caption&&(scope.hideCaption=!0),scope.format=attrs.format||"jpg",scope.crop=attrs.crop||"16x9",scope.placeholderText=attrs.placeholderText||"Optional Image",scope.addAnImage=function(){$window.uploadImage({onSuccess:function(data){scope.$apply(function(){scope.article[attrName].push({id:data.id.toString(),alt:null,caption:null}),setTimeout($window.picturefill,200)})},onError:function(data){scope.$apply(function(){$window.alert("Error: ",data)})},onProgress:function(data){}})}}}}),angular.module("bulbsCmsApp").directive("articlecontainer",function(){return{restrict:"E",templateUrl:"/views/promotion-tool-article-container.html",scope:{article:"="},link:function(scope,element,attrs){scope.ratio=attrs.ratio}}}),angular.module("bulbsCmsApp").directive("authorsField",function($,CmsConfig,userNameDisplayFilter,Utils){return{templateUrl:"/views/taglike-autocomplete-field.html",restrict:"E",replace:!0,scope:{article:"=",inputLabelText:"@",inputLabelTextSub:"@"},link:function(scope,element,attrs){scope.name="author",scope.label=scope.inputLabelText||"Authors",scope.labelSub=scope.inputLabelTextSub,scope.placeholder="Authors",scope.resourceUrl=CmsConfig.buildApiUrlRoot("author",Utils.param({ordering:"name",search:""})),scope.display=userNameDisplayFilter,scope.$watch("article.authors",function(){scope.objects=scope.article.authors},!0),scope.add=function(o,input){for(var t in scope.article.authors)if(scope.article.authors[t].id===o.id)return;scope.article.authors.push(o),$(input).val("")},scope["delete"]=function(e){var author=$(e.target).parents("[data-taglikeobject]").data("taglikeobject"),id=author.id,newauthors=[];for(var i in scope.article.authors)scope.article.authors[i].id!==id&&newauthors.push(scope.article.authors[i]);scope.article.authors=newauthors}}}}),angular.module("bulbsCmsApp").directive("bulbsAutocomplete",function($http,$location,$compile,$timeout,$,Login,Raven){var autocomplete_dropdown_template='<div class="autocomplete dropdown" ng-show="autocomplete_list"><div class="entry" ng-repeat="option in autocomplete_list" ng-click="onClick(option)">{{display(option);}}</div></div>';return{restrict:"AC",link:function(scope,element,attrs){function getAutocompletes(val){$timeout.cancel(inputTimeout),inputCounter=0,$http({method:"GET",url:scope.resourceUrl+val}).success(function(data){var results=data.results||data;scope.autocomplete_list=results.splice(0,5)}).error(function(data,status,headers,config){Raven.captureMessage("Error in getAutocompletes",{extra:data})})}var $elem=$(element).find("input");$elem.attr("autocomplete","off");var dropdown=$($compile(autocomplete_dropdown_template)(scope));$(dropdown).css({position:"absolute",top:$elem.position().top+$elem.outerHeight(),left:$elem.position().left,minWidth:$elem.outerWidth(),display:"none"}),$elem.parent().append(dropdown),$(dropdown).fadeIn("fast"),scope.$watch(function(){return{top:$elem.position().top+$elem.outerHeight(),left:$elem.position().left,minWidth:$elem.outerWidth()}},function(newValue,oldValue){$(dropdown).css({top:newValue.top,left:newValue.left,minWidth:newValue.minWidth})},!0);var inputTimeout,inputCounter=0;$elem.on("focus",function(e){$elem.on("input",function(){var val=$elem.val();""===val?scope.autocomplete_list=[]:($timeout.cancel(inputTimeout),inputTimeout=$timeout(function(){getAutocompletes(val)},200),inputCounter>2&&getAutocompletes(val))}),$(dropdown).fadeIn("fast")}),$elem.on("blur",function(e){$(dropdown).fadeOut("fast")}),$(dropdown).on("mouseover",".entry",function(e){$(dropdown).find(".selected").removeClass("selected"),$(this).addClass("selected")}),$elem.on("keyup",function(e){if(40===e.keyCode)if(0===$("div.selected",dropdown).length)$("div.entry",dropdown).first().addClass("selected");else{var curDownSelect=$("div.selected",dropdown),curDownSelectNext=curDownSelect.next("div");0===curDownSelectNext.length?$("div.entry",dropdown).first().addClass("selected"):curDownSelectNext.addClass("selected"),curDownSelect.removeClass("selected")}if(38===e.keyCode)if(0===$("div.selected",dropdown).length)$("div.entry",dropdown).last().addClass("selected");else{var curSelect=$("div.selected",dropdown),curSelectNext=curSelect.prev("div");0===curSelectNext.length?$("div.entry",dropdown).last().addClass("selected"):curSelectNext.addClass("selected"),curSelect.removeClass("selected")}if(13===e.keyCode){var selected=$("div.selected",dropdown);0===selected.length&&scope.onClick($elem.val(),!0),selected.click()}}),scope.onClick=function(o,freeForm){scope.add(o,$elem,freeForm||!1),scope.autocomplete_list=[]}}}}),angular.module("bulbsCmsApp").directive("cmsNotification",function(){return{restrict:"E",templateUrl:"/views/cms-notification.html",scope:{cmsNotification:"="},controller:"CmsNotificationCtrl"}}),angular.module("bulbsCmsApp").directive("cmsNotifyContainer",function(){return{restrict:"E",scope:{},templateUrl:"/views/cms-notify-container.html",controller:"CmsNotifyContainerCtrl"}}),angular.module("bulbsCmsApp").directive("contributorField",function($){return{templateUrl:"/views/textlike-autocomplete-field.html",restrict:"E",replace:!0,scope:{override:"="},link:function(scope,element,attrs){scope.name="contributor",scope.label="Contributors",scope.placeholder="Contributors",scope.resourceUrl="/cms/api/v1/author/?ordering=name&search=",scope.$watch("override.contributor",function(){scope.override.hasOwnProperty("contributor")&&null!==scope.override.contributor&&(scope.model=scope.override.contributor.full_name||scope.override.contributor.fullName)}),scope.display=function(o){return o&&o.full_name||""},scope.add=function(o,input){scope.override.hasOwnProperty("contributor")&&null!==scope.override.contributor&&scope.override.contributor.id===o.id||(scope.override.contributor=o,$("#feature-type-container").removeClass("newtag"),$("#feature-type-container").addClass("newtag"))},scope["delete"]=function(e){scope.override.contributor=null,scope.model=null}}}}),angular.module("bulbsCmsApp").directive("createContent",function($http,$window,$,IfExistsElse,Login,ContentFactory,CmsConfig,Raven){return{restrict:"E",templateUrl:CmsConfig.buildDirectivePartialsPath("create-content.html"),controller:function($scope){function saveArticle(){$("button.go").removeClass("btn-danger").addClass("btn-success").html('<i class="fa fa-refresh fa-spin"></i> Going'),$http({url:"/cms/api/v1/content/?doctype="+$scope.contentType,method:"POST",data:$scope.init}).success(function(resp){var new_id=resp.id,new_path="/cms/app/edit/"+new_id+"/";$scope.rating_type&&(new_path+="?rating_type="+$scope.rating_type),$window.location.href=$window.location.origin+new_path}).error(function(data,status,headers,config){403===status?$("button.go").html('<i class="glyphicon glyphicon-exclamation-sign"></i> Please Log In'):$("button.go").removeClass("btn-success").addClass("btn-danger").html('<i class="glyphicon glyphicon-remove"></i> Error'),$scope.gotSave=!1})}$scope.gotTags=!1,$scope.gotUser=!1,$scope.gotSave=!1,$scope.$watch(function(){return $scope.gotTags&&$scope.gotUser&&$scope.gotSave},function(val){val&&saveArticle($scope.init)}),$scope.newArticle=function(e){var init={title:$scope.newTitle};angular.extend($scope.init,init),$scope.tag?IfExistsElse.ifExistsElse(ContentFactory.all("tag").getList({ordering:"name",search:$scope.tag,types:"core_section"}),{slug:$scope.tag},function(tag){$scope.init.tags=[tag],$scope.gotTags=!0},function(value){console.log("couldnt find tag "+value.slug+" for initial value")},function(data,status,headers,config){Raven.captureMessage("Error Creating Article",{extra:data})}):$scope.gotTags=!0,CmsConfig.getAutoAddAuthor()?ContentFactory.one("me").get().then(function(data){$scope.init.authors=[data],$scope.gotUser=!0}):$scope.gotUser=!0,$scope.gotSave=!0}},link:function(scope,element,attrs){scope.panel=1,$(element).find("a.create-content").on("click",function(e){$("a.create-content.active").removeClass("active"),$(this).addClass("active")}),$(element).find("a.create-content").on("click",function(e){return scope.contentTypeLabel=$(this).text(),scope.contentType=$(this).data("content_type")||null,scope.init=$(this).data("init")||{},scope.tag=$(this).data("tag")||null,scope.rating_type=$(this).data("rating_type")||null,
scope.$apply(),$(this).hasClass("go-next")?(e.preventDefault(),$("#create button.next-pane").click(),!1):!0}),$("button.next-pane:not(.hide)").on("click",function(e){scope.panel=2,$(".new-title").focus()}),$(element).on("keydown",".editor",function(e){13===e.keyCode&&scope.newTitle&&$(element).find(".go").click()}),$("#create").on("hidden.bs.modal",function(){scope.newTitle="",scope.panel=1})}}}),angular.module("bulbsCmsApp").directive("devicepreview",function($){return{restrict:"E",templateUrl:"/views/devicepreview.html",link:function(scope,element,attrs){var pP=$("#page-prev"),tN=pP.find(".nav a"),cO=pP.find(".tab-content .active");tN.click(function(e){var newId=$(this).attr("href").split("#")[1];e.preventDefault(),cO.attr("id",newId)}),$("#page-prev").on("show.bs.collapse",function(){$(this).find(".fa").removeClass("fa-plus-square-o").addClass("fa-minus-square-o")}),$("#page-prev").on("hide.bs.collapse",function(){$(this).find(".fa").removeClass("fa-minus-square-o").addClass("fa-plus-square-o")})}}}),angular.module("bulbsCmsApp").directive("encodeStatus",function($http,$interval,$,Zencoder){return{templateUrl:"/views/encode-status.html",restrict:"E",link:function(scope,element,attrs){function updateEncodeStatuses(){var updateEncodeStatus=function(i){return function(videoid){Zencoder.encodingVideos[videoid].encode_status_endpoints&&Zencoder.encodingVideos[videoid].encode_status_endpoints.json&&$http({method:"GET",url:Zencoder.encodingVideos[videoid].encode_status_endpoints.json,headers:{"X-CSRFToken":void 0}}).success(function(data){scope.encodingVideos[videoid].job_status=data,"finished"===data.state&&(scope.encodingVideos[videoid].finished=!0)})}(i)};for(var i in Zencoder.encodingVideos)scope.encodingVideos[i]&&scope.encodingVideos[i].finished||(scope.encodingVideos[i]=Zencoder.encodingVideos[i],updateEncodeStatus(i))}scope.encodingVideos={},scope.$watch(function(){return Zencoder.encodingVideos},function(){updateEncodeStatuses()},!0),$interval(function(){$("iframe").filter(function(){return this.src.match(/\/video\/embed\/?/)}).each(function(){var idRegex=/\/video\/embed\/?\?id=(\d+)/,id=idRegex.exec(this.src)[1];id in Zencoder.encodingVideos||Zencoder.getVideo(id).then(function(data){Zencoder.encodingVideos[id]=data.data})}),updateEncodeStatuses()},5e3)}}}),angular.module("bulbsCmsApp").directive("featuretypeField",function(IfExistsElse,ContentFactory,Raven,$){return{templateUrl:"/views/textlike-autocomplete-field.html",restrict:"E",scope:{article:"=",hideLabel:"="},replace:!0,link:function(scope,element,attrs){scope.name="feature_type",scope.label="Feature Type",scope.placeholder="Feature Type",scope.resourceUrl="/cms/api/v1/things/?type=feature_type&q=",scope.$watch("article.feature_type",function(){scope.model=scope.article.feature_type}),scope.display=function(o){return o&&o.name||""},scope.add=function(o,input,freeForm){var fVal=freeForm?o:o.name;IfExistsElse.ifExistsElse(ContentFactory.all("things").getList({type:"feature_type",q:fVal}),{name:fVal},function(ft){scope.article.feature_type=ft.name,$("#feature-type-container").removeClass("newtag")},function(value){scope.article.feature_type=value.name,$("#feature-type-container").addClass("newtag")},function(data,status){Raven.captureMessage("Error Adding Feature Type",{extra:data})})},scope["delete"]=function(e){scope.article.feature_type=null}}}}),angular.module("bulbsCmsApp").directive("hideIfForbidden",function($http){function hideElement(element){element.addClass("hidden")}return{restrict:"A",link:function(scope,element,attrs){$http({method:"OPTIONS",url:attrs.optionsUrl,noPermissionIntercept:!0}).success(function(data,status){403===status&&hideElement(element)}).error(function(data,status){403===status&&hideElement(element)})}}}),angular.module("bulbsCmsApp").directive("lazyInclude",function($,$compile,$q,$http,$templateCache,Gettemplate){return{restrict:"A",scope:!0,link:function(scope,element,attrs){var templateUrl="/views/"+attrs.template,$element=$(element);scope.$evalAsync(function(){scope.$watch(function(){return $element.is(":visible")},function(visible){visible&&!scope.loaded&&(scope.loaded=!0,Gettemplate.get(templateUrl).then(function(html){var template=angular.element(html),compiledEl=$compile(template)(scope);element.html(compiledEl),element.css("height","auto")}))})})}}}),angular.module("bulbsCmsApp").directive("loggedInUser",function(CurrentUserApi){return{restrict:"E",replace:!0,templateUrl:"/views/logged-in-user.html",scope:{},link:function(scope,element,attrs){CurrentUserApi.getCurrentUserWithCache().then(function(user){scope.currentUser=user,scope.logout=CurrentUserApi.logout})}}}),angular.module("bulbsCmsApp").directive("navBar",function(CmsConfig,CurrentUserApi){return{restrict:"E",scope:!1,templateUrl:function(tElement,tAttrs){return CmsConfig.getTopBarMapping(tAttrs.view)},link:function(scope){scope.NAV_LOGO=CmsConfig.getNavLogoPath(),CurrentUserApi.getCurrentUserWithCache().then(function(user){scope.currentUser=user})}}}),angular.module("bulbsCmsApp").directive("responsiveImage",function($window,$){return{link:function(scope,element,attrs){attrs.$observe("imageId",function(val){$(element).find("img").remove(),element.attr("data-image-id",attrs.imageId),element.attr("data-crop",attrs.crop),attrs.imageId&&$(element).is(":visible")&&($window.pictureFillElement(element[0]),element.show())})}}}),angular.module("bulbsCmsApp").directive("roleField",function($http,$,Raven){return{templateUrl:"/views/rolefield.html",restrict:"E",replace:!0,scope:{model:"="},link:function(scope,element,attrs){var resourceUrl="/cms/api/v1/contributions/role/";scope.roleValue=null,scope.roleOptions=[],scope.$watch("model.role",function(){for(var i=0;i<scope.roleOptions.length;i++)scope.roleOptions[i].id===Number(scope.roleValue)&&(scope.model.role=scope.roleOptions[i]);scope.roleValue=scope.model.role.id}),$http({method:"GET",url:resourceUrl}).success(function(data){scope.roleOptions=data.results||data}).error(function(data,status,headers,config){Raven.captureMessage("Error fetching Roles",{extra:data})})}}}),angular.module("bulbsCmsApp").directive("saveButtonOld",function($q,$timeout,$window){return{replace:!0,restrict:"E",templateUrl:"/views/save-button.html",scope:{getPromise:"&",saveCbk:"&onSave",config:"=?",colors:"@?colorStyling"},link:function(scope,element,attrs){scope.colors_tmp=scope.colors,attrs.$observe("config",function(val){angular.isDefined(val)||(scope.config={idle:"<i class='glyphicon glyphicon-floppy-disk'></i> Save",busy:"Saving",finished:"Saved",error:"Error"})}),scope.save=function(){if(attrs.confirmClickWith){var message=attrs.confirmClickWith;if(!$window.confirm(message))return}scope.colors=scope.colors_tmp,element.prop("disabled",!0).html("<i class='fa fa-refresh fa-spin'></i> "+scope.config.busy);var save_promise=scope.getPromise(),saveSuccess=function(result){return scope.colors=scope.colors_tmp,element.prop("disabled",!1).html("<i class='glyphicon glyphicon-ok'></i> "+scope.config.finished),$timeout(function(){element.html(scope.config.idle)},1e3).then(function(){return result})};if(save_promise){var promise=save_promise.then(saveSuccess)["catch"](function(reason){return scope.colors="btn-danger",element.prop("disabled",!1).html("<i class='glyphicon glyphicon-remove'></i> "+scope.config.error),$q.reject(reason)});scope.saveCbk&&scope.saveCbk({promise:promise})}else saveSuccess()}}}}),angular.module("bulbsCmsApp").directive("sectionsField",function(_,IfExistsElse,ContentFactory,Raven,$){return{templateUrl:"/views/taglike-autocomplete-field.html",restrict:"E",replace:!0,link:function(scope,element,attrs){scope.name="section",scope.label="Sections",scope.placeholder="Enter a section",scope.resourceUrl="/cms/api/v1/tag/?ordering=name&types=core_section&search=",scope.display=function(o){return o.name},scope.$watch("article.tags",function(){scope.objects=_.where(scope.article.tags,{type:"core_section"})},!0),scope.add=function(o,input,freeForm){var tagVal=freeForm?o:o.name;IfExistsElse.ifExistsElse(ContentFactory.all("tag").getList({ordering:"name",search:tagVal,types:"core_section"}),{name:tagVal},function(tag){scope.article.tags.push(tag)},function(){console.log("Can't create sections.")},function(data,status){Raven.captureMessage("Error Adding Section",{extra:data})}),$(input).val("")},scope["delete"]=function(e){var tag=$(e.target).parents("[data-taglikeobject]").data("taglikeobject"),name=tag.name,newtags=[];for(var i in scope.article.tags)scope.article.tags[i].name!==name&&newtags.push(scope.article.tags[i]);scope.article.tags=newtags}}}}),angular.module("bulbsCmsApp").directive("slideshowPane",function($http,$window,$compile,$){return{restrict:"E",templateUrl:"/views/slideshow-pane.html",scope:{article:"=",image:"=",index:"="},link:function(scope,element,attrs){var $element=$(element);"false"===attrs.caption&&(scope.hideCaption=!0),scope.format=attrs.format||"jpg",scope.crop=attrs.crop||"16x9",scope.removeImage=function(index){scope.article.slides.splice(index,1)},scope.editImage=function(index){var loadingClass="loading-class";$window.openImageDrawer(scope.article.slides[index].id,function(data){function removeLoadingGif(){$element.find(".image ."+loadingClass).remove()}removeLoadingGif(),$element.find(".image").data("imageId")!==data.id&&($element.find(".image img").on("load",removeLoadingGif),$element.find(".image img").after('<i class="'+loadingClass+' fa fa-spinner fa-spin">'),scope.article.slides[index].id=data.id.toString(),scope.$apply(),$window.picturefill(),$element.find(".image img")[0].complete&&removeLoadingGif())},function(){},function(oldImage){scope.article.slides[index]=oldImage,$window.picturefill()})}}}}),angular.module("bulbsCmsApp").directive("tagsField",function(_,IfExistsElse,ContentFactory,Raven,$){return{templateUrl:"/views/taglike-autocomplete-field.html",restrict:"E",scope:{article:"="},replace:!0,link:function(scope,element,attrs){scope.name="tag",scope.label="Tags",scope.placeholder="Enter a tag",scope.resourceUrl="/cms/api/v1/tag/?ordering=name&types=content_tag&search=",scope.display=function(o){return o.name},scope.$watch("article.tags",function(){scope.objects=_.where(scope.article.tags,{type:"content_tag"})},!0),scope.add=function(o,input,freeForm){var tagVal=freeForm?o:o.name;IfExistsElse.ifExistsElse(ContentFactory.all("tag").getList({ordering:"name",search:tagVal}),{name:tagVal},function(tag){scope.article.tags.push(tag)},function(value){scope.article.tags.push({name:value.name,type:"content_tag","new":!0})},function(data,status){Raven.captureMessage("Error Adding Tag",{extra:data})}),$(input).val("")},scope["delete"]=function(e){var tag=$(e.target).parents("[data-taglikeobject]").data("taglikeobject"),name=tag.name,newtags=[];for(var i in scope.article.tags)scope.article.tags[i].name!==name&&newtags.push(scope.article.tags[i]);scope.article.tags=newtags}}}}),angular.module("bulbsCmsApp").directive("targeting",function(){return{restrict:"E",templateUrl:"/views/targeting.html",link:function(scope,element,attrs){scope.addTargetingRow=function(index){scope.targetingArray.push([])},scope.removeTargetingRow=function(index){scope.targetingArray.splice(index,1)}}}}),angular.module("bulbsCmsApp").directive("videoUpload",function($http,$window,$timeout,$sce,$){return{templateUrl:"/views/mainvideo.html",scope:{article:"="},restrict:"E",link:function(scope,element,attrs){function abortUpload(){setProgress(0),scope.req&&scope.req.abort(),scope.video={},setProgress(0)}function abortEncode(){$.ajax("https://app.zencoder.com/api/v2/jobs/"+scope.video.job_id+"/cancel.json?api_key="+$window.videoAttrs.zencoderApiKey,{type:"PUT",success:function(data){scope.video.status=3,fakeInput.val("Encoding failed! Please try again.")}})}function setProgress(progress){return 0===progress||100===progress?void progressEl.hide():void((0===scope.lastProgress||Math.abs(progress-scope.lastProgress)>2)&&(progressBar.css("width",Math.floor(progress)+"%"),scope.lastProgress=progress,progressEl.show()))}function updateEncodeProgress(){progressBar.addClass("progress-bar-success"),delete $http.defaults.headers.common["X-Requested-With"],$http({url:"https://app.zencoder.com/api/v2/jobs/"+scope.video.job_id+"/progress.json",method:"GET",params:{api_key:$window.videoAttrs.zencoderApiKey},useXDomain:!0}).success(function(data){"waiting"===data.state||"pending"===data.state||"processing"===data.state?(scope.video.status=2,data.progress>5?(setProgress(data.progress),$timeout(updateEncodeProgress,500)):$timeout(updateEncodeProgress,2e3)):(setProgress(0),"finished"===data.state&&(scope.video.status=1),("failed"===data.state||"cancelled"===data.state)&&(scope.video.status=3,fakeInput.val("Encoding failed! Please try again.")))}).error(function(data){$(".alert-danger").fadeIn().delay(1e3).fadeOut()})}console.log("video upload here"),console.log(scope.video_id),scope.$watch("article.video",function(){scope.article.video&&(scope.embedUrl=$sce.trustAsUrl("/video/embed?id="+scope.article.video),$http({method:"GET",url:"/videos/api/video/"+scope.article.video+"/"}).success(function(data){console.log("getting video from API"),console.log(data),scope.video=data,$window.initVideoWidget(data.id)}))}),scope.$watch("video",function(){});var progressEl=element.find("div.progress"),progressBar=element.find("div.progress-bar"),fakeInput=element.find("input.fake-input");scope.lastProgress=0,scope.addVideo=function(){console.log("chooseFile"),$window.uploadVideo(element.find(".video-container")[0],{onSuccess:function(videoid){scope.$apply(function(){console.log("addVideo onSuccess callback"),console.log(videoid),scope.article.video=videoid})},onError:function(data){console.log("addVideo onError callback"),console.log(data)},onProgress:function(data){console.log("addVideo onProgress callback"),console.log(data)}})},scope.clearVideo=function(areYouSure){areYouSure?($("#s3upload-file-input").val(""),scope.article.video=null):$("#confirm-clear-video-modal").modal("show")},scope.abort=function(){return scope.encoding?void abortEncode():void abortUpload()};var initialCheckRan=!1;scope.$watch("video",function(){scope.video&&scope.video.job_id&&!initialCheckRan&&(updateEncodeProgress(),initialCheckRan=!0)})}}}),angular.module("bulbsCmsApp").directive("videoEmbed",function(CmsConfig){return{template:'<div class="video-embed"><iframe src="{{videoUrl}}"></iframe></div>',restrict:"E",link:function(scope,element,attrs){scope.videoUrl=CmsConfig.buildVideoUrl(attrs.videoId)}}}),angular.module("bulbsCmsApp").directive("videoField",function(Zencoder){return{templateUrl:"/views/video-field.html",restrict:"E",scope:{article:"="},link:function(scope,element,attrs){scope.removeVideo=function(){scope.article.video=null},scope.uploadVideo=function(){Zencoder.onVideoFileUpload().then(function(success){console.log(success),scope.article.video=success.attrs.id},angular.noop,function(progress){console.log(progress),scope.uploadProgress=progress})},scope.thumbnailModal=function(){Zencoder.openVideoThumbnailModal(scope.article.video).result.then(function(resolve){console.log("thumbnail modal resolve"),console.log(resolve)},function(reject){console.log("thumbnail modal rejected")})}}}}),angular.module("bulbsCmsApp").directive("autocompleteMenu",function($timeout,$animate,$compile){return{restrict:"E",replace:!0,transclude:!0,controller:angular.noop,scope:{items:"=items",pIndex:"=index",select:"&select"},link:function($scope,element,attrs){$scope.selectItem=function(index){$scope.select(index)},$scope.setIndex=function(index){$scope.index=index,attrs.index&&($scope.pIndex=parseInt(index,10))},attrs.index&&$scope.$watch("pIndex",function(value){$scope.index=parseInt(value,10)}),$scope.label=function(index){var viewValue=$scope.items[index][attrs.labelAttr];return"function"==typeof viewValue&&(viewValue=viewValue()),viewValue}},template:'<ul class="autocomplete-menu" ng-show="items.length !== 0"><li ng-repeat="item in items" ng-click="select($index)" ng-class="{\'active\': $index == index}" ng-mouseenter = "setIndex($index)"><span>{{ label($index) }}</span></li></ul>'}}),angular.module("bulbsCmsApp").directive("autocomplete",function($timeout,$animate,$compile){return{restrict:"E",replace:!0,require:"ngModel",transclude:!0,controller:function($scope,$element,$attrs,$injector){$scope.service=$injector.get($attrs.service),$scope.placeholder=$attrs.placeholder||""},link:function($scope,element,attrs,ngModel,transclude){function queryData(query){var searchParams={};searchParams[attrs.searchParam||"search"]=query,$scope.service.getList(searchParams).then(function(results){results.length>5?menuScope.items=results.slice(0,5):menuScope.items=results,timeoutId=null})}function appendMenu(){isMenuAppended||(isMenuAppended=!0,menuScope.index=0,$animate.enter(menuEl,element.parent(),element)),styleMenu()}function reset(){ngModel.$render(),menuScope.items=[],menuScope.index=0,$animate.leave(menuEl)["finally"](function(){isMenuAppended=!1})}function styleMenu(){var offset=(window.getComputedStyle(element[0]),element.offset());offset.left="auto",offset.right="auto",offset.top=element.outerHeight(),offset.minWidth=element.outerWidth(),angular.forEach(offset,function(value,key){!isNaN(value)&&angular.isNumber(value)&&(value+="px"),menuEl[0].style[key]=value,menuEl.css("z-index",1e3)})}var isMenuAppended=!1,inputEl=element.find("input"),timeoutId=null;ngModel.$render=function(){if(ngModel.$viewValue){var viewValue=ngModel.$viewValue[attrs.labelAttr];"function"==typeof viewValue&&(viewValue=viewValue()),element.find("input").val(viewValue),inputEl.attr("disabled","disabled")}},$scope.openMenu=function(e){inputEl.removeAttr("disabled"),inputEl[0].focus()},inputEl.on("blur keyup change",function(){if(void 0===inputEl.attr("disabled")){appendMenu();var value=inputEl.val();value&&(timeoutId&&$timeout.cancel(timeoutId),timeoutId=$timeout(function(){queryData(value)},150))}});var menuScope=$scope.$new();menuScope.items=[],menuScope.index=0,menuScope.select=function(index){ngModel.$setViewValue(menuScope.items[index]),reset()};var menuEl=angular.element(document.createElement("autocomplete-menu"));menuEl.attr({items:"items",select:"select(index)",index:"index","label-attr":attrs.labelAttr}),transclude(menuScope,function(clone){menuEl.append(clone)}),$compile(menuEl)(menuScope),element.find("input").on("keyup",function(e){switch(e.which){case 27:""===inputEl.val()?reset():inputEl.val("");break;case 40:$scope.$apply(function(){menuScope.index=(menuScope.index+1)%menuScope.items.length});break;case 38:$scope.$apply(function(){menuScope.index?menuScope.index=menuScope.index-1:menuScope.index=menuScope.items.length-1});break;case 13:menuScope.index>=0&&(ngModel.$setViewValue(menuScope.items[menuScope.index]),reset());break;default:return}})},templateUrl:"/views/autocomplete.html"}}),angular.module("bulbsCmsApp").controller("BadrequestmodalCtrl",function($scope,$modalInstance,detail){$scope.detail=detail}),angular.module("bulbsCmsApp").controller("ChangelogmodalCtrl",function($scope,$modalInstance,_,ContentFactory,article){$scope.article=article,$scope.users={},ContentFactory.all("log").getList({content:article.id}).then(function(data){$scope.changelog=data;var userIds=_.unique(_.pluck(data,"user")),resp=function(data){$scope.users[data.id]=data};for(var i in userIds)ContentFactory.one("author",userIds[i]).get().then(resp)})}),angular.module("bulbsCmsApp").controller("CmsNotificationCtrl",function($scope,moment){var valid=function(){$scope.postDateValid=$scope.postDate&&(!$scope.notifyEndDate||$scope.postDate<$scope.notifyEndDate),$scope.notifyEndDateValid=$scope.notifyEndDate&&$scope.postDate&&$scope.notifyEndDate>$scope.postDate,$scope.titleValid=$scope.cmsNotification.title&&$scope.cmsNotification.title.length>0&&$scope.cmsNotification.title.length<=110,$scope.cmsNotificationValid=$scope.postDateValid&&$scope.notifyEndDateValid&&$scope.titleValid};$scope.postDate=$scope.cmsNotification.post_date?moment($scope.cmsNotification.post_date):null,$scope.$watch("postDate",function(){$scope.postDate?($scope.cmsNotification.post_date=$scope.postDate.format(),$scope.notifyEndDate=$scope.postDate.clone().add({days:3})):$scope.cmsNotification.post_date=null}),$scope.notifyEndDate=$scope.cmsNotification.notify_end_date?moment($scope.cmsNotification.notify_end_date):null,$scope.$watch("notifyEndDate",function(){$scope.notifyEndDate?$scope.cmsNotification.notify_end_date=$scope.notifyEndDate.format():$scope.cmsNotification.notify_end_date=null}),$scope.cmsNotificationDirty=!1,$scope.$watch("cmsNotification",function(newValue,oldValue){angular.equals(newValue,oldValue)||($scope.cmsNotificationDirty=!0,valid())},!0),valid(),$scope.saveCmsNotification=function(){$scope.$parent.userIsSuperuser&&$scope.cmsNotificationDirty&&$scope.cmsNotificationValid&&$scope.$parent.$saveCmsNotification($scope.cmsNotification).then(function(newCmsNotification){$scope.cmsNotification=newCmsNotification,$scope.cmsNotificationDirty=!1})["catch"](function(error){console.log("CMS Alert save failed",error)})},$scope.deleteCmsNotification=function(){$scope.$parent.userIsSuperuser&&$scope.$parent.$deleteCmsNotification($scope.cmsNotification)["catch"](function(error){console.log("CMS Alert delete failed",error)})}}),angular.module("bulbsCmsApp").controller("CmsNotificationsCtrl",function($q,$window,$scope,CmsConfig,CmsNotificationsApi,CurrentUserApi,_,moment){$window.document.title=CmsConfig.getCmsName()+" | CMS Alerts",CurrentUserApi.getCurrentUserWithCache().then(function(user){user.is_superuser&&($scope.userIsSuperuser=!0),CmsNotificationsApi.getList().then(function(cmsNotifications){var removeIndicies=[];_.each(cmsNotifications,function(cmsNotification,i){!user.is_superuser&&moment(cmsNotification.post_date).isAfter(moment())&&removeIndicies.push(i)}),_.each(removeIndicies,function(i){cmsNotifications.splice(i,1)}),$scope.cmsNotifications=cmsNotifications})}),$scope.newCmsNotification=function(){var cmsNotification={post_date:null,notify_end_date:null};return $scope.cmsNotifications.unshift(cmsNotification),cmsNotification},$scope.$saveCmsNotification=function(cmsNotification){var saveDefer=$q.defer(),savePromise=saveDefer.promise;return $scope.userIsSuperuser?"id"in cmsNotification?cmsNotification.put().then(function(updatedCmsNotification){saveDefer.resolve(updatedCmsNotification)}):$scope.cmsNotifications.post(cmsNotification).then(function(newCmsNotification){var i=$scope.cmsNotifications.indexOf(cmsNotification);$scope.cmsNotifications[i]=newCmsNotification,saveDefer.resolve(newCmsNotification)})["catch"](function(error){saveDefer.reject(error)}):saveDefer.reject("Insufficient permissions."),savePromise},$scope.$deleteCmsNotification=function(cmsNotification){var deleteDefer=$q.defer(),deletePromise=deleteDefer.promise,removeFromList=function(index){$scope.cmsNotifications.splice(index,1),deleteDefer.resolve()};if($scope.userIsSuperuser){var i=$scope.cmsNotifications.indexOf(cmsNotification);i>-1?_.isFunction(cmsNotification.remove)?cmsNotification.remove().then(function(){removeFromList(i)})["catch"](function(error){deleteDefer.reject(error)}):removeFromList(i):deleteDefer.reject("Cannot find notification in notification list. Unable to delete.")}else deleteDefer.reject("You do not have sufficient permissions to delete a notification.");return deletePromise}}),angular.module("bulbsCmsApp").controller("CmsNotifyContainerCtrl",function($scope,ipCookie,moment,CmsNotificationsApi,URLify,_){var genCookieKey=function(id){return"dismissed-cms-notification-"+id},updateCmsNotificationsDisplay=function(cmsNotifications){var now=moment();$scope.cmsNotifications=_.filter(cmsNotifications,function(cmsNotification){return!ipCookie(genCookieKey(cmsNotification.id))&&moment(cmsNotification.post_date).isBefore(now)&&moment(cmsNotification.notify_end_date).isAfter(now)?!0:void 0})};CmsNotificationsApi.getList().then(function(cmsNotifications){updateCmsNotificationsDisplay(cmsNotifications)}),$scope.dismissCmsNotification=function(cmsNotification){var cookieKey=URLify(genCookieKey(cmsNotification.id));ipCookie(cookieKey,!0,{expires:moment(cmsNotification.notify_end_date).add({days:1}).diff(moment(),"days"),path:"/cms/app"}),updateCmsNotificationsDisplay($scope.cmsNotifications)}}),angular.module("bulbsCmsApp").controller("ContenteditCtrl",function($scope,$routeParams,$http,$window,$location,$timeout,$interval,$compile,$q,$modal,$,_,CmsConfig,moment,keypress,Raven,PNotify,IfExistsElse,VersionStorageApi,ContentFactory,FirebaseApi,FirebaseArticleFactory,Login,VersionBrowserModalOpener){var listener=new keypress.Listener;listener.simple_combo("cmd s",function(e){$scope.saveArticle()}),listener.simple_combo("ctrl s",function(e){$scope.saveArticle()});var saveHTML="<i class='glyphicon glyphicon-floppy-disk'></i> Save",navbarSave=".navbar-save",getArticleCallback=function(data){$window.article=$scope.article=data,$scope.last_saved_article=angular.copy(data),FirebaseApi.$connection.onConnect(function(){$scope.firebaseConnected=!0}).onDisconnect(function(){$scope.firebaseConnected=!1}),FirebaseArticleFactory.$retrieveCurrentArticle().then(function($article){var currentUser,savePNotify,$activeUsers=$article.$activeUsers(),$versions=$article.$versions();return $versions.$loaded(function(){$versions.$watch(function(e){if("child_added"===e.event){var newVersion=_.sortBy($versions,function(version){return-version.timestamp})[0];if(currentUser&&newVersion.user.id!==currentUser.id){savePNotify&&savePNotify.remove();var msg="<b>"+newVersion.user.displayName+"</b> -- "+moment(newVersion.timestamp).format("MMM Do YYYY, h:mma")+"<br>";$scope.articleIsDirty&&(msg+=" You have unsaved changes that may conflict when you save."),msg+=" Open the version browser to see their latest version.",savePNotify=new PNotify({title:"Another User Saved!",text:msg,type:"error",mouse_reset:!1,hide:!1,confirm:{confirm:!0,buttons:[{text:"Open Version Browser",addClass:"btn-primary",click:function(notice){notice.mouse_reset=!1,notice.remove(),VersionBrowserModalOpener.open($scope,$scope.article)}},{addClass:"hide"}]},buttons:{closer_hover:!1,sticker:!1}})}}})}),$activeUsers.$watch(function(){$scope.activeUsers=_.chain($activeUsers).groupBy(function(user){return user.id}).map(function(group){var groupedUser=group[0];return groupedUser.count=group.length,currentUser&&groupedUser.id===currentUser.id&&(groupedUser.displayName="You"),groupedUser}).sortBy(function(user){return"You"===user.displayName?"":user.displayName}).value()}),$article.$registerCurrentUserActive().then(function(user){currentUser=user}),$article})},getContent=function(){return ContentFactory.one("content",$routeParams.id).get().then(getArticleCallback)},saveArticleErrorCbk=function(data){$(navbarSave).removeClass("btn-success").addClass("btn-danger").html("<i class='glyphicon glyphicon-remove'></i> Error"),400===status&&($scope.errors=data),$scope.saveArticleDeferred.reject()},saveArticleSuccessCbk=function(resp){VersionStorageApi.$create($scope.article,$scope.articleIsDirty),$(navbarSave).html("<i class='glyphicon glyphicon-ok'></i> Saved!"),setTimeout(function(){$(navbarSave).html(saveHTML)},2500),$window.article=$scope.article=resp,$scope.last_saved_article=angular.copy(resp),$scope.articleIsDirty=!1,$scope.articleIsNew=!1,$scope.errors=null,"new"===$routeParams.id&&$location.path("/cms/app/edit/"+$scope.article.id+"/"+$routeParams.contentType),$location.search("rating_type",null),$scope.saveArticleDeferred.resolve(resp)};$scope.PARTIALS_URL="/views/",$scope.buildContentPartialsPath=CmsConfig.buildContentPartialsPath,$scope.page="edit",$scope.contentEditGlobals={canSave:!0},$scope.$watch("article.title",function(){$window.document.title=CmsConfig.getCmsName()+" | Editing "+($scope.article&&$("<span>"+$scope.article.title+"</span>").text())}),$scope.saveArticleDeferred=$q.defer(),$scope.saveArticleIfDirty=function(){return $scope.articleIsDirty?$scope.saveArticle():$q.when($scope.article)},$scope.saveArticle=function(){return $scope.contentEditGlobals.saveError?$scope.saveArticleDeferred.reject():($(navbarSave).removeClass("btn-danger").addClass("btn-success").html("<i class='glyphicon glyphicon-refresh fa-spin'></i> Saving"),"new"===$routeParams.id?$scope.postValidationSaveArticle():ContentFactory.one("content",$routeParams.id).get().then(function(data){data.last_modified&&$scope.article.last_modified&&moment(data.last_modified)>moment($scope.article.last_modified)?($scope.saveArticleDeferred.reject(),$modal.open({templateUrl:"/views/modals/last-modified-guard-modal.html",controller:"LastmodifiedguardmodalCtrl",scope:$scope,resolve:{articleOnPage:function(){return $scope.article},articleOnServer:function(){return data}}})):$scope.postValidationSaveArticle()})["catch"](saveArticleErrorCbk),$scope.saveArticleDeferred.promise)},$scope.postValidationSaveArticle=function(){"Published"!==$scope.article.status&&$scope.article.polymorphic_ctype!==CmsConfig.getSuperFeaturesType()&&($scope.article.slug=$window.URLify($scope.article.title,50));var params={};return"new"===$routeParams.id&&(params.doctype=$scope.article.polymorphic_ctype),$scope.article.save(params).then(saveArticleSuccessCbk)["catch"](saveArticleErrorCbk),$scope.saveArticleDeferred.promise},$scope.articleIsDirty="new"===$routeParams.id,$scope.$watch(function(){return!angular.equals($scope.article,$scope.last_saved_article)},function(isDirty){$scope.articleIsDirty=isDirty}),$scope.$watch("articleIsDirty",function(){$scope.articleIsDirty?$window.onbeforeunload=function(){return"You have unsaved changes. Do you want to continue?"}:$window.onbeforeunload=function(){}}),$scope.publishSuccessCbk=function(){return getContent()},$scope.trashSuccessCbk=function(){$timeout(function(){$window.history.back()},1500)};var initialize=function(){"new"===$routeParams.id?($scope.articleIsNew=!0,$scope.article=ContentFactory.oneUrl("content"),$scope.article.polymorphic_ctype=$routeParams.contentType):getContent()};initialize()}),angular.module("bulbsCmsApp").controller("ContentlistCtrl",function($scope,$http,$timeout,$location,$window,$q,$,CmsConfig,ContentListService){$scope.contentData=[],ContentListService.$updateContent({page:1,exclude:CmsConfig.getSuperFeaturesType()}).then(function(data){$scope.contentData=data}),$window.document.title=CmsConfig.getCmsName()+" | Content",$scope.pageNumber=$location.search().page||"1",$scope.myStuff=!1,$scope.search=$location.search().search,$scope.collapse={},$scope.goToPage=function(){ContentListService.$updateContent({page:$scope.pageNumber},!0)},$scope.publishSuccessCbk=function(data){var i;for(i=0;i<$scope.contentData.content.length&&$scope.contentData.content[i].id!==data.article.id;i++);for(var field in data.response)$scope.contentData.content[i][field]=data.response[field];return $q.when()},$scope.trashSuccessCbk=function(){$timeout(function(){ContentListService.$updateContent(),$("#confirm-trash-modal").modal("hide")},1500)},$("body").on("shown.bs.collapse",".panel-collapse",function(e){$scope.$digest()})}).directive("ngConfirmClick",[function(){return{link:function(scope,element,attr){var msg=attr.ngConfirmClick||"Are you sure?",clickAction=attr.confirmedClick;element.bind("click",function(){window.confirm(msg)&&scope.$eval(clickAction)})}}}]),angular.module("bulbsCmsApp").controller("ContentworkflowCtrl",function($scope,$http,$modal,$window,moment,VersionBrowserModalOpener,TemporaryUrlModalOpener,CmsConfig){$scope.TIMEZONE_LABEL=moment.tz(CmsConfig.getTimezoneName()).format("z"),$scope.trashContentModal=function(articleId){return $modal.open({templateUrl:"/views/modals/confirm-trash-modal.html",controller:"TrashcontentmodalCtrl",scope:$scope,resolve:{articleId:function(){return articleId}}})},$scope.pubTimeModal=function(article){return $modal.open({templateUrl:"/views/modals/publish-date-modal.html",controller:"PubtimemodalCtrl",scope:$scope,resolve:{article:function(){return article}}})},$scope.sendToEditorModal=function(article){
return $modal.open({templateUrl:"/views/modals/send-to-editor-modal.html",controller:"SendtoeditormodalCtrl",scope:$scope,resolve:{article:function(){return article}}})},$scope.changelogModal=function(article){return $modal.open({templateUrl:"/views/modals/changelog-modal.html",controller:"ChangelogmodalCtrl",scope:$scope,resolve:{article:function(){return article}}})},$scope.thumbnailModal=function(article){return $modal.open({templateUrl:"/views/modals/thumbnail-modal.html",controller:"ThumbnailModalCtrl",scope:$scope,resolve:{article:function(){return article}}})},$scope.versionBrowserModal=function(article){VersionBrowserModalOpener.open($scope,article)},$scope.temporaryUrlModal=function(article){TemporaryUrlModalOpener.open($scope,article)},$scope.descriptionModal=function(article){return $modal.open({templateUrl:"/views/modals/description-modal.html",controller:"DescriptionModalCtrl",scope:$scope,size:"lg",resolve:{article:function(){return article}}})},$scope.getStatus=function(article){return article&&article.published?moment(article.published)>moment()?"scheduled":"published":"unpublished"}}),angular.module("bulbsCmsApp").controller("ContributionsCtrl",function($scope,$routeParams,$http,$window,$location,$timeout,$compile,$q,$modal,_,CmsConfig,ContributionRoleService,ContentService){function save(){angular.element("#save-btn").html('<i class="glyphicon glyphicon-refresh fa-spin"></i> Saving'),$scope.contributions.save($scope.contributions).then(function(contributions){angular.element("#save-btn").addClass("btn-success").removeClass("btn-danger"),angular.element("#save-btn").html('<i class="glyphicon glyphicon-floppy-disk"></i> Save</button>'),$scope.clean=!0},function(res){angular.element("#save-btn").addClass("btn-danger").removeClass("btn-success"),angular.element("#save-btn").html('<i class="glyphicon glyphicon-remove"></i> Error</button>')})}function add(){$scope.contributions.push({contributor:null,content:$scope.contentId,rate:{rate:0},role:null}),$scope.collapsed.push(!1)}function getRoles(){return ContributionRoleService.getList().then(function(roles){$scope.roles=roles,getContributions()})}function getContributions(){return ContentService.one($scope.contentId).all("contributions").getList().then(function(contributions){for(var i in contributions)null!==contributions[i]&&void 0!==contributions[i].role&&(contributions[i].hasOwnProperty("rate")&&"object"==typeof contributions[i].rate&&null!==contributions[i].rate&&(contributions[i].rate=contributions[i].rate.rate),"object"==typeof contributions[i].role&&(contributions[i].paymentType=contributions[i].role.payment_type,contributions[i].roleObject=contributions[i].role,contributions[i].role=contributions[i].role.id));$scope.contributions=contributions,$scope.collapsed=new Array(contributions.length),$scope.contributions.forEach(function(item,index){$scope.contributionLabels[index]=_.find($scope.roles,function(role){return role.id===item.role}).name,$scope.collapsed[index]=!0})})}function getContent(){ContentService.one($scope.contentId).get().then(function(content){$scope.content=content,$scope.article={id:content.id}})}function remove(index){$scope.contributions.splice(index,1),$scope.collapsed.splice(index,1)}function updateLabel(index){$scope.contributionLabels[index]=_.find($scope.roles,function(role){return $scope.contributions[index].roleObject=role,$scope.contributions[index].paymentType=role.payment_type,role.id===$scope.contributions[index].role}).name}$scope.NAV_LOGO=CmsConfig.getNavLogoPath(),$scope.contentId=parseInt($routeParams.id,10),$scope.paymentType="",$scope.contributions=[],$scope.contributionLabels=[],$scope.roles=[],$scope.collapsed=[],$scope.page="contributions",$scope.clean=!0,$scope.save=save,$scope.add=add,$scope.remove=remove,$scope.updateLabel=updateLabel,$scope.isFlatRate=function(contribution){return contribution.hasOwnProperty("roleObject")&&"Flat Rate"===contribution.roleObject.payment_type?!0:!1},$scope.isFeatureType=function(contribution){return contribution.hasOwnProperty("roleObject")&&"FeatureType"===contribution.roleObject.payment_type?($scope.setFeatureRate(contribution),!0):!1},$scope.setFeatureRate=function(contribution){for(var i in contribution.roleObject.rates.feature_type){var featureTypeRate=contribution.roleObject.rates.feature_type[i];$scope.content.feature_type===featureTypeRate.feature_type&&(contribution.featureTypeRate=featureTypeRate.rate)}},$scope.isHourly=function(contribution){return contribution.hasOwnProperty("roleObject")&&"Hourly"===contribution.roleObject.payment_type?!0:!1},$scope.isManual=function(contribution){return contribution.hasOwnProperty("roleObject")&&"Manual"===contribution.roleObject.payment_type?!0:!1},$scope.getHourlyPay=function(contribution){return contribution.roleObject?contribution.roleObject.rate?contribution.roleObject.rate/60*(contribution.minutes_worked||0):0:void 0},$scope.$watch("contributions",function(newContributions,oldContributions){oldContributions.length>0&&($scope.clean=!1)},!0),getRoles(),getContent()}),angular.module("bulbsCmsApp").controller("DescriptionModalCtrl",function($scope,$modalInstance,article){$scope.article=article}),angular.module("bulbsCmsApp").controller("ForbiddenmodalCtrl",function($scope,detail){$scope.detail=detail}),angular.module("bulbsCmsApp").controller("LastmodifiedguardmodalCtrl",function($scope,$modalInstance,_,moment,ContentFactory,articleOnPage,articleOnServer){$scope.articleOnServer=articleOnServer,ContentFactory.all("log").getList({content:articleOnPage.id}).then(function(log){var latest=_.max(log,function(entry){return moment(entry.action_time)}),lastSavedById=latest.user;ContentFactory.one("author",lastSavedById).get().then(function(data){$scope.lastSavedBy=data})}),$scope.loadFromServer=function(){_.each($scope.articleOnServer,function(value,key){$scope.article[key]=value}),$scope.articleIsDirty=!0,$modalInstance.close()},$scope.saveAnyway=function(){$modalInstance.close(),$scope.$parent.postValidationSaveArticle()}}),angular.module("bulbsCmsApp").controller("LineitemexportmodalCtrl",function($scope,$http,CmsConfig,moment){var now=moment().tz(CmsConfig.getTimezoneName());$scope.start=moment([now.year(),now.month()]),$scope.end=moment([now.year(),now.month()+1]),$scope.apiUrl="/cms/api/v1/contributions/line-item-reporting/?format=csv",$scope.updateDownloadUrl=function(){var start_string=$scope.start.format("YYYY-MM-DD"),end_string=$scope.end.format("YYYY-MM-DD");return $scope.apiUrl+"&start="+start_string+"&end="+end_string},$scope.downloadUrl=$scope.updateDownloadUrl(),$scope.$watchCollection("[start, end]",function(){$scope.downloadUrl=$scope.updateDownloadUrl()})}),angular.module("bulbsCmsApp").controller("LoginmodalCtrl",function($scope,Login,$modalInstance,$){$scope.login=function(){var username=$("input[name='username']").val(),password=$("input[name='password']").val();Login.login(username,password).then(function(){$modalInstance.close()},function(){$modalInstance.dismiss()})}}),angular.module("bulbsCmsApp").controller("PubtimemodalCtrl",function($scope,$http,$modal,$modalInstance,$,CmsConfig,moment,Login,article,Raven){$scope.article=article,$scope.pubButton={idle:"Publish",busy:"Publishing",finished:"Published!",error:"Error!"},$scope.$watch("pickerValue",function(newVal){var pubTimeMoment=moment(newVal);$scope.datePickerValue=moment().year(pubTimeMoment.year()).month(pubTimeMoment.month()).date(pubTimeMoment.date()),$scope.timePickerValue=moment().hour(pubTimeMoment.hour()).minute(pubTimeMoment.minute())});var modelDateFormat="YYYY-MM-DDTHH:mmZ";$scope.setTimeShortcut=function(shortcut){if("now"===shortcut){var now=moment();$scope.pickerValue=now}if("midnight"===shortcut){var midnight=moment().hour(24).minute(0);$scope.pickerValue=midnight}},$scope.setDateShortcut=function(shortcut){var today=moment.tz(CmsConfig.getTimezoneName());"today"===shortcut&&($scope.datePickerValue=moment().year(today.year()).month(today.month()).date(today.date())),"tomorrow"===shortcut&&($scope.datePickerValue=moment().year(today.year()).month(today.month()).date(today.date()+1))},$scope.setPubTime=function(){if(!$scope.article.feature_type)return $modalInstance.dismiss(),void $modal.open({templateUrl:"/views/modals/pubtime-validation-modal.html"});var newDate=moment($scope.datePickerValue),newTime=moment($scope.timePickerValue),newDateTime=moment.tz(CmsConfig.getTimezoneName()).year(newDate.year()).month(newDate.month()).date(newDate.date()).hour(newTime.hour()).minute(newTime.minute()).format(modelDateFormat),data={published:newDateTime};return $http({url:"/cms/api/v1/content/"+$scope.article.id+"/publish/",method:"POST",data:data})},$scope.setPubTimeCbk=function(publish_promise){publish_promise.then(function(result){$scope.article.published=result.data.published,$scope.publishSuccessCbk&&$scope.publishSuccessCbk({article:$scope.article,response:result.data}),$modalInstance.close()})["catch"](function(reason){Raven.captureMessage("Error Setting Pubtime",{extra:reason.data}),$modalInstance.dismiss()})},$scope.unpubButton={idle:"Unpublish",busy:"Unpublishing",finished:"Unpublished!",error:"Error"},$scope.unpublish=function(){return $http({url:"/cms/api/v1/content/"+$scope.article.id+"/publish/",method:"POST",data:{published:!1}})},$scope.unpublishCbk=function(unpub_promise){unpub_promise.then(function(result){$scope.publishSuccessCbk&&$scope.publishSuccessCbk({article:$scope.article,response:result.data}),$modalInstance.close()})["catch"](function(reason){$scope.publishSuccessCbk&&$scope.publishSuccessCbk({article:$scope.article,response:reason.data}),$modalInstance.dismiss()})},$scope.article.published?$scope.pickerValue=moment.tz($scope.article.published,CmsConfig.getTimezoneName()):$scope.setTimeShortcut("now")}),angular.module("bulbsCmsApp").controller("ReportemailmodalCtrl",function($scope,$http,moment){var reportEmailURL="/cms/api/v1/contributor-email/",now=moment().tz("America/Chicago");$scope.monthOptions=moment.monthsShort(),$scope.reportDeadline=now.add(1,"days"),$scope.reportMonth=$scope.monthOptions[now.month()-1],$scope.reportYear=now.year(),$scope.openReportDeadline=function($event){$event.preventDefault(),$event.stopPropagation(),$scope.startReportDeadline=!0};var getReportStart=function(){return moment().month($scope.reportMonth).year($scope.reportYear).startOf("month")};$scope.sendEmail=function(){var data={deadline:$scope.reportDeadline,start:getReportStart()};$http.post(reportEmailURL,data)}}),angular.module("bulbsCmsApp").controller("ReportingCtrl",function($http,$scope,$modal,$window,$,$location,$filter,$interpolate,Login,moment,CmsConfig,ContributionReportingService,ContentReportingService,FreelancePayReportingService){function loadReport(report,start,end,order,apiUrl){if($scope.items=[],"undefined"==typeof apiUrl?$scope.apiURL=report.downloadURL:$scope.apiURL=apiUrl,$scope.apiURL+="?page="+$scope.reportParams.pageNumber,$scope.downloadURL=report.downloadURL+"?format=csv",end){var endParam=$filter("date")(end,"yyyy-MM-dd");$scope.reportParams.end=endParam,$scope.apiURL+="&end="+endParam,$scope.downloadURL+="&end="+endParam}if(start){var startParam=$filter("date")(start,"yyyy-MM-dd");$scope.reportParams.start=startParam,$scope.apiURL+="&start="+startParam,$scope.downloadURL+="&start="+startParam}if(order&&($scope.apiURL+="&ordering="+order.key),$scope.publishedFilter&&($scope.apiURL+="&published="+$scope.publishedFilter,$scope.downloadURL+="&published="+$scope.publishedFilter,$scope.reportParams.published=$scope.publishedFilter),$scope.userFilter&&($scope.apiURL+="&staff="+$scope.userFilter,$scope.downloadURL+="&staff="+$scope.userFilter,$scope.reportParams.staff=$scope.userFilter),$scope.moreFilters)for(var key in $scope.moreFilters)"authors"===$scope.moreFilters[key].type?($scope.apiURL+="&contributors="+$scope.moreFilters[key].query,$scope.downloadURL+="&contributors="+$scope.moreFilters[key].query,$scope.reportParams.contributors=$scope.moreFilters[key].query):($scope.apiURL+="&"+$scope.moreFilters[key].type+"="+$scope.moreFilters[key].query,$scope.downloadURL+="&"+$scope.moreFilters[key].type+"="+$scope.moreFilters[key].query,$scope.reportParams[$scope.moreFilters[key].type]=$scope.moreFilters[key].query);$http({method:"GET",url:$scope.apiURL}).then(function(data){$scope.items=[],$scope.pageTotal=data.data.count,data.data.results.forEach(function(lineItem){var item=[];report.headings.forEach(function(heading){var exp=$interpolate("{{item."+heading.expression+"}}"),value=exp({item:lineItem});item.push(value)}),$scope.items.push(item)})})}$window.document.title=CmsConfig.getCmsName()+" | Reporting",$scope.userFilter="",$scope.userFilters=[{name:"All",value:""},{name:"Staff",value:"staff"},{name:"Freelance",value:"freelance"}],$scope.publishedFilter="",$scope.publishedFilters=[{name:"All Content",value:""},{name:"Published",value:"published"}],$scope.reports={Contributions:{service:ContributionReportingService,headings:[{title:"Content ID",expression:"content.id"},{title:"Headline",expression:"content.title"},{title:"FeatureType",expression:"content.feature_type"},{title:"Contributor",expression:"user.payroll_name"},{title:"Role",expression:"role"},{title:"Pay",expression:"pay"},{title:"Date",expression:"content.published | date: 'MM/dd/yyyy'"}],downloadURL:"/cms/api/v1/contributions/reporting/",orderOptions:[{label:"Order by User",key:"user"},{label:"Order by Content",key:"content"}]},Content:{service:ContentReportingService,headings:[{title:"Content ID",expression:"id"},{title:"Headline",expression:"title"},{title:"Feature Type",expression:"feature_type"},{title:"Video",expression:"video_id"},{title:"Article Cost",expression:"value"},{title:"Date Published",expression:"published | date: 'MM/dd/yyyy'"}],orderOptions:[],downloadURL:"/cms/api/v1/contributions/contentreporting/"},"Freelance Pay":{service:FreelancePayReportingService,headings:[{title:"Contributor",expression:"contributor.full_name"},{title:"Contribution #",expression:"contributions_count"},{title:"Pay",expression:"pay"},{title:"Payment Date",expression:"payment_date | date: 'MM/dd/yyyy'"}],orderOptions:[],downloadURL:"/cms/api/v1/contributions/freelancereporting/"}},$scope.items=[],$scope.headings=[],$scope.orderOptions=[],$scope.startInitial=moment().startOf("month").format("YYYY-MM-DD"),$scope.endInitial=moment().endOf("month").format("YYYY-MM-DD"),$scope.reportParams={pageNumber:1,start:$scope.startInitial,end:$scope.endInitial},$scope.reportDisabled=!0,$scope.pageTotal=null,$scope.moreFilters=[],$scope.startOpen=!1,$scope.endOpen=!1,$scope.setReport=function($reportingService){$scope.reportDisabled===!0&&($scope.reportDisabled=!1),$scope.reportParams.pageNumber=1,$scope.report=$reportingService},$scope.setUserFilter=function(value){$scope.userFilter=value,loadReport($scope.report,$scope.reportParams.start,$scope.reportParams.end,$scope.orderBy)},$scope.setPublishedFilter=function(value){$scope.publishedFilter=value,"published"===value&&($scope.reportParams.end=moment().format("YYYY-MM-DD")),loadReport($scope.report,$scope.reportParams.start,$scope.reportParams.end,$scope.orderBy)},$scope.openStart=function($event){$event.preventDefault(),$event.stopPropagation(),$scope.startOpen=!0},$scope.openEnd=function($event){$event.preventDefault(),$event.stopPropagation(),$scope.endOpen=!0},$scope.orderingChange=function(){loadReport($scope.report,$scope.reportParams.start,$scope.reportParams.end,$scope.orderBy)},$scope.downloadIsValid=function(){return"undefined"!==$scope.report?!0:!1},$scope.$watch("report",function(report){report&&($scope.orderOptions=report.orderOptions,report.orderOptions.length>0?$scope.orderBy=report.orderOptions[0]:$scope.orderBy=null,$scope.headings=[],report.headings.forEach(function(heading){$scope.headings.push(heading.title)}),loadReport(report,$scope.reportParams.start,$scope.reportParams.end,$scope.orderBy))}),$scope.$watchCollection("[reportParams.start, reportParams.end]",function(params){if($scope.report){var start=params[0],end=params[1];loadReport($scope.report,start,end,$scope.orderBy)}}),$scope.reportEmailModal=function(){return $modal.open({templateUrl:"/views/modals/report-email-modal.html",controller:"ReportemailmodalCtrl"})},$scope.goToPage=function(){loadReport($scope.report,$scope.reportParams.start,$scope.reportParams.end)}}),angular.module("bulbsCmsApp").controller("TargetingCtrl",function($scope,$http,$window,$q,$location,CmsConfig){$window.document.title=CmsConfig.getCmsName()+" | Targeting Editor";var canceller;$scope.search=function(url){url&&("undefined"==typeof canceller?canceller=$q.defer():(canceller.resolve(),canceller=$q.defer()),$http({method:"GET",url:"/ads/targeting",timeout:canceller.promise,params:{url:$scope.url}}).success(function(data){$scope.targetingArray=[];for(var k in data)$scope.targetingArray.push([k,data[k]])}).error(function(data,status,headers,config){404===status&&($scope.targetingArray=[],$scope.targetingArray.push(["",""]))}))},$scope.save=function(){var data={};for(var i in $scope.targetingArray)data[$scope.targetingArray[i][0]]=$scope.targetingArray[i][1];return $http({method:"POST",url:"/ads/targeting?url="+$scope.url,data:data}).success(function(data){$scope.targetingArray=[];for(var k in data)$scope.targetingArray.push([k,data[k]])})},$scope.keyHandler=function(event,url){13===event.keyCode?this.search(url):27===event.keyCode&&(event.currentTarget.value="")};var search=$location.search();search&&search.url&&($scope.url=decodeURIComponent(search.url))}),angular.module("bulbsCmsApp").value("ARTICLE_TEMPORARY_URL_DAYS_VALID",7).controller("TemporaryUrlModalCtrl",function($scope,$routeParams,CmsConfig,ContentFactory,ARTICLE_TEMPORARY_URL_DAYS_VALID,_,moment){var content=ContentFactory.one("content",$routeParams.id);$scope.TEMP_LINK_DAYS_VALID=ARTICLE_TEMPORARY_URL_DAYS_VALID,$scope.TEMP_URL_BASE=CmsConfig.buildUnpublishedUrl(),$scope.tokens=[],content.getList("list_tokens").then(function(tokenList){$scope.tokens=tokenList;var expiredIndicies=[];_.each($scope.tokens,function(token,i){token.create_date=moment(token.create_date),token.expire_date=moment(token.expire_date),moment().isAfter(token.expire_date)?expiredIndicies.push(i):token.daysTillExpire=token.expire_date.diff(moment(),"days")+1});for(var i=expiredIndicies.length-1;i>=0;i--)$scope.tokens.splice(expiredIndicies[i],1)}),$scope.createToken=function(){var now=moment();ContentFactory.one("content",$routeParams.id).post("create_token",{create_date:now,expire_date:now.clone().add({days:ARTICLE_TEMPORARY_URL_DAYS_VALID})}).then(function(token){token.create_date=moment(token.create_date),token.expire_date=moment(token.expire_date),token.daysTillExpire=token.expire_date.diff(moment(),"days")+1,$scope.tokens.push(token),$scope.newestToken=token})}}),angular.module("bulbsCmsApp").controller("ThumbnailModalCtrl",function($scope,BettyCropper,$modalInstance,article){$scope.article=article,$scope.selectCustomThumbnail=function(){BettyCropper.upload().then(function(success){$scope.article.thumbnail_override=success},function(error){console.log(error)},function(progress){console.log(progress)})}}),angular.module("bulbsCmsApp").controller("TrashcontentmodalCtrl",function($scope,$http,$modalInstance,$,Login,articleId,Raven){$scope.deleteButton={idle:"Delete",busy:"Trashing",finished:"Trashed",error:"Error!"},$scope.trashContent=function(){return $http({method:"POST",url:"/cms/api/v1/content/"+articleId+"/trash/"})},$scope.trashCbk=function(trash_promise){trash_promise.then(function(result){console.log("trash success"),$scope.trashSuccessCbk(),$modalInstance.close()})["catch"](function(reason){return 404===reason.status?($scope.trashSuccessCbk(),void $modalInstance.close()):(Raven.captureMessage("Error Deleting Article",{extra:reason}),void $modalInstance.dismiss())})}}),angular.module("bulbsCmsApp").controller("UnpublishCtrl",function($scope,$http,$q){$scope.unpubButton={idle:"Unpublish",busy:"Unpublishing",finished:"Unpublished!",error:"Error"},$scope.unpublish=function(){return $http({url:"/cms/api/v1/content/"+$scope.article.id+"/publish/",method:"POST",data:{published:!1}})},$scope.unpublishCbk=function(unpub_promise){unpub_promise.then(function(result){$scope.publishSuccessCbk&&$scope.publishSuccessCbk({article:$scope.article,response:result.data})})["catch"](function(reason){$scope.publishSuccessCbk&&$scope.publishSuccessCbk({article:$scope.article,response:reason.data})})}}),angular.module("bulbsCmsApp").controller("VersionBrowserModalCtrl",function($scope,$modalInstance,_,moment,VersionStorageApi,FirebaseApi,CmsConfig){FirebaseApi.$authorize().then(function(){$scope.maxVersions=CmsConfig.getFirebaseMaxArticleHistory()}),VersionStorageApi.$all().then(function(versions){$scope.versions=_.chain(versions).each(function(version){version.timestamp_display=moment(version.timestamp).format("MMM Do YYYY, h:mma")}).sortBy(function(version){return-version.timestamp}).value(),$scope.selectedVersion=$scope.versions[0],$scope.setPreview=function(version){$scope.selectedVersion=version},$scope.restoreSelected=function(){_.each($scope.selectedVersion.content,function(value,key){$scope.article[key]=value}),$scope.articleIsDirty=!0,$modalInstance.close()}})}),angular.module("bulbsCmsApp").controller("VideothumbnailmodalCtrl",function($scope,$http,$modalInstance,CmsConfig,Zencoder,videoId){function compilePosterUrl(thumbnail){return CmsConfig.buildVideoThumbnailUrl(videoId,"thumbnail_"+pad4(thumbnail)+".png")}function pad4(num){var s="0000"+num;return s.substr(s.length-4)}var DEFAULT_THUMBNAIL=4,MAX_THUMBNAIL=19;$scope.uploadedImage={id:null},$scope.mode="still",Zencoder.getVideo(videoId).then(function(response){$scope.video=response.data,"In Progress"===response.data.status?($scope.inProgress=!0,$scope.video.poster=$scope.video.poster||null):$scope.video.poster=$scope.video.poster||compilePosterUrl(DEFAULT_THUMBNAIL)}),$scope.$watch("video.poster",function(){if($scope.video&&$scope.video.poster){var defaultUrl=CmsConfig.buildVideoThumbnailUrl(videoId,"thumbnail_{{thumbnail}}.png"),thumbnailIndex=defaultUrl.indexOf("{{thumbnail}}");0===$scope.video.poster.indexOf(defaultUrl.substr(0,thumbnailIndex))?($scope.currentThumbnail=Number($scope.video.poster.substr(thumbnailIndex,4)),$scope.uploadedImage.id=null):$scope.currentThumbnail=!1}}),$scope.$watch("uploadedImage.id",function(){$scope.uploadedImage.id&&($scope.video.poster=CmsConfig.buildImageApiUrl("16x9",$scope.uploadedImage.id,"1200.jpg"))}),$scope.nextThumb=function(){$scope.video.poster=compilePosterUrl($scope.currentThumbnail<MAX_THUMBNAIL?$scope.currentThumbnail+1:0)},$scope.prevThumb=function(){$scope.video.poster=compilePosterUrl($scope.currentThumbnail>0?$scope.currentThumbnail-1:MAX_THUMBNAIL)},$scope.defaultThumb=function(){$scope.video.poster=compilePosterUrl(DEFAULT_THUMBNAIL)},$scope.setPoster=function(){Zencoder.setVideo($scope.video),$modalInstance.close($scope.video.poster)},$scope.reencode=function(){Zencoder.encode(videoId)}}),angular.module("bulbsCmsApp").factory("AdApi",function(Restangular,adApiConfig){return Restangular.withConfig(function(RestangularConfigurer){RestangularConfigurer.setBaseUrl(adApiConfig.baseUrl)})}).constant("adApiConfig",{baseUrl:"/ads"}),angular.module("bulbsCmsApp").factory("BadRequestInterceptor",function($q,$injector){return{responseError:function(rejection){return $injector.invoke(function($modal){if(400===rejection.status){var detail=rejection.data||{something:["Something was wrong with your request."]};$modal.open({templateUrl:"/views/modals/400-modal.html",controller:"BadrequestmodalCtrl",resolve:{detail:function(){return detail}}})}}),$q.reject(rejection)}}}),angular.module("bulbsCmsApp").factory("BugReportInterceptor",function($q,$window,PNotify){return{responseError:function(rejection){if(rejection.status>=500){var stack={animation:!0,dir1:"up",dir2:"left"};new PNotify({title:"You found a bug!",text:"Looks like something just went wrong, and we need your help to fix it! Report it, and we'll make sure it never happens again.",type:"error",confirm:{confirm:!0,align:"left",buttons:[{text:"Report Bug",addClass:"btn-danger pnotify-report-bug",click:function(notice){notice.remove(),$window.showBugReportModal()}},{addClass:"hidden"}]},buttons:{sticker:!1},icon:"fa fa-bug pnotify-error-icon",addclass:"stack-bottomright",stack:stack})}return $q.reject(rejection)}}}),angular.module("bulbsCmsApp").config(function(RestangularProvider,bulbsApiConfig){RestangularProvider.setResponseExtractor(function(response,operation,what,url){var newResponse=response;return"getList"===operation&&"undefined"!=typeof response.results&&(newResponse=response.results,newResponse.metadata={count:response.count,next:response.next,previous:response.previous}),newResponse}),bulbsApiConfig.requestSuffix&&RestangularProvider.setRequestSuffix(bulbsApiConfig.requestSuffix)}).constant("bulbsApiConfig",{requestSuffix:"/"}),angular.module("bulbsCmsApp").factory("CmsNotificationsApi",function($q,ContentFactory){return ContentFactory.service("cms_notifications")}),angular.module("bulbsCmsApp").factory("FirebaseApi",function(FirebaseRefFactory,$firebase,$rootScope,$q,CurrentUserApi,CmsConfig){var rootRef=FirebaseRefFactory.newRef(CmsConfig.buildFirebaseSiteUrl()),authDefer=$q.defer(),$authorize=authDefer.promise;$authorize["catch"](function(error){error&&console.error("Firebase login failed:",error)}),CurrentUserApi.getCurrentUserWithCache().then(function(user){"firebase_token"in user&&user.firebase_token?rootRef.auth(user.firebase_token,function(error){error?authDefer.reject(error):authDefer.resolve(rootRef)}):authDefer.reject()});var connectedRef=FirebaseRefFactory.newRef(CmsConfig.buildFirebaseUrl(".info/connected"));connectedRef.on("value",function(connected){connected.val()?$rootScope.$emit("firebase-reconnected"):$rootScope.$emit("firebase-disconnected"),$rootScope.$emit("firebase-connection-state-changed")});var $connection={onConnect:function(callback){return $rootScope.$on("firebase-reconnected",callback),$connection},onDisconnect:function(callback){return $rootScope.$on("firebase-disconnected",callback),$connection},onChange:function(callback){$rootScope.$on("firebase-connection-state-changed",callback)}};return{$authorize:function(){return $authorize},$connection:$connection}}),angular.module("bulbsCmsApp").factory("FirebaseArticleFactory",function($q,$firebase,$routeParams,_,moment,FirebaseApi,CurrentUserApi,CmsConfig){var createArticle=function(rootRef,articleId){var articleRef=rootRef.child("articles/"+articleId),$activeUsers=$firebase(articleRef.child("users")).$asArray(),$versions=$firebase(articleRef.child("versions")).$asArray(),addCurrentUserToActiveUsers=function(){var registeredDeferred=$q.defer(),registeredPromise=registeredDeferred.promise;return CurrentUserApi.getCurrentUserWithCache().then(function(user){var simplifiedUser=_.pick(user,["id","displayName"]);$activeUsers.$add(simplifiedUser).then(function(userRef){userRef.onDisconnect().remove(),registeredDeferred.resolve(simplifiedUser)})["catch"](function(error){registeredDeferred.reject(error)})})["catch"](function(error){registeredDeferred.reject(error)}),registeredPromise},registerCurrentUserActive=function(){return FirebaseApi.$connection.onConnect(addCurrentUserToActiveUsers),addCurrentUserToActiveUsers()};return{ref:articleRef,$activeUsers:function(){return $activeUsers},$versions:function(){return $versions},$registerCurrentUserActive:registerCurrentUserActive,$createVersion:function(articleData){var createDefer=$q.defer(),$createPromise=createDefer.promise;return CurrentUserApi.getCurrentUserWithCache().then(function(user){var simplifiedUser=_.pick(user,["id","displayName"]),numVersions=$versions.length;numVersions+1>CmsConfig.getFirebaseMaxArticleHistory()&&_.chain($versions).sortBy(function(version){return version.timestamp}).every(function(version){return $versions.$remove(version),numVersions--,numVersions+1>CmsConfig.getFirebaseMaxArticleHistory()});var versionData={timestamp:moment().valueOf(),user:simplifiedUser,content:articleData};$versions.$add(versionData).then(createDefer.resolve)["catch"](createDefer.reject)}),$createPromise}}};return{$retrieveArticle:function(articleId){var retrieveDeferred=$q.defer(),retrievePromise=retrieveDeferred.promise;return FirebaseApi.$authorize().then(function(rootRef){retrieveDeferred.resolve(createArticle(rootRef,articleId))})["catch"](function(error){retrieveDeferred.reject(error)}),retrievePromise},$retrieveCurrentArticle:function(){return this.$retrieveArticle($routeParams.id)}}}),angular.module("bulbsCmsApp").service("FirebaseRefFactory",function(Firebase){return{newRef:function(url){return new Firebase(url)}}}),angular.module("bulbsCmsApp").service("Gettemplate",function($templateCache,$q,$http){this.get=function(templateUrl){var template=$templateCache.get(templateUrl);if(template)return $q.when(template);var deferred=$q.defer();return $http.get(templateUrl,{cache:!0}).success(function(html){$templateCache.put(templateUrl,html),deferred.resolve(html)}),deferred.promise}}),angular.module("bulbsCmsApp").service("IfExistsElse",function($window,$http){this.ifExistsElse=function(restQ,propertiesToValues,existsCbk,elseCbk,errorCbk){restQ.then(function(data){for(var resList=data.results||data,j=0;j<resList.length;j++){var allFieldsMatch=!0,datum=resList[j];for(var property in propertiesToValues){if(!datum.hasOwnProperty(property)){allFieldsMatch=!1;break}if(datum[property]!==propertiesToValues[property]){allFieldsMatch=!1;break}}if(allFieldsMatch)return void existsCbk(datum)}elseCbk(propertiesToValues)})["catch"](errorCbk)}}),angular.module("bulbsCmsApp").factory("LocalStorageBackup",function($q,$routeParams,$window,moment,_,CurrentUserApi){var keyPrefixArticle="article",keyPrefix=keyPrefixArticle+"."+$routeParams.id+".";return{$create:function(articleData){var createDefer=$q.defer(),createPromise=createDefer.promise;return $window.localStorage?CurrentUserApi.getCurrentUserWithCache().then(function(user){var simplifiedUser=_.pick(user,["id","displayName"]),version={timestamp:moment().valueOf(),user:simplifiedUser,content:articleData};try{$window.localStorage.setItem(keyPrefix+moment().valueOf(),JSON.stringify(version)),createDefer.resolve(version)}catch(error){console.log("Caught localStorage error: "+error),console.log("Pruning old entries..."),_.chain($window.localStorage).pick(function(value,key){var keySplit=key.split("."),pickForRemoval=!1;if(3===keySplit.length&&keySplit[0]===keyPrefixArticle){var yesterday=moment().subtract({days:1}).valueOf(),keyTime=Number(keySplit[2]);pickForRemoval=yesterday>keyTime}return pickForRemoval}).each(function(value,key){$window.localStorage.removeItem(key)});try{$window.localStorage.setItem(version.timestamp,JSON.stringify(version.content)),createDefer.resolve(version)}catch(error){console.log("Maybe you've been saving too much? Failed again at adding entry, no more retries: "+error),createDefer.reject("Maybe you've been saving too much? Failed again at adding entry, no more retries: "+error)}}}):createDefer.reject("You don't have local storage capabilities in your browser. Use a better browser."),createPromise},$versions:function(){var retrieveDefer=$q.defer(),retrievePromise=retrieveDefer.promise,versions=_.chain($window.localStorage).pick(function(stored,key){var keySplit=key.split(".");return 3===keySplit.length&&keySplit[0]===keyPrefixArticle&&keySplit[1]===$routeParams.id}).map(function(stored){return JSON.parse(stored)}).value();return retrieveDefer.resolve(versions),retrievePromise}}}),angular.module("bulbsCmsApp").service("Login",function($rootScope,$http,$cookies,$window,$){return $rootScope.$watch(function(){return $cookies.csrftoken},function(newCsrf,oldCsrf){$http.defaults.headers.common["X-CSRFToken"]=newCsrf,$window.jqueryCsrfSetup&&$window.jqueryCsrfSetup()}),{login:function(username,password){var data=$.param({username:username,password:password});return $http({method:"POST",url:"/login/",
data:data,headers:{"Content-Type":"application/x-www-form-urlencoded"}})}}}),angular.module("bulbsCmsApp").factory("PermissionsInterceptor",function($q,$injector){return{responseError:function(rejection){return rejection.config&&rejection.config.noPermissionIntercept?$q.when(rejection):($injector.invoke(function($modal){if(403===rejection.status)if(rejection.data&&rejection.data.detail&&rejection.data.detail.indexOf("credentials")>0)$modal.open({templateUrl:"/views/modals/login-modal.html",controller:"LoginmodalCtrl"});else{var detail=rejection.data&&rejection.data.detail||"Forbidden";$modal.open({templateUrl:"/views/modals/403-modal.html",controller:"ForbiddenmodalCtrl",resolve:{detail:function(){return detail}}})}}),$q.reject(rejection))}}}),angular.module("bulbsCmsApp").factory("TemporaryUrlModalOpener",function($modal){var modal=null;return{open:function($scope,article){return modal&&modal.close(),modal=$modal.open({templateUrl:"/views/modals/temporary-url-modal.html",controller:"TemporaryUrlModalCtrl",scope:$scope,resolve:{article:function(){return article}}})}}}),angular.module("bulbsCmsApp").factory("VersionStorageApi",function($q,FirebaseApi,FirebaseArticleFactory,LocalStorageBackup,_){var firebaseAvailableDefer=$q.defer(),$firebaseAvailable=firebaseAvailableDefer.promise;FirebaseApi.$authorize().then(function(){firebaseAvailableDefer.resolve(FirebaseArticleFactory.$retrieveCurrentArticle())})["catch"](function(){firebaseAvailableDefer.reject()});var _omitter=_.memoize(function(value,key){return _.isFunction(value)||_.find(key,function(c){return"."===c||"#"===c||"$"===c||"/"===c||"["===c||"]"===c})},function(value,key){return[key,value]}),_deepScrub=function(obj){var clone,transValue;return _.isUndefined(obj)?clone=null:_.isPlainObject(obj)?(clone={},_.forOwn(obj,function(value,key){transValue=_deepScrub(value),_omitter(transValue,key)||(clone[key]=transValue)})):_.isArray(obj)?(clone=[],_.each(obj,function(value,key){transValue=_deepScrub(value),_omitter(transValue,key)||clone.push(transValue)})):clone=obj,clone},scrubArticle=function(articleData){return _deepScrub(articleData)};return{$create:function(rawArticleData,articleIsDirty){var articleData=scrubArticle(rawArticleData),createDefer=$q.defer(),createPromise=createDefer.promise;return $firebaseAvailable.then(function($currentArticle){articleIsDirty||$currentArticle.$versions().length<1?$currentArticle.$createVersion(articleData).then(function(versionData){createDefer.resolve(versionData)})["catch"](function(){createDefer.reject()}):createDefer.reject()})["catch"](function(){LocalStorageBackup.$versions().then(function(versions){articleIsDirty||versions.length<1?LocalStorageBackup.$create(articleData).then(function(versionData){createDefer.resolve(versionData)})["catch"](function(error){createDefer.reject(error)}):createDefer.reject()})}),createPromise},$all:function(){var allDefer=$q.defer(),allPromise=allDefer.promise;return $firebaseAvailable.then(function($currentArticle){$currentArticle.$versions().$loaded(function(versions){allDefer.resolve(versions)})})["catch"](function(){LocalStorageBackup.$versions().then(function(versions){allDefer.resolve(versions)})["catch"](function(error){allDefer.reject(error)})}),allPromise.then(function(versions){return _.sortBy(versions,function(version){return-version.timestamp})})}}}),angular.module("bulbsCmsApp").factory("VersionBrowserModalOpener",function($modal){var modal=null;return{open:function($scope,article){return modal&&modal.close(),modal=$modal.open({templateUrl:"/views/modals/version-browser-modal.html",controller:"VersionBrowserModalCtrl",scope:$scope,size:"lg",resolve:{article:function(){return article}}})}}}),angular.module("bulbsCmsApp").service("Zencoder",function($http,$q,$modal,$){function getNewVideoUploadCredentials(file){var data={name:file.name};data=$.param(data);var newVideoDeferred=$q.defer();return $http({method:"POST",url:newVideoUrl,data:data,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(data){newVideoDeferred.resolve({file:file,attrs:data})}).error(function(data){newVideoDeferred.reject(data)}),newVideoDeferred.promise}function uploadToS3(videoObject){var s3deferred=$q.defer(),formData=new FormData;return formData.append("key",videoObject.attrs.key),formData.append("AWSAccessKeyId",videoObject.attrs.AWSAccessKeyId),formData.append("acl",videoObject.attrs.acl),formData.append("success_action_status",videoObject.attrs.success_action_status),formData.append("policy",videoObject.attrs.policy),formData.append("signature",videoObject.attrs.signature),formData.append("file",videoObject.file),$.ajax(videoObject.attrs.upload_endpoint,{processData:!1,contentType:!1,data:formData,type:"POST",xhr:function(){var req=$.ajaxSettings.xhr();return req&&req.upload.addEventListener("progress",function(e){var percent=e.loaded/e.total*100;s3deferred.notify(percent)},!1),req},success:function(data){s3deferred.resolve(videoObject)},error:function(data){s3deferred.reject(data)}}),s3deferred.promise}function encode(videoObject){var encodeDeferred=$q.defer();return $http({method:"POST",url:"/video/"+videoObject.attrs.id+"/encode"}).success(function(data){videoObject.attrs.encode_status_endpoints=data,_encodingVideos[videoObject.attrs.id]=videoObject.attrs,encodeDeferred.resolve(videoObject)}).error(function(data){encodeDeferred.reject(data)}),encodeDeferred.promise}var newVideoUrl="/video/new",fileInputId="#bulbs-cms-hidden-video-file-input",inputTemplate='<input id="bulbs-cms-hidden-video-file-input" type="file" accept="video/*" style="position: absolute; left:-99999px;" name="video" />';this.onVideoFileUpload=function(){var clickDeferred=$q.defer();angular.element(fileInputId).remove();var file,fileInput=angular.element(inputTemplate);return angular.element("body").append(fileInput),fileInput.click(),fileInput.unbind("change"),fileInput.bind("change",function(elem){0!==this.files.length?(file=this.files[0],file.size>1073741824&&clickDeferred.reject("Upload file cannot be larger than 1024MB."),0!==file.type.indexOf("video/")&&clickDeferred.reject("You must upload a video file.")):clickDeferred.reject("Please select a file."),getNewVideoUploadCredentials(file).then(uploadToS3).then(encode,angular.noop,function(uploadPercentComplete){clickDeferred.notify(uploadPercentComplete)}).then(function(videoObject){clickDeferred.resolve(videoObject)},function(error){clickDeferred.reject(error)})}),clickDeferred.promise},this.encode=function(videoId){encode({attrs:{id:videoId}})},this.openVideoThumbnailModal=function(videoId){return $modal.open({templateUrl:"/views/modals/video-thumbnail-modal.html",controller:"VideothumbnailmodalCtrl",resolve:{videoId:function(){return videoId}}})},this.getVideo=function(videoId){var url="/video/"+videoId;return $http({method:"GET",url:url})},this.setVideo=function(video){var url="/video/"+video.id,data=$.param(video);return $http({method:"POST",url:url,data:data,headers:{"Content-Type":"application/x-www-form-urlencoded"}})};var _encodingVideos={};this.encodingVideos=_encodingVideos}),angular.module("bulbsCmsApp").filter("truncateByCharacters",function(){return function(input,chars,breakOnWord){if(isNaN(chars))return input;if(0>=chars)return"";if(input&&input.length>=chars){if(input=input.substring(0,chars),breakOnWord)for(;" "===input.charAt(input.length-1);)input=input.substr(0,input.length-1);else{var lastspace=input.lastIndexOf(" ");-1!==lastspace&&(input=input.substr(0,lastspace))}return 1===chars?input+".":input+"..."}return input}}),angular.module("bulbsCmsApp").filter("truncateByWords",function(){return function(input,words){if(isNaN(words))return input;if(0>=words)return"";if(input){var inputWords=input.split(/\s+/);inputWords.length>words&&(input=inputWords.slice(0,words).join(" ")+"...")}return input}}),angular.module("bulbsCmsApp").filter("tzDate",function(dateFilter,moment,CmsConfig){return function(input,format){if(!input)return"";var inDate=moment.tz(input,CmsConfig.getTimezoneName()),newdate=inDate.format("YYYY-MM-DDTHH:mm"),formattedDate=dateFilter(newdate,format);return format.toLowerCase().indexOf("h")>-1&&(formattedDate+=" "+inDate.format("z")),formattedDate}});
//# sourceMappingURL=scripts.min.js.1484599305253.map